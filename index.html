<!doctype html>
<html lang="ht">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TF-Sove — Live Chat</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{max-width:920px;margin:20px auto;padding:14px;color:#111}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0}
    .status{padding:6px 10px;border-radius:8px;font-weight:700}
    .ok{background:#e6ffed;color:#04662f}
    .err{background:#ffecec;color:#8b1a1a}
    .muted{color:#666;font-size:13px}
    #app{margin-top:12px}
    #composer{display:flex;gap:8px;margin-top:12px}
    input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:15px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:700}
    button.secondary{background:#6b7280}
    #messages{list-style:none;padding:0;margin-top:14px;max-height:60vh;overflow:auto}
    #messages li{padding:10px;border-radius:8px;border:1px solid #eee;margin-bottom:8px;background:#fff}
    .meta{font-size:12px;color:#666;margin-top:6px}
    .errorBox{background:#fff3f3;border:1px solid #ffd6d6;padding:12px;border-radius:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <h1>TF-Sove</h1>
    <div id="status" class="status muted">Starting…</div>
  </header>

  <p class="muted" id="note">
    This page requires `tfid` (17 digits) and `name` in the URL. Example:
    <code>?tfid=12345678912345678&amp;name=site1</code>.
  </p>

  <!-- IMPORTANT: configure API_BASE if different -->
  <script>
    const API_BASE = "https://tf-sove.onrender.com"; // backend
    const API_TOKEN = ""; // leave empty in public frontend (not secure to expose)
  </script>

  <!-- MAIN UI (no input prompts for tfid/name) -->
  <div id="errorArea" class="errorBox hidden"></div>

  <div id="app" class="hidden" aria-live="polite">
    <p><strong>tfid:</strong> <span id="tfidSpan"></span> &nbsp; <strong>name:</strong> <span id="nameSpan"></span></p>

    <div id="composer">
      <input id="content" type="text" placeholder="Ekri mesaj ou a, peze Enter oubyen Send" autocomplete="off" />
      <button id="sendBtn">Send</button>
      <button id="clearBtn" class="secondary">Clear</button>
    </div>

    <ul id="messages" role="log" aria-live="polite"></ul>
  </div>

<script>
(() => {
  const apiBase = (typeof API_BASE !== "undefined") ? API_BASE : "https://tf-sove.onrender.com";
  const apiToken = (typeof API_TOKEN !== "undefined" && API_TOKEN) ? API_TOKEN : null;

  // get tfid & name only from URL (query string or hash query)
  const urlP = new URL(location.href);
  let tfid = urlP.searchParams.get("tfid") || null;
  let name = urlP.searchParams.get("name") || null;
  if (!tfid || !name) {
    // fallback: check hash (e.g. #tfid=...&name=...)
    if (location.hash && location.hash.includes("=")) {
      const h = location.hash.replace(/^#/, "");
      const hp = new URLSearchParams(h);
      tfid = tfid || hp.get("tfid");
      name = name || hp.get("name");
    }
  }

  const statusEl = document.getElementById("status");
  const noteEl = document.getElementById("note");
  const appEl = document.getElementById("app");
  const errorArea = document.getElementById("errorArea");
  const tfidSpan = document.getElementById("tfidSpan");
  const nameSpan = document.getElementById("nameSpan");
  const contentInput = document.getElementById("content");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const messagesUl = document.getElementById("messages");

  function setStatus(ok, text) {
    statusEl.className = "status " + (ok ? "ok" : "err");
    statusEl.textContent = text;
  }

  function showError(msg) {
    errorArea.classList.remove("hidden");
    errorArea.textContent = msg;
    appEl.classList.add("hidden");
    setStatus(false, "Error");
  }

  function hideError() {
    errorArea.classList.add("hidden");
  }

  function isValidTfid(v) { return typeof v === "string" && /^\d{17}$/.test(v); }

  // If tfid or name missing/invalid — show error but DO NOT prompt for input.
  if (!isValidTfid(tfid) || !name) {
    showError("Missing or invalid parameters. This page does not ask for input. " +
              "Open it with query parameters: ?tfid=12345678901234567&name=site1");
    noteEl.classList.add("hidden");
    return;
  }

  // All good, hide note and init UI
  hideError();
  noteEl.classList.add("hidden");
  appEl.classList.remove("hidden");
  setStatus(true, "Connecting...");
  tfidSpan.textContent = tfid;
  nameSpan.textContent = name;

  // utility: escape
  function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  // append message (newest at bottom)
  function appendMessage(msg) {
    const li = document.createElement("li");
    const time = msg.created_at ? ` — ${esc(msg.created_at)}` : "";
    li.innerHTML = `<strong>#${esc(msg.id)}</strong> ${esc(msg.content)} <div class="meta">${esc(msg.tfid||"")}${time}</div>`;
    messagesUl.appendChild(li);
    // keep scroll to bottom
    messagesUl.scrollTop = messagesUl.scrollHeight;
  }

  // load existing messages once (to populate history)
  async function loadHistory() {
    try {
      const url = `${apiBase}/api/list?tfid=${encodeURIComponent(tfid)}&name=${encodeURIComponent(name)}`;
      const headers = apiToken ? {"x-api-token": apiToken} : {};
      const r = await fetch(url, { headers });
      if (!r.ok) {
        console.warn("history fetch status", r.status);
        setStatus(false, "History load failed");
        return;
      }
      const j = await r.json().catch(()=>null);
      const rows = (j && j.rows) ? j.rows.slice().reverse() : [];
      messagesUl.innerHTML = "";
      for (const row of rows) appendMessage(row);
    } catch (err) {
      console.error("loadHistory error", err);
      setStatus(false, "History load error");
    }
  }

  // SSE real-time connection with auto-reconnect logic handled by EventSource
  let es = null;
  function startSse() {
    const sseUrl = `${apiBase.replace(/^http:/,"https:")}/sse?tfid=${encodeURIComponent(tfid)}&name=${encodeURIComponent(name)}`;
    try {
      es = new EventSource(sseUrl);
    } catch(e) {
      console.error("EventSource init fail", e);
      setStatus(false, "SSE init failed");
      return;
    }
    es.onopen = () => setStatus(true, "Connected (real-time)");
    es.onerror = (e) => {
      console.warn("SSE error", e);
      setStatus(false, "SSE disconnected — reconnecting...");
      // browser will automatically retry; we keep UI as-is
    };
    es.onmessage = (ev) => {
      try {
        const payload = JSON.parse(ev.data);
        // ignore welcome events if any
        if (payload && payload.event === "welcome") return;
        appendMessage(payload);
      } catch (err) {
        console.warn("SSE parse error", err);
      }
    };
  }

  // send a message (POST /api/add)
  async function sendMessage() {
    const content = (contentInput.value || "").trim();
    if (!content) return;
    sendBtn.disabled = true;
    try {
      const url = apiBase + "/api/add";
      const headers = Object.assign({"Content-Type":"application/json"}, apiToken ? {"x-api-token": apiToken} : {});
      const resp = await fetch(url, {
        method: "POST",
        headers,
        body: JSON.stringify({ tfid, name, content })
      });
      if (!resp.ok) {
        const t = await resp.text().catch(()=>"(no text)");
        alert("Send failed: " + (t || resp.status));
      } else {
        contentInput.value = "";
        // don't reload: SSE will deliver sent message to us and other clients
      }
    } catch (err) {
      console.error("sendMessage error", err);
      alert("Send error: " + err.message);
    } finally {
      sendBtn.disabled = false;
      contentInput.focus();
    }
  }

  // events
  sendBtn.addEventListener("click", sendMessage);
  clearBtn.addEventListener("click", ()=> contentInput.value = "");
  contentInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }});

  // init
  (async () => {
    await loadHistory();
    startSse();
  })();

})(); 
</script>
</body>
        </html>
