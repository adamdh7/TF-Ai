<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TF-Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#000000; --panel:#000000; --text:#e6eefb; --muted:#9aa6bf; --card:#0b0b0b; --accent:#0b81ff; --header-h:56px; --accent-2:#0563c9; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Roboto,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
header{position:fixed;left:0;right:0;top:0;height:var(--header-h);display:flex;align-items:center;justify-content:center;background:var(--panel);z-index:1000;border-bottom:1px solid rgba(255,255,255,0.03)}
.app-title{font-weight:700;font-size:18px;cursor:pointer}
main{position:fixed;left:0;right:0;top:var(--header-h);bottom:0;overflow:auto;padding:12px;display:flex;flex-direction:column}
/* tab bar bottom */
.tab-bar { position:fixed; left:50%; transform:translateX(-50%); bottom:12px; z-index:1100; display:flex; gap:8px; background:transparent; }
.tab-btn { padding:8px 16px; border-radius:999px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); cursor:pointer; font-weight:600 }
.tab-btn.active { background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:white; }

.container { width:100%; max-width:980px; margin:0 auto; }

/* search area */
.search{padding:8px 12px;display:flex;justify-content:center}
.search-box{display:flex;align-items:center;gap:8px;background:var(--card);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);width:100%}
.search-box input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:15px}
.search-btn{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}

/* list views */
.view { margin-top:12px; display:none; flex-direction:column; gap:12px; }
.view.active { display:flex; }
.list{display:flex;flex-direction:column;gap:8px}
.empty{padding:18px;border-radius:12px;background:rgba(255,255,255,0.01);text-align:center;color:var(--muted)}
.contact{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer}
.contact:hover{background:rgba(255,255,255,0.02)}
.avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:var(--text);flex-shrink:0;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.meta{flex:1;min-width:0}
.meta-top{display:flex;justify-content:space-between;align-items:flex-start}
.name{font-weight:600;font-size:16px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.time{font-size:12px;color:var(--muted)}
.meta-bottom{display:flex;justify-content:space-between;margin-top:6px;align-items:center}
.snippet{font-size:13px;color:var(--muted);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.badge{background:var(--accent);color:white;padding:4px 8px;border-radius:999px;font-weight:600;font-size:13px}

/* messages/chat */
.messages-wrap{padding:12px;height:calc(100vh - var(--header-h) - 200px);overflow:auto;display:flex;flex-direction:column;gap:8px}
.messages{display:flex;flex-direction:column;gap:8px}
.msg{max-width:74%;padding:10px;border-radius:12px;margin-bottom:4px}
.msg.bot{background:#121212;color:var(--text);align-self:flex-start}
.msg.user{background:linear-gradient(180deg,var(--accent),#0563c9);color:white;align-self:flex-end}
.msg .checks{font-size:11px;margin-left:8px;opacity:0.9}
.chat-input{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:transparent}
.input{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:var(--card);color:var(--text);outline:none}
.send-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;color:var(--accent)}

/* group card */
.group-card{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;cursor:pointer}
.group-card:hover{background:rgba(255,255,255,0.02)}
.group-avatar{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));overflow:hidden}

/* large modals */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1300;display:none;align-items:center;justify-content:center;padding:20px}
.modal{width:100%;max-width:720px;background:#0b0b0b;border-radius:12px;padding:18px; color:var(--text)}
.modal h3{margin:0 0 12px 0}
.form-row{margin-bottom:10px}
.input-field{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}

/* profile fullscreen info */
.profile-full{display:flex;flex-direction:column;gap:12px}
.profile-full .big-avatar{width:120px;height:120px;border-radius:16px;overflow:hidden;background:#111;display:flex;align-items:center;justify-content:center;font-size:36px}

/* files gallery modal */
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.gallery-item{background:#0f0f0f;border-radius:8px;overflow:hidden;padding:6px;display:flex;flex-direction:column;align-items:center}
.gallery-item img{width:100%;height:100px;object-fit:cover;border-radius:6px}

/* share card modal */
.card-pick-list{display:flex;flex-wrap:wrap;gap:8px}
.card-recipient{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.03);cursor:pointer}

/* responsive fix */
@media (min-width:900px){
  main{max-width:900px;margin:0 auto}
  .messages-wrap{height:calc(100vh - var(--header-h) - 240px)}
}
</style>
</head>
<body>
  <header><div class="app-title">TF-Chat</div></header>

  <main>
    <div class="container">
      <!-- Search (shared) -->
      <section class="search">
        <div class="search-box" role="search">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
          <input id="searchInput" placeholder="Recherche (TFID ou 7 chif)" aria-label="Recherche" />
          <button id="searchBtn" class="search-btn">Rechercher</button>
        </div>
      </section>

      <!-- Views: Accueil and Groupe -->
      <section id="viewAccueil" class="view active">
        <div class="list" id="contactsList" aria-live="polite"></div>
      </section>

      <section id="viewGroupes" class="view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700;font-size:16px">Groupes</div>
          <div>
            <button id="createGroupBtn" class="tab-btn">Cr√©er groupe</button>
          </div>
        </div>
        <div id="groupsList" class="list"></div>
        <div id="groupsEmpty" class="empty" style="display:none">Vous avez aucun groupe pour l'instant</div>
      </section>
    </div>

    <!-- bottom tab -->
    <div class="tab-bar">
      <button id="tabAccueil" class="tab-btn active">Accueil</button>
      <button id="tabGroupes" class="tab-btn">Groupe</button>
    </div>
  </main>

  <!-- Chat modal (reused for private & group) -->
  <div id="chatModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:1200">
    <div style="height:100%;display:flex;flex-direction:column">
      <div style="height:56px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <button id="chatBack" style="background:transparent;border:0;color:var(--text);cursor:pointer">‚Üê</button>
        <div style="flex:1;text-align:center;font-weight:700;cursor:pointer" id="chatTitle">Chat</div>
        <div style="width:44px"></div>
      </div>
      <div class="messages-wrap">
        <div class="messages" id="messages"></div>
      </div>
      <div class="chat-input" id="chatInputRow">
        <input id="chatText" class="input" placeholder="Ekri mesaj..." autocomplete="off" />
        <button id="attachBtn" class="send-btn">üìé</button>
        <button id="sendBtn" class="send-btn">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- Group creation modal -->
  <div class="modal-backdrop" id="groupModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Cr√©er un groupe</h3>
      <div class="form-row">
        <label style="font-size:13px;color:var(--muted)">Photo du groupe (optionnel)</label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div id="groupPreview" class="group-avatar" style="width:72px;height:72px;border-radius:10px">G</div>
          <div style="flex:1">
            <input id="groupImageFile" type="file" accept="image/*" />
            <div style="font-size:12px;color:var(--muted);margin-top:6px">Choisissez une image pour le groupe (jpg/png)</div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <label style="font-size:13px;color:var(--muted)">Nom du groupe *</label>
        <input id="groupNameInput" class="input-field" placeholder="Nom du groupe (obligatoire)" />
      </div>
      <div class="form-row">
        <label style="font-size:13px;color:var(--muted)">Bio (optionnel)</label>
        <textarea id="groupBioInput" class="input-field" placeholder="Courte description"></textarea>
      </div>
      <div class="form-row">
        <label style="font-size:13px;color:var(--muted)">Ajoutez manm (TFID, s√©parez par virgule)</label>
        <input id="groupMembersInput" class="input-field" placeholder="ex: 0204123, 0303344" />
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="groupCancel" class="tab-btn">Retour</button>
        <button id="groupCreate" class="tab-btn" style="background:var(--accent);color:white">Valider</button>
      </div>
    </div>
  </div>

  <!-- profile full modal -->
  <div class="modal-backdrop" id="profileBackdrop">
    <div class="modal profile-full" role="dialog" aria-modal="true">
      <div style="display:flex;gap:12px;align-items:center;">
        <div class="big-avatar" id="profileBigAvatar">U</div>
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="pfName" style="font-weight:800;font-size:18px">Nom</div>
              <div id="pfTfid" style="font-size:13px;color:var(--muted);cursor:pointer">TF-0000000</div>
            </div>
            <div>
              <button id="pfAddContact" class="tab-btn">Ajout√©</button>
            </div>
          </div>
          <div id="pfBio" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="pfFilesBtn" class="tab-btn">Liste des fichiers</button>
        <button id="pfEphemBtn" class="tab-btn">√âph√©m√®re</button>
        <button id="pfLockBtn" class="tab-btn">Verrouillage</button>
        <button id="pfAddGroupBtn" class="tab-btn">Ajoute a un groupe</button>
        <button id="pfReportBtn" class="tab-btn" style="background:#ef4444;color:white">Signaler</button>
        <button id="pfBlockBtn" class="tab-btn">Bloqu√©</button>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="pfClose" class="tab-btn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- gallery modal -->
  <div class="modal-backdrop" id="galleryBackdrop">
    <div class="modal">
      <h3>Fichiers</h3>
      <div id="galleryGrid" class="gallery-grid"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="galleryClose" class="tab-btn">Fermer</button></div>
    </div>
  </div>

  <!-- share card modal -->
  <div class="modal-backdrop" id="cardBackdrop">
    <div class="modal">
      <h3>Partager une carte</h3>
      <div style="margin-bottom:8px">Choisissez jiska 7 kontak:</div>
      <div id="cardContactsList" class="card-pick-list" style="margin-bottom:12px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="cardCancel" class="tab-btn">Annuler</button>
        <button id="cardSend" class="tab-btn" style="background:var(--accent);color:white">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- invisible file input for profile/group upload -->
  <input type="file" id="hiddenFile" accept="image/*" style="display:none" />

<script>
/* ================== CONFIG ================== */
const API_BASE = 'https://tf-sove.onrender.com'; // adapt
const PROFILE_UPLOAD_URL = 'https://tf-stream-url.onrender.com/upload'; // adapt
const FRONTEND_NAME = 'site1';
const ADMIN_API_TOKEN = 'tfstream_45dd9c02d4e34f18a42d'; // adapt (kept from your script)
const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + "tf-sove.onrender.com/ws";

/* ===== helpers (kept from your code) ===== */
function normalizeInputToDigits(inp){ if(!inp) return null; const s=String(inp).trim().toUpperCase(); const digits=s.replace(/[^0-9]/g,''); return digits||null; }
function to17(shortOrDigits){ if(!shortOrDigits) return null; const ds=String(shortOrDigits).replace(/[^0-9]/g,''); if(ds.length>17) return ds.slice(-17); return ds.padStart(17,'0'); }
function formatTFShort(digitsString){ if(!digitsString) return ''; const s=String(digitsString).replace(/[^0-9]/g,''); const last7 = s.slice(-7); return 'TF-'+ last7.padStart(7,'0'); }
function nowISO(){ return (new Date()).toISOString(); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function makeCid(){ return String(Date.now()) + '-' + Math.floor(Math.random()*100000).toString(16); }

/* ========== state (reuse) ========== */
let me = { short: localStorage.getItem('tfchat.me.short') || null, tf17: localStorage.getItem('tfchat.me.17') || null, name: localStorage.getItem('tfchat.me.name') || 'Utilisateur', avatarDataUrl: localStorage.getItem('tfchat.me.avatar') || null };
let contacts = JSON.parse(localStorage.getItem('tfchat.contacts') || '[]');
let groups = JSON.parse(localStorage.getItem('tfchat.groups') || '[]'); // {name, bio, avatar, members:[]}
let ws = null; let reconnectTimer = null; let currentPartner = null; let currentGroup = null;
const conversationCache = {}; // same structure as before

/* ====== DOM refs ====== */
const tabAccueil = document.getElementById('tabAccueil');
const tabGroupes = document.getElementById('tabGroupes');
const viewAccueil = document.getElementById('viewAccueil');
const viewGroupes = document.getElementById('viewGroupes');

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const contactsListEl = document.getElementById('contactsList');

const groupsListEl = document.getElementById('groupsList');
const groupsEmptyEl = document.getElementById('groupsEmpty');
const createGroupBtn = document.getElementById('createGroupBtn');

const groupModalBackdrop = document.getElementById('groupModalBackdrop');
const groupPreview = document.getElementById('groupPreview');
const groupImageFile = document.getElementById('groupImageFile');
const groupNameInput = document.getElementById('groupNameInput');
const groupBioInput = document.getElementById('groupBioInput');
const groupMembersInput = document.getElementById('groupMembersInput');
const groupCancel = document.getElementById('groupCancel');
const groupCreate = document.getElementById('groupCreate');

const chatModalEl = document.getElementById('chatModal');
const chatBackBtn = document.getElementById('chatBack');
const chatTitleEl = document.getElementById('chatTitle');
const messagesEl = document.getElementById('messages');
const chatTextEl = document.getElementById('chatText');
const sendBtnEl = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');

const profileBackdrop = document.getElementById('profileBackdrop');
const profileBigAvatar = document.getElementById('profileBigAvatar');
const pfName = document.getElementById('pfName');
const pfTfid = document.getElementById('pfTfid');
const pfBio = document.getElementById('pfBio');
const pfFilesBtn = document.getElementById('pfFilesBtn');
const pfAddContact = document.getElementById('pfAddContact');
const pfClose = document.getElementById('pfClose');
const pfReportBtn = document.getElementById('pfReportBtn');
const pfBlockBtn = document.getElementById('pfBlockBtn');
const pfAddGroupBtn = document.getElementById('pfAddGroupBtn');

const galleryBackdrop = document.getElementById('galleryBackdrop');
const galleryGrid = document.getElementById('galleryGrid');
const galleryClose = document.getElementById('galleryClose');

const cardBackdrop = document.getElementById('cardBackdrop');
const cardContactsList = document.getElementById('cardContactsList');
const cardSend = document.getElementById('cardSend');
const cardCancel = document.getElementById('cardCancel');

const hiddenFile = document.getElementById('hiddenFile');

/* ===== storage helpers ===== */
function saveState(){ localStorage.setItem('tfchat.me.short', me.short || ''); localStorage.setItem('tfchat.me.17', me.tf17 || ''); localStorage.setItem('tfchat.me.name', me.name || ''); if(me.avatarDataUrl) localStorage.setItem('tfchat.me.avatar', me.avatarDataUrl); localStorage.setItem('tfchat.contacts', JSON.stringify(contacts || [])); localStorage.setItem('tfchat.groups', JSON.stringify(groups || [])); }

/* ===== rendering contacts ===== */
function renderContacts(filter=''){
  contactsListEl.innerHTML = '';
  const q = (filter||'').toLowerCase().trim();
  const list = contacts.filter(c => { if(!q) return true; return (c.name||'').toLowerCase().includes(q) || (c.tf17||'').toLowerCase().includes(q); });
  if(list.length === 0){
    const div = document.createElement('div'); div.className='empty'; div.textContent = 'Pa gen kontak. Rech√®ch yon TFID oswa ajoute yon kontak.'; contactsListEl.appendChild(div); return;
  }
  list.forEach(c => {
    const el = document.createElement('div'); el.className='contact'; el.dataset.tf17 = c.tf17;
    const avatarHtml = c.avatar ? `<img src="${c.avatar}" />` : escapeHtml((c.name||formatTFShort(c.tf17) || '').slice(0,2));
    el.innerHTML = `<div class="avatar">${avatarHtml}</div>
      <div class="meta">
        <div class="meta-top">
          <div class="name">${escapeHtml(c.name||formatTFShort(c.tf17)||'')}</div>
          <div class="time">${c.lastTs? timeAgo(c.lastTs): ''}</div>
        </div>
        <div class="meta-bottom">
          <div class="snippet">${escapeHtml(c.lastMsg||'')}</div>
          <div>${c.unread?'<span class="badge">'+c.unread+'</span>':''}</div>
        </div>
      </div>`;
    el.addEventListener('click', ()=> openChat(c.tf17, c, true));
    contactsListEl.appendChild(el);
  });
}

/* ===== rendering groups ===== */
function renderGroups(){
  groupsListEl.innerHTML = '';
  if(!groups || groups.length === 0){
    groupsEmptyEl.style.display = 'block';
    return;
  }
  groupsEmptyEl.style.display = 'none';
  groups.forEach(g=>{
    const el = document.createElement('div'); el.className='group-card';
    const avatarHtml = g.avatar ? `<img src="${g.avatar}" style="width:100%;height:100%;object-fit:cover" />` : escapeHtml((g.name||'G').slice(0,2));
    el.innerHTML = `<div class="group-avatar">${avatarHtml}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between">
          <div style="font-weight:700">${escapeHtml(g.name)}</div>
          <div style="font-size:12px;color:var(--muted)">${(g.members && g.members.length) || 0} membres</div>
        </div>
        <div style="margin-top:6px;color:var(--muted);font-size:13px">${escapeHtml(g.bio||'')}</div>
      </div>`;
    el.addEventListener('click', ()=> openGroupChat(g));
    groupsListEl.appendChild(el);
  });
}

/* ===== utility timeAgo ===== */
function timeAgo(ts){ if(!ts) return ''; const diff=Math.floor((Date.now()-ts)/1000); if(diff<60) return diff+'s'; if(diff<3600) return Math.floor(diff/60)+'m'; if(diff<86400) return Math.floor(diff/3600)+'h'; return new Date(ts).toLocaleDateString(); }

/* ===== networking helpers (callJSON, apiList, apiAdd, registerFrontendIfNeeded) ===== */
async function callJSON(url, opts = {}) { opts = Object.assign({}, opts); opts.headers = Object.assign({}, opts.headers || {}, { 'Accept': 'application/json' }); try { const r = await fetch(url, opts); const text = await r.text(); let json = null; try{ json = JSON.parse(text); }catch(e){} return { ok: r.ok, status: r.status, json, text }; } catch (err) { return { ok: false, error: err.message }; } }
async function apiList(tf17){ const url = `${API_BASE}/api/list?tfid=${encodeURIComponent(tf17)}&name=${encodeURIComponent(FRONTEND_NAME)}`; const r = await callJSON(url); if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`); return r.json.rows || []; }
async function apiAddPayload(payload){ const url = `${API_BASE}/api/add`; const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) }); if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`); return r.json; }
async function apiAdd(recipient17, contentObj){ const body = { tfid: recipient17, name: FRONTEND_NAME, content: JSON.stringify(contentObj), source_url: location.origin }; return await apiAddPayload(body); }
async function apiAddToGroup(groupName, contentObj){ const body = { group_name: groupName, name: FRONTEND_NAME, content: JSON.stringify(contentObj), source_url: location.origin }; const url = `${API_BASE}/api/add`; const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`); return r.json; }
async function registerFrontendIfNeeded(){ try { const url = `${API_BASE}/admin/register-frontend`; const payload = { name: FRONTEND_NAME, callback_url: location.origin }; const r = await callJSON(url, { method:"POST", headers:{"Content-Type":"application/json","x-api-token": ADMIN_API_TOKEN}, body: JSON.stringify(payload) }); return r.ok; } catch(e){ return false; } }

/* ===== group admin calls (create & add members) using admin token ===== */
async function adminCreateGroup(name, bio, avatarUrl){
  const url = `${API_BASE}/admin/groups/create`;
  const payload = { name, owner_name: me.name || null };
  const r = await callJSON(url, { method:'POST', headers: {'Content-Type':'application/json','x-api-token': ADMIN_API_TOKEN}, body: JSON.stringify(payload) });
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  // store additional meta locally (bio & avatar)
  groups.unshift({ name, bio, avatar: avatarUrl || null, members: [] });
  saveState();
  renderGroups();
  return true;
}
async function adminAddMember(group_name, tfid){
  const url = `${API_BASE}/admin/groups/add`;
  const payload = { group_name, tfid };
  const r = await callJSON(url, { method:'POST', headers: {'Content-Type':'application/json','x-api-token': ADMIN_API_TOKEN}, body: JSON.stringify(payload) });
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  const g = groups.find(x=>x.name===group_name); if(g){ g.members = g.members || []; if(!g.members.includes(tfid)) g.members.push(tfid); saveState(); renderGroups(); }
  return true;
}

/* ===== Group image upload helper (uses PROFILE_UPLOAD_URL) ===== */
async function uploadImageFile(file){
  try {
    const fd = new FormData(); fd.append('file', file);
    const resp = await fetch(PROFILE_UPLOAD_URL, { method:'POST', body: fd });
    const json = await resp.json().catch(()=>null);
    if(!resp.ok || !json) throw new Error('Upload failed');
    const url = json.url || json.path || null;
    if(!url) throw new Error('No url in upload response');
    return url;
  } catch(err){ throw err; }
}

/* ===== group modal events ===== */
createGroupBtn.addEventListener('click', ()=>{ groupModalBackdrop.style.display='flex'; });
groupCancel.addEventListener('click', ()=>{ groupModalBackdrop.style.display='none'; });
groupImageFile.addEventListener('change', async (ev)=>{ const f = ev.target.files && ev.target.files[0]; if(!f) return; try { groupPreview.innerHTML = '...'; const url = await uploadImageFile(f); groupPreview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:10px"/>`; groupPreview.dataset.url = url; } catch(err){ alert('Upload echwe: ' + (err.message||err)); groupPreview.innerHTML = 'G'; } });
groupCreate.addEventListener('click', async ()=>{
  const name = (groupNameInput.value||'').trim();
  if(!name){ alert('Nom obligatoire'); return; }
  const bio = (groupBioInput.value||'').trim();
  const membersRaw = (groupMembersInput.value||'').trim();
  const members = membersRaw.split(',').map(s=>normalizeInputToDigits(s)).filter(Boolean).map(s=>to17(s));
  try {
    await adminCreateGroup(name, bio, groupPreview.dataset.url || null);
    // add me as member
    if(me.tf17) await adminAddMember(name, me.tf17);
    // add listed members
    for(const m of members){ await adminAddMember(name, m); }
    groupModalBackdrop.style.display='none';
    groupNameInput.value=''; groupBioInput.value=''; groupMembersInput.value=''; groupPreview.innerHTML='G'; delete groupPreview.dataset.url;
    alert('Groupe cr√©√©'); renderGroups();
  } catch(err){ alert('Cr√©ation groupe echwe: ' + (err.message||err)); }
});

/* ===== tabs behavior ===== */
tabAccueil.addEventListener('click', ()=>{ tabAccueil.classList.add('active'); tabGroupes.classList.remove('active'); viewAccueil.classList.add('active'); viewGroupes.classList.remove('active'); });
tabGroupes.addEventListener('click', ()=>{ tabAccueil.classList.remove('active'); tabGroupes.classList.add('active'); viewAccueil.classList.remove('active'); viewGroupes.classList.add('active'); });

/* ===== chat logic (open private chat) ===== */
/* conversation cache & message helpers (simplified) */
function convKey(a,b){ return `${a}|${b}`; }
function addOrUpdateMessageToCache(me17, other17, msg){ const key = convKey(me17, other17); conversationCache[key] = conversationCache[key] || []; const list = conversationCache[key]; const idx = msg.cid ? list.findIndex(x=>x.cid===msg.cid) : (msg.id ? list.findIndex(x=>String(x.id)===String(msg.id)) : -1); if(idx!==-1) list[idx] = Object.assign({}, list[idx], msg); else list.push(msg); list.sort((a,b)=> (new Date(a.created_at||0)) - (new Date(b.created_at||0))); }
async function loadConversationPrivate(me17, other17){
  const key = convKey(me17, other17); conversationCache[key] = conversationCache[key] || [];
  // fetch both directions using apiList (server stores msg rows for tfid+name)
  try {
    const outRows = await apiList(other17); // messages where other is recipient (their list)
    for(const r of outRows){
      let parsed=null;
      try{ parsed = JSON.parse(r.content); }catch(e){ parsed = null; }
      const from = parsed && parsed.from ? parsed.from : other17;
      const text = parsed && (parsed.text || parsed.message) ? (parsed.text || parsed.message) : r.content;
      if(from !== me17) continue; // we want messages where `from` equals expected sender
      const msg = { id: r.id, cid: parsed?.cid || null, from, text, created_at: parsed?.time || r.created_at };
      addOrUpdateMessageToCache(me17, other17, msg);
    }
  } catch(e){}
  try {
    const inRows = await apiList(me17); // incoming to me
    for(const r of inRows){
      let parsed=null;
      try{ parsed = JSON.parse(r.content); }catch(e){ parsed = null; }
      const from = parsed && parsed.from ? parsed.from : null;
      if(!from || from !== other17) continue;
      const text = parsed && (parsed.text || parsed.message) ? (parsed.text || parsed.message) : r.content;
      const msg = { id: r.id, cid: parsed?.cid || null, from, text, created_at: parsed?.time || r.created_at };
      addOrUpdateMessageToCache(me17, other17, msg);
    }
  } catch(e){}
  renderConversation(me17, other17);
}
function renderConversation(me17, other17){
  const key = convKey(me17, other17); const arr = conversationCache[key] ? [...conversationCache[key]] : []; messagesEl.innerHTML='';
  if(arr.length===0) messagesEl.innerHTML = '<div class="empty">Pa gen mesaj ank√≤.</div>';
  else {
    for(const m of arr){
      const d = document.createElement('div'); d.className = 'msg ' + (m.from === me17 ? 'user' : 'bot');
      const ts = m.created_at ? (new Date(m.created_at)).toLocaleString() : '';
      d.innerHTML = `<div>${escapeHtml(m.text)}</div><div style="font-size:11px;color:var(--muted);margin-top:6px">${formatTFShort(m.from||'')} ‚Ä¢ ${ts}</div>`;
      messagesEl.appendChild(d);
    }
  }
  setTimeout(()=> { const wrap = document.querySelector('.messages-wrap'); if(wrap) wrap.scrollTop = wrap.scrollHeight; }, 50);
}

function openChat(other17, contactObj=null, pushHistory=true){
  if(!me.tf17){ alert('Pa gen TFID pou itilizat√® a. Mete li nan Param√®tres.'); return; }
  currentPartner = { tf17: other17, name: contactObj && contactObj.name ? contactObj.name : null };
  currentGroup = null;
  chatTitleEl.textContent = (currentPartner.name || formatTFShort(currentPartner.tf17));
  messagesEl.innerHTML = '<div class="empty">Chaje mesaj...</div>';
  loadConversationPrivate(me.tf17, other17).catch(()=>{});
  chatModalEl.style.display = 'block';
  setTimeout(()=> chatTextEl.focus(), 150);
}

/* ===== group chat logic ===== */
async function loadConversationGroup(groupName){
  // For group, we will read server messages where tfid equals group's representative tfid? Our server supports group_name in /api/add, but not list by group; fallback: use stored local group.members and fetch each member's outgoing messages to group? Simpler: call /api/list for me (incoming) and filter messages whose parsed content indicates group (we will standardize content.type='group' and include group_name in parsed payload)
  // We'll do this: fetch my messages and any other relevant messages from server via apiList for me and for each member; then filter where parsed.group === groupName
  conversationCache[groupName] = conversationCache[groupName] || [];
  const seen = new Set();
  // fetch incoming to me (messages sent to me where content includes group)
  try {
    const rows = await apiList(me.tf17);
    for(const r of rows){
      let parsed=null; try{ parsed = JSON.parse(r.content); }catch(e){ parsed=null; }
      if(parsed && parsed.group === groupName){
        const msg = { id: r.id, cid: parsed.cid||null, from: parsed.from || null, text: parsed.text||parsed.message||'', created_at: parsed.time || r.created_at };
        const keyu = (msg.cid? 'cid:'+msg.cid : 'id:'+msg.id);
        if(seen.has(keyu)) continue; seen.add(keyu);
        conversationCache[groupName].push(msg);
      }
    }
  } catch(e){}
  // fetch some outgoing from members (optional) - for responsiveness, also load group.members's latest
  const g = groups.find(x=>x.name===groupName);
  if(g && g.members && g.members.length){
    for(const m of g.members.slice(0,50)){
      try{
        const rows = await apiList(m);
        for(const r of rows){
          let parsed=null; try{ parsed = JSON.parse(r.content); }catch(e){ parsed=null; }
          if(parsed && parsed.group === groupName){
            const msg = { id: r.id, cid: parsed.cid||null, from: parsed.from || parsed.from_member || null, text: parsed.text||parsed.message||'', created_at: parsed.time || r.created_at };
            const keyu = (msg.cid? 'cid:'+msg.cid : 'id:'+msg.id);
            if(seen.has(keyu)) continue; seen.add(keyu);
            conversationCache[groupName].push(msg);
          }
        }
      } catch(e){}
    }
  }
  // sort and render
  conversationCache[groupName].sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
  messagesEl.innerHTML='';
  const arr = conversationCache[groupName];
  if(arr.length===0) messagesEl.innerHTML = '<div class="empty">Pa gen mesaj nan gwoup sa.</div>';
  else {
    for(const m of arr){
      const d = document.createElement('div'); d.className = 'msg ' + (m.from === me.tf17 ? 'user' : 'bot');
      const ts = m.created_at ? (new Date(m.created_at)).toLocaleString() : '';
      // display name if in contacts
      const contact = contacts.find(c=>c.tf17 === m.from);
      const displayName = contact ? contact.name : formatTFShort(m.from || '');
      d.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${escapeHtml(displayName)}</div><div>${escapeHtml(m.text)}</div><div style="font-size:11px;color:var(--muted);margin-top:6px">${formatTFShort(m.from||'')} ‚Ä¢ ${ts}</div>`;
      messagesEl.appendChild(d);
    }
  }
  setTimeout(()=> { const wrap = document.querySelector('.messages-wrap'); if(wrap) wrap.scrollTop = wrap.scrollHeight; }, 50);
}

function openGroupChat(groupObj){
  if(!me.tf17){ alert('Pa gen TFID pou itilizat√® a. Mete li nan Param√®tres.'); return; }
  currentGroup = groupObj;
  currentPartner = null;
  chatTitleEl.textContent = groupObj.name;
  messagesEl.innerHTML = '<div class="empty">Chaje mesaj gwoup...</div>';
  loadConversationGroup(groupObj.name).catch(()=>{});
  chatModalEl.style.display = 'block';
  setTimeout(()=> chatTextEl.focus(), 150);
}

/* ===== sending messages (private & group) ===== */
sendBtnEl.addEventListener('click', async ()=>{
  const txt = (chatTextEl.value||'').trim(); if(!txt) return;
  const cid = makeCid();
  const now = nowISO();
  if(currentGroup){
    // send group message using apiAddToGroup
    const payload = { type:'group', group: currentGroup.name, from: me.tf17, text: txt, time: now, cid, name: me.name || null };
    // optimistic UI
    addOrUpdateMessageToCache(me.tf17, currentGroup.name, { id:null, cid, from: me.tf17, text: txt, created_at: now });
    renderConversation(me.tf17, currentGroup.name);
    chatTextEl.value = '';
    try { await apiAddToGroup(currentGroup.name, payload); setTimeout(()=> loadConversationGroup(currentGroup.name), 500); } catch(e){ alert('Envoi √©chou√©: '+(e.message||e)); }
  } else if(currentPartner){
    const payload = { type:'text', from: me.tf17, text: txt, time: now, cid, name: me.name || null };
    addOrUpdateMessageToCache(me.tf17, currentPartner.tf17, { id:null, cid, from: me.tf17, text: txt, created_at: now });
    renderConversation(me.tf17, currentPartner.tf17);
    chatTextEl.value = '';
    try { await apiAdd(currentPartner.tf17, payload); setTimeout(()=> loadConversationPrivate(me.tf17, currentPartner.tf17), 500); } catch(e){ alert('Envoi √©chou√©: '+(e.message||e)); }
  }
});

/* ===== attach button (open gallery / upload) - simplified: open file chooser */ 
attachBtn.addEventListener('click', ()=>{ hiddenFile.click(); });
hiddenFile.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0]; if(!f) return;
  try {
    const url = await uploadImageFile(f);
    const now = nowISO(); const cid = makeCid();
    const payload = { type: 'image', from: me.tf17, text: '', time: now, cid, name: me.name || null, url };
    if(currentGroup){ payload.group = currentGroup.name; await apiAddToGroup(currentGroup.name, payload); } else if(currentPartner){ await apiAdd(currentPartner.tf17, payload); }
    // optimistic store: reuse addOrUpdate with media
    if(currentGroup){ addOrUpdateMessageToCache(me.tf17, currentGroup.name, { id:null, cid, from: me.tf17, text: '[image]', media_url:url, created_at: now }); renderConversation(me.tf17, currentGroup.name); }
    else { addOrUpdateMessageToCache(me.tf17, currentPartner.tf17, { id:null, cid, from: me.tf17, text: '[image]', media_url:url, created_at: now }); renderConversation(me.tf17, currentPartner.tf17); }
  } catch(err){ alert('Upload echwe: ' + (err.message||err)); }
});

/* ===== profile modal logic (open when clicking a name in chat) ===== */
function openProfileModal(tf17){
  const contact = contacts.find(c=>c.tf17===tf17) || { tf17, name: formatTFShort(tf17), avatar:null, bio:'' };
  profileBigAvatar.innerHTML = contact.avatar ? `<img src="${contact.avatar}" style="width:100%;height:100%;object-fit:cover"/>` : (contact.name ? contact.name.slice(0,2).toUpperCase() : 'U');
  pfName.textContent = contact.name || formatTFShort(contact.tf17);
  pfTfid.textContent = contact.tf17;
  pfBio.textContent = contact.bio || '';
  pfAddContact.textContent = contacts.find(c=>c.tf17===tf17) ? 'D√©j√†' : 'Ajout√©';
  profileBackdrop.style.display='flex';
}
pfClose.addEventListener('click', ()=> profileBackdrop.style.display='none');
pfFilesBtn.addEventListener('click', async ()=>{
  // show gallery of media between me and this profile
  galleryGrid.innerHTML = '';
  const tf = pfTfid.textContent;
  // fetch messages for this tfid (both directions) and show media_url if present
  try {
    const rows1 = await apiList(me.tf17);
    const rows2 = await apiList(tf);
    const all = [...(rows1||[]), ...(rows2||[])];
    const medias = [];
    for(const r of all){
      let parsed=null; try{ parsed = JSON.parse(r.content);}catch(e){ parsed=null; }
      if(parsed && (parsed.url || parsed.media_url)) medias.push(parsed.url||parsed.media_url);
    }
    if(medias.length===0) galleryGrid.innerHTML = '<div class="empty">Pa gen fichye</div>';
    else {
      for(const m of medias.slice(-50).reverse()){
        const div = document.createElement('div'); div.className='gallery-item'; div.innerHTML = `<img src="${m}" />`; galleryGrid.appendChild(div);
      }
    }
    galleryBackdrop.style.display='flex';
  } catch(e){ alert('Pa kap jwenn fichye: ' + (e.message||e)); }
});

galleryClose.addEventListener('click', ()=> galleryBackdrop.style.display='none');

/* ===== share card modal ===== */
function openShareCard(defaultName, defaultTfid){
  // populate contact choices
  cardContactsList.innerHTML = '';
  contacts.forEach(c=>{
    const btn = document.createElement('div'); btn.className='card-recipient'; btn.dataset.tf17 = c.tf17; btn.textContent = c.name || formatTFShort(c.tf17);
    btn.addEventListener('click', ()=> btn.classList.toggle('selected'));
    cardContactsList.appendChild(btn);
  });
  cardBackdrop.style.display='flex';
}
cardCancel.addEventListener('click', ()=> cardBackdrop.style.display='none');
cardSend.addEventListener('click', async ()=>{
  const sels = Array.from(cardContactsList.querySelectorAll('.card-recipient.selected')).map(el=>el.dataset.tf17).slice(0,7);
  if(sels.length===0){ alert('Chwazi omwen 1 kontak'); return; }
  // compose card payload (use current profile info or selected)
  const cardPayload = { type:'card', from: me.tf17, time: nowISO(), cid: makeCid(), card: { name: currentPartner? currentPartner.name : '', tfid: currentPartner? currentPartner.tf17 : '' } };
  for(const t of sels){ try{ await apiAdd(t, cardPayload); }catch(e){ console.warn('Card send fail', t, e); } }
  cardBackdrop.style.display='none'; alert('Carte voye');
});

/* ===== click on TFID to copy ===== */
document.addEventListener('click', (ev)=>{
  const el = ev.target;
  if(el && el.id === 'pfTfid'){ const txt = el.textContent || ''; navigator.clipboard?.writeText(txt).then(()=>{ alert('TFID copied: '+txt); }).catch(()=>{}); }
});

/* ===== search behavior ===== */
searchBtn.addEventListener('click', async ()=> performSearchQuery(searchInput.value.trim()));
searchInput.addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ e.preventDefault(); await performSearchQuery(searchInput.value.trim()); }});
async function performSearchQuery(raw){
  if(!raw) return;
  const digits = normalizeInputToDigits(raw); if(!digits){ renderContacts(raw); return; }
  if(digits.length < 7){ alert('TFID dwe gen omwen 7 chif.'); return; }
  const short7 = digits.slice(-7); const tf17 = to17(short7);
  let local = contacts.find(c => c.tf17 === tf17);
  if(local){ openChat(local.tf17, local, true); return; }
  try {
    const rows = await apiList(tf17);
    if(rows && rows.length > 0){
      const last = rows[0] || rows[rows.length-1];
      let nameFromServer=null; try{ const p = JSON.parse(last.content); nameFromServer = p.name || null; }catch(e){}
      const lastMsg = last.content||'';
      const c = { tf17, name: nameFromServer || formatTFShort(short7), lastMsg, lastTs: Date.now(), unread:0, blocked:false, avatar:null };
      contacts.unshift(c); saveState(); renderContacts(); openChat(c.tf17, c, true); return;
    } else {
      if(confirm('Pa jwenn done sou serveÃÄr. Kreye kontak lokal pou TFID sa a?')){
        const c = { tf17, name: formatTFShort(short7), lastMsg:'', lastTs: Date.now(), unread:0, blocked:false, avatar:null };
        contacts.unshift(c); saveState(); renderContacts(); openChat(c.tf17, c, true);
      }
    }
  } catch(err){ alert('Er√® l√® w ap ch√®che sou serveÃÄr: ' + (err.message||err)); }
}

/* ===== init / boot ===== */
renderContacts(); renderGroups();
if(me.tf17){
  // subscribe ws (optional)
} else {
  // nothing; user will set me.tf17 via settings (you have existing settings modal in original code)
}
</script>
</body>
  </html>
