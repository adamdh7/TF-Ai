<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TF-Chat (fix API host)</title>
<style>
  :root{--bg:#f2f2f5;--card:#fff;--muted:#6b6b6b;--accent:#128C7E;--unread:#ff4d4f;--radius:14px;--maxw:980px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  .wrap{max-width:var(--maxw);margin:0 auto;height:100vh;display:flex;flex-direction:column}
  header{height:88px;display:flex;align-items:flex-end;padding:14px 16px;background:#fff;border-bottom:1px solid rgba(0,0,0,.06)}
  .title{font-weight:800;font-size:22px}
  .me-line{font-size:13px;color:var(--muted);margin-top:4px}
  main{flex:1;overflow:auto;padding:12px}
  .card{background:var(--card);padding:12px;border-radius:16px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .search{width:100%;padding:12px;border-radius:14px;border:1px solid #eee;font-size:16px;background:#fafafa}
  .row{display:flex;gap:8px;margin-top:10px}
  button{padding:10px 12px;border-radius:12px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(18,140,126,.12)}
  .contacts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .contact{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border-radius:12px;cursor:pointer;border:1px solid #f0f0f0;position:relative}
  .avatar{width:48px;height:48px;border-radius:50%;background:#ddd;flex-shrink:0;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .chat-page{display:flex;flex-direction:column;height:calc(100vh - 200px)}
  .chat-head{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #eee}
  .chat-body{flex:1;overflow:auto;padding:12px;background:linear-gradient(#f2f2f5,#f8f8f8)}
  .messages{display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:78%;padding:10px 14px;border-radius:16px;background:#fff;align-self:flex-start;word-break:break-word;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
  .bubble.me{background:#dcf8c6;align-self:flex-end}
  .time{display:block;font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:var(--card)}
  input[type="text"]{width:100%;padding:10px;border-radius:12px;border:1px solid #eee}
  .small{font-size:13px;color:var(--muted)}
  .unread-badge{position:absolute;right:12px;top:12px;background:var(--unread);color:#fff;border-radius:12px;padding:2px 8px;font-size:12px;font-weight:700}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .hidden-log{display:none}
  @media(min-width:900px){ .wrap{border-left:1px solid rgba(0,0,0,.04);border-right:1px solid rgba(0,0,0,.04)} .card{border-radius:18px} }
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div>
      <div class="title">TF-Chat</div>
      <div id="meLabel" class="me-line">Chargement...</div>
    </div>
  </header>

  <main id="main">
    <div class="card">
      <input id="searchInput" class="search" placeholder="Entrer TFID (ex: TF-0204143 ou 0204143) puis Appuyer Rechercher" />
      <div class="row" style="margin-top:10px">
        <button id="btnSearch">Rechercher</button>
        <button id="btnProfile" class="btn-ghost">Mon profil / Paramètres</button>
        <button id="btnClear" class="btn-ghost" style="margin-left:8px">Effacer session</button>
      </div>
      <div id="status" class="status"></div>
    </div>

    <div class="card">
      <div class="small">Contacts récents</div>
      <div id="contacts" class="contacts"></div>
    </div>

    <div id="chatContainer"></div>
    <div class="hidden-log" id="logArea"></div>
  </main>
</div>

<script>
/* CONFIG — ATTENTION: SAVE_HOST must be FULL absolute URL (https://...) */
const CONFIG = {
  SAVE_HOST: "https://tf-sove.onrender.com",   // <-- IMPORTANT : fixed backend host
  API_LIST: "/api/list",
  API_ADD: "/api/add",
  API_TOKEN: "tfstream_45dd9c02d4e34f18a42d",
  FRONTEND_NAME: "site1",
  UI_DIGITS: 7,
  SERVER_DIGITS: 17,
  WS_URL: "wss://YOUR_WS_SERVER_DOMAIN",       // <-- replace when you deploy WebSocket server; keep placeholder for now
  SESSION_KEY: "tfchat_session_site1_v4"
};

/* small helpers */
function el(t, c){ const e=document.createElement(t); if(c) e.className=c; return e; }
function extractDigits(s){ const m=String(s||'').match(/\d+/g); return m? m.join('') : ''; }
function uiNormalize(v){ v = String(v||'').trim(); if(!v) return ''; if(v.startsWith('TF-')) return v; const d = extractDigits(v); return 'TF-' + d.padStart(CONFIG.UI_DIGITS,'0'); }
function uiRandom(){ return 'TF-' + Math.floor(1000000 + Math.random()*8999999).toString().padStart(CONFIG.UI_DIGITS,'0'); }
function uiToServer(ui){ const d=extractDigits(ui); if(!d) throw new Error('TFID invalide'); return d.padStart(CONFIG.SERVER_DIGITS,'0'); }
function log(){ console.debug.apply(console, ['[TFCHAT]'].concat(Array.from(arguments))); const a=document.getElementById('logArea'); if(a) a.textContent += Array.from(arguments).join(' ') + '\\n'; }
function status(t){ document.getElementById('status').textContent = t || ''; }

/* NETWORK — always build absolute URL using CONFIG.SAVE_HOST */
async function apiList(serverTfid){
  const url = new URL(CONFIG.SAVE_HOST + CONFIG.API_LIST);
  url.searchParams.set('tfid', serverTfid);
  url.searchParams.set('name', CONFIG.FRONTEND_NAME);
  log('API LIST GET', url.toString());
  const resp = await fetch(url.toString(), { method: 'GET', headers: { 'x-api-token': CONFIG.API_TOKEN }});
  const txt = await resp.text().catch(()=>'(no body)');
  let parsed = null;
  try{ parsed = JSON.parse(txt); }catch(e){ parsed = null; }
  if(!resp.ok) throw new Error(`LIST HTTP ${resp.status} — ${txt}`);
  return parsed || txt;
}
async function apiAdd(serverTfid, contentObj){
  const url = CONFIG.SAVE_HOST + CONFIG.API_ADD;
  log('API ADD POST', url, { tfid: serverTfid, name: CONFIG.FRONTEND_NAME });
  const resp = await fetch(url, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-api-token': CONFIG.API_TOKEN },
    body: JSON.stringify({ tfid: serverTfid, name: CONFIG.FRONTEND_NAME, content: JSON.stringify(contentObj) })
  });
  const text = await resp.text().catch(()=>'(no body)');
  let parsed = null;
  try{ parsed = JSON.parse(text); }catch(e){ parsed = null; }
  if(!resp.ok) throw new Error(parsed && parsed.error ? parsed.error : text);
  return parsed || text;
}

/* UI minimal (same logic as before) */
const state = { me:null, contacts:[], messages:{}, seenMessageIds:new Set(), currentChatServer:null, ws:null };

function saveSession(){ if(state.me) localStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify(state.me)); else localStorage.removeItem(CONFIG.SESSION_KEY); }
function loadSession(){ try{ return JSON.parse(localStorage.getItem(CONFIG.SESSION_KEY)); }catch(e){return null} }

function updateHeader(){ document.getElementById('meLabel').textContent = state.me ? (state.me.name + ' • ' + state.me.ui) : 'Non configuré'; }
function addContactIfMissing(ui, server, name){
  if(!state.contacts.find(c=>c.server===server)){
    state.contacts.unshift({ ui, server, name: name||ui, avatarDataUrl:null, unread:0 });
    renderContacts();
  }
}
function renderContacts(){
  const d = document.getElementById('contacts'); d.innerHTML='';
  state.contacts.forEach(c=>{
    const row = el('div','contact');
    row.innerHTML = `<div class="avatar">${c.avatarDataUrl? '<img src="'+c.avatarDataUrl+'">':''}</div>
                     <div><strong>${c.name||c.ui}</strong><div class="small">${c.ui}</div></div>`;
    if(c.unread) { const b=el('div','unread-badge'); b.textContent = c.unread>99? '99+' : c.unread; row.appendChild(b); }
    row.onclick = ()=> openChat(c.server, c.ui);
    d.appendChild(row);
  });
}

async function openChat(server, ui){
  state.currentChatServer = server;
  const container = document.getElementById('chatContainer'); container.innerHTML = '';
  const wrap = el('div','card');
  const head = el('div','chat-head'); head.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="avatar"></div><div><strong>${ui}</strong><div class="small">${ui}</div></div></div>`;
  wrap.appendChild(head);

  const page = el('div','chat-page');
  const body = el('div','chat-body'); const msgs = el('div','messages'); body.appendChild(msgs);
  page.appendChild(body);

  const composer = el('div','composer'); const input = el('input'); input.type='text'; input.placeholder='Écrire un message...';
  const send = el('button'); send.textContent='Envoyer';
  composer.appendChild(input); composer.appendChild(send);
  page.appendChild(composer); wrap.appendChild(page); container.appendChild(wrap);

  state.messages[server] = state.messages[server] || [];

  // load persisted messages from server
  try{
    const res = await apiList(server);
    if(res && res.ok && Array.isArray(res.rows)){
      const rows = res.rows.slice().reverse();
      rows.forEach(r=>{
        if(state.messages[server].some(m=>m.id===r.id)) return;
        try{
          const payload = JSON.parse(r.content);
          state.messages[server].push({ id:r.id, from:payload.from||'unknown', text:payload.text||'', time:r.created_at });
          state.seenMessageIds.add(`${r.name}:${r.id}`);
        }catch(e){
          state.messages[server].push({ id:r.id, from:'unknown', text:r.content||'', time:r.created_at });
          state.seenMessageIds.add(`${r.name}:${r.id}`);
        }
      });
    }
  }catch(e){
    log('apiList error', e.message||e);
  }

  function render(){
    msgs.innerHTML='';
    (state.messages[server]||[]).forEach(m=>{
      const b = el('div','bubble ' + ((m.from===state.me.server)?'me':''));
      b.innerHTML = `${String(m.text)}<div class="time">${m.time? new Date(m.time).toLocaleTimeString():''}</div>`;
      msgs.appendChild(b);
    });
    msgs.scrollTop = msgs.scrollHeight;
  }
  render();

  send.onclick = async () => {
    const txt = input.value.trim(); if(!txt) return;
    // optimistic
    state.messages[server].push({ id:'local-'+Date.now(), from: state.me.server, text: txt, time: new Date().toISOString() });
    render(); input.value='';
    const payload = { type:'text', from: state.me.server, text: txt, time: new Date().toISOString() };
    try {
      status('Envoi...');
      await apiAdd(server, payload);           // to recipient
      await apiAdd(state.me.server, payload);  // copy to self
      // attempt quick refresh of recipient & self (safe)
      try{ const [r1, r2] = await Promise.allSettled([apiList(server), apiList(state.me.server)]); }catch(e){/*ignore*/ }
      status('');
    } catch(e){
      status(''); alert('Envoi échoué: ' + (e.message||e));
    }
  };
}

/* WEBSOCKET push (subscribe to my server) */
function connectWs(){
  if(!CONFIG.WS_URL || CONFIG.WS_URL.includes('YOUR_WS_SERVER_DOMAIN')){
    log('WS disabled (configure CONFIG.WS_URL).'); return;
  }
  try{
    state.ws = new WebSocket(CONFIG.WS_URL);
  }catch(e){ log('WS connect failed', e); return; }
  state.ws.addEventListener('open', ()=> {
    log('WS open');
    if(state.me && state.me.server) state.ws.send(JSON.stringify({ type:'subscribe', server: state.me.server }));
  });
  state.ws.addEventListener('message', ev => {
    let m=null; try{ m = JSON.parse(ev.data); }catch(e){return;}
    if(!m || m.type!=='message') return;
    const key = `${m.name}:${m.id}`;
    if(state.seenMessageIds.has(key)){ log('dup ignored', key); return; }
    state.seenMessageIds.add(key);
    const target = String(m.tfid);
    const content = (typeof m.content === 'string') ? (()=>{ try{return JSON.parse(m.content);}catch(e){return m.content;}})() : m.content;
    const msg = { id:m.id, from: content && content.from? String(content.from) : 'unknown', text:(content && (content.text||content.message))||String(content||''), time: m.created_at || new Date().toISOString() };
    state.messages[target] = state.messages[target] || []; if(!state.messages[target].some(x=>x.id===msg.id)) state.messages[target].push(msg);
    if(target === state.me.server){
      const from = msg.from; if(!state.contacts.find(c=>c.server===from)) addContactIfMissing('TF-'+from.slice(-7), from, 'TF-'+from.slice(-7));
      if(state.currentChatServer === from){ if(window.renderChatRefresh) window.renderChatRefresh(from); } else {
        const c = state.contacts.find(c=>c.server===from); if(c) c.unread=(c.unread||0)+1; renderContacts();
      }
    } else {
      if(state.currentChatServer === target && window.renderChatRefresh) window.renderChatRefresh(target);
    }
  });
  state.ws.addEventListener('close', ()=> { log('WS closed, reconnect'); setTimeout(connectWs,1000); });
  state.ws.addEventListener('error', e=> log('WS error', e));
}

/* INIT */
(function(){
  const s = loadSession();
  if(s && s.ui && s.server) state.me = s;
  else {
    const ui = uiRandom(); state.me = { ui, server: uiToServer(ui), name:'Moi', avatarDataUrl:null };
    saveSession();
  }
  updateHeader();
  addContactIfMissing('TF-7777777', uiToServer('TF-7777777'), "Adam_D'H7");
  renderContacts();
  // connect WS (if configured)
  connectWs();
  log('init done', state.me);
})();

/* ELEMENTS wiring */
document.getElementById('btnSearch').addEventListener('click', async ()=>{
  const v = document.getElementById('searchInput').value.trim(); if(!v){ alert('TFID requis'); return; }
  const ui = uiNormalize(v); const srv = uiToServer(ui);
  status('Recherche...');
  try{ await apiList(srv); addContactIfMissing(ui, srv, ui); openChat(srv, ui); }catch(e){ alert('Recherche échouée: ' + (e.message||e)); }
  status('');
});
document.getElementById('btnProfile').addEventListener('click', ()=>{
  const n = prompt('Pseudo', state.me.name || state.me.ui) || state.me.name || state.me.ui; state.me.name = n; saveSession(); updateHeader(); alert('Nom enregistré');
});
document.getElementById('btnClear').addEventListener('click', ()=>{ if(confirm('Effacer session locale ?')){ localStorage.removeItem(CONFIG.SESSION_KEY); location.reload(); } });

</script>
</body>
</html>
