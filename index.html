<!DOCTYPE html>
<html lang="ht">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TF-Chat</title>
  <style>
    /* UI Styles */
    body { font-family: Arial, sans-serif; background-color: #f2f2f2; margin:0; padding:0; }
    header { background:#fff; padding:15px; text-align:center; font-size:24px; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1); position:relative; }
    .menu-btn { position:absolute; left:15px; top:15px; font-size:24px; cursor:pointer; }
    .chat-box { display:flex; flex-direction:column; padding:20px; padding-bottom:70px; max-height:calc(100vh - 160px); overflow-y:auto; background:#fff; }
    .message { margin:12px 0; max-width:70%; position:relative; overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; }
    .message.user   { align-self:flex-end; }
    .message.bot    { align-self:flex-start; }
    .message.user .content { background:#d0ecff; color:#000; }
    .message.bot  .content  { background:#fff; color:#000; border:1px solid #ddd; }
    .content { padding:10px 15px; border-radius:20px; }
    .timestamp { font-size:12px; color:#888; margin-top:4px; text-align:right; }
    .thinking { font-style:italic; color:#888; margin:12px 0; text-align:center; }
    form { display:flex; padding:15px; background:#fff; border-top:1px solid #ccc; position:fixed; bottom:0; left:0; right:0; }
    textarea {
      flex: 1;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
      resize: none;
      height: 32px;
      line-height: 18px;
    }
    button { background:#007bff; color:#fff; border:none; padding:10px 20px; margin-left:10px; border-radius:20px; font-size:16px; cursor:pointer; }
    .sidebar { position:fixed; top:0; left:-100%; width:80%; height:100%; background:#fff; z-index:100; box-shadow:2px 0 10px rgba(0,0,0,0.2); transition:left .3s ease; padding:20px; }
    .sidebar.active { left:0; }
    .menu-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .chat-list { list-style:none; padding:0; margin:0; overflow-y:auto; max-height:calc(100% - 60px); }
    .chat-list li { padding:8px; border-radius:5px; cursor:pointer; transition:background .2s; margin-bottom:10px; }
    .chat-list li:hover { background:#f0f0f0; }
    /* Code Modal Styles */
    .code-modal { background:#000; color:#e0e0e0; font-family:Menlo, monospace; padding:20px; border-radius:12px; margin:20px 0; max-width:90%; position:relative; overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; }
    .code-modal .copy-btn { position:absolute; top:10px; right:10px; background:#007bff; color:#fff; border:none; border-radius:4px; padding:6px 10px; font-size:14px; cursor:pointer; }
    .code-modal .copy-btn:hover { background:#0056b3; }
  </style>
</head>
<body>
  <header>
    <div class="menu-btn" onclick="toggleSidebar()">☰</div>
    TF-Chat
  </header>
  <div class="sidebar" id="sidebar">
    <div class="menu-header"><h3>Chats</h3><button onclick="newChat()">Nouveau Chat</button></div>
    <ul class="chat-list" id="chatList"></ul>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <form id="chatForm">
    <textarea id="userInput" placeholder="TF-chat le meilleiur asistence"></textarea>
    <button type="submit">➤</button>
  </form>

  <script>
    // Request notifications permission
    if (Notification && Notification.permission !== 'granted') Notification.requestPermission();

    const STORAGE_KEY = 'tfai_sessions';
    let sessions = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    let currentSession = sessions.length?0:null;

    // JSON QA pool loaded from index.json -> list of json files
    let qaPool = []; // array of { question: string, answers: [string,...] }

    function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(sessions));}
    function toggleSidebar(){document.getElementById('sidebar').classList.toggle('active');}
    function newChat(){sessions.unshift({title:'Nouveau Chat',messages:[]});currentSession=0;save();renderList();renderBox();toggleSidebar();}
    function renderList(){const l=document.getElementById('chatList');l.innerHTML='';sessions.forEach((s,i)=>{let li=document.createElement('li');li.textContent=s.title;li.onclick=()=>{currentSession=i;renderBox();toggleSidebar();};l.appendChild(li);});}
    function renderBox(){const box=document.getElementById('chatBox');box.innerHTML='';if(currentSession===null){box.innerHTML='<div style="padding:20px;color:#666">Aucun chat — cliquez Nouveau Chat pour commencer</div>';return;}const sess=sessions[currentSession];sess.messages.forEach(m=>{let wrap=document.createElement('div');wrap.className=m.sender==='thinking'? 'thinking' : 'message '+m.sender; if(m.sender==='thinking'){wrap.textContent=m.text;} else if(typeof m.text==='string' && m.text.startsWith('```')&&m.text.endsWith('```')){let content=m.text.slice(3,-3);let modal=document.createElement('div');modal.className='code-modal';modal.textContent=content;let btn=document.createElement('button');btn.className='copy-btn';btn.textContent='Copy';btn.onclick=()=>{navigator.clipboard.writeText(content);btn.textContent='✔️';setTimeout(()=>btn.textContent=' Copy',1000);} ;modal.appendChild(btn);wrap.appendChild(modal);} else{let c=document.createElement('div');c.className='content';c.textContent=m.text;wrap.appendChild(c);if(m.sender==='bot'&&m.ts){let ts=document.createElement('div');ts.className='timestamp';ts.textContent=`${Math.floor((Date.now()-m.ts)/1000)}s`;wrap.appendChild(ts);} }box.appendChild(wrap);});box.scrollTop=box.scrollHeight;}

    // Utility: pick random element (kept for dev use)
    function rand(arr){return arr[Math.floor(Math.random()*arr.length)];}

    // Load index.json and all listed json files
    async function loadIndexAndQA(){
      qaPool = [];
      try{
        const res = await fetch('./index.json', {cache: 'no-store'});
        if(!res.ok) throw new Error('Impossible de charger index.json: '+res.status);
        const idx = await res.json();
        const files = Array.isArray(idx) ? idx : (Array.isArray(idx.files) ? idx.files : []);
        if(files.length===0) return console.warn('index.json vide ou mal formaté');
        await Promise.all(files.map(async (f) => {
          try{
            const r = await fetch('./'+f, {cache: 'no-store'});
            if(!r.ok) { console.warn('Fichier non chargé', f); return; }
            const data = await r.json();
            let items = [];
            if(Array.isArray(data)) items = data;
            else if(Array.isArray(data.qa)) items = data.qa;
            else if(Array.isArray(data.questions)) items = data.questions;
            else return;

            items.forEach(it => {
              if(!it) return;
              const question = it.question || it.q || it.prompt || it.text;
              let answers = [];
              if(Array.isArray(it.answers)) answers = it.answers;
              else if(Array.isArray(it.responses)) answers = it.responses;
              else if(typeof it.answer==='string') answers = [it.answer];
              else if(Array.isArray(it)) answers = it; // fallback
              if(question && answers.length) qaPool.push({question, answers});
            });
          }catch(e){console.warn('Erreur en lisant', f, e);}
        }));
        console.log('QA pool chargé. Entrées:', qaPool.length);
      }catch(err){console.error('Erreur loadIndexAndQA', err);}    
    }

    // --- Normalization & Levenshtein (for fuzzy matching) ---
    function normalizeText(s){
      if(!s) return '';
      return s
        .toString()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // retire aksan
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g,'') // retire ponktiyasyon
        .replace(/\s+/g,' ') // collapse spaces
        .trim();
    }

    function levenshtein(a, b) {
      if (a === b) return 0;
      const al = a.length, bl = b.length;
      if (al === 0) return bl;
      if (bl === 0) return al;
      let v0 = new Array(bl + 1), v1 = new Array(bl + 1);
      for (let i = 0; i <= bl; i++) v0[i] = i;
      for (let i = 0; i < al; i++) {
        v1[0] = i + 1;
        for (let j = 0; j < bl; j++) {
          const cost = a[i] === b[j] ? 0 : 1;
          v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
        }
        [v0, v1] = [v1, v0];
      }
      return v0[bl];
    }

    // --- Find best matching QA entry (exact first, then include, then fuzzy) ---
    function findBestQA(userText){
      if(!userText || qaPool.length===0) return null;
      const normInput = normalizeText(userText);

      // 1) exact match
      for(const e of qaPool){
        const qnorm = normalizeText(e.question || '');
        if(qnorm && qnorm === normInput) return { entry: e, type: 'exact' };
      }

      // 2) includes (question contains input or input contains question)
      for(const e of qaPool){
        const qnorm = normalizeText(e.question || '');
        if(qnorm.includes(normInput) || normInput.includes(qnorm)) return { entry: e, type: 'include' };
      }

      // 3) fuzzy via Levenshtein similarity
      let best = null;
      let bestScore = -1;
      for(const e of qaPool){
        const qnorm = normalizeText(e.question || '');
        if(!qnorm) continue;
        const dist = levenshtein(normInput, qnorm);
        const maxLen = Math.max(normInput.length, qnorm.length);
        const sim = maxLen === 0 ? 1 : (1 - dist / maxLen); // 0..1
        if(sim > bestScore){ bestScore = sim; best = e; }
      }

      // threshold for fuzzy (adjustable)
      if(best && bestScore >= 0.50) return { entry: best, type: 'fuzzy', score: bestScore };
      return null;
    }

    // --- produce deterministic answer for user input ---
    function produceAnswerFor(userText){
  if(qaPool.length===0) return 'Aucun contenu QA chargé. Vérifiez index.json et les fichiers référencés.';
  const match = findBestQA(userText);
  if(!match) return "Mwen pa jwenn yon kesyon ki sanble. Eseye ekri li menm jan li ye nan fichye JSON la.";
  const answers = match.entry.answers || match.entry.responses || [];
  if(answers.length === 0) return "(Kesyon jwenn men pa gen repons nan JSON la.)";
  return answers.join('\n');
    }

    // Form submit handler now uses deterministic produceAnswerFor
    document.getElementById('chatForm').addEventListener('submit',async e=>{
      e.preventDefault();
      let ta=document.getElementById('userInput'),text=ta.value.trim();
      if(!text)return;
      if(currentSession===null) newChat();
      let sess=sessions[currentSession];
      sess.messages.push({sender:'user',text,ts:Date.now()});
      // set title from first message if present
      if(sess.messages[0] && typeof sess.messages[0].text === 'string') sess.title = sess.messages[0].text.slice(0,100);
      save();renderList();renderBox();ta.value='';

      let thinking={sender:'thinking',text:'*TF-Chat*'};
      sess.messages.push(thinking);renderBox();
      await new Promise(r=>setTimeout(r,700));
      // remove thinking
      sess.messages = sess.messages.filter(m=>m!==thinking);

      // produce deterministic answer for user input
      let botText = produceAnswerFor(text);
      let botMsg = {sender:'bot',text:botText,ts:Date.now()};
      sess.messages.push(botMsg);
      save();renderBox();
      if(document.hidden&&Notification.permission==='granted') new Notification('TF-Chat',{body:'Nouvo mesaj TF-Chat'});
    });

    // Allow Enter to insert newline; keep previous behaviour (Enter inserts newline)
    document.getElementById('userInput').addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){
        e.preventDefault();
        let t=e.target,s=t.selectionStart;let v=t.value;
        t.value=v.slice(0,s)+'\n'+v.slice(s);t.selectionStart=t.selectionEnd=s+1;
      }
    });

    // Initial render
    if(sessions.length) renderList(), renderBox();

    // Load index and QA on startup
    loadIndexAndQA();

    // Optional: expose a reload button via console for devs
    window.reloadQA = loadIndexAndQA;
  </script>
</body>
  </html>
