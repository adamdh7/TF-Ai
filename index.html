<!doctype html>
<html lang="ht">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>TF-Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000000;--panel:#000000;--text:#e6eefb;--muted:#9aa6bf;--card:#0b0b0b;--accent:#0b81ff;--header-h:56px}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Roboto,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    header{position:fixed;left:0;right:0;top:0;height:var(--header-h);display:flex;align-items:center;justify-content:center;background:var(--panel);z-index:1000;border-bottom:1px solid rgba(255,255,255,0.03)}
    .app-title{font-weight:700;font-size:18px}
    main{position:fixed;left:0;right:0;top:var(--header-h);bottom:0;overflow:auto;padding:12px}
    .search{padding:6px 0}
    .search-box{display:flex;align-items:center;gap:8px;background:var(--card);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}
    .search-box input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:15px}
    .list{margin-top:12px}
    .contact{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer}
    .avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:var(--text);flex-shrink:0}
    .meta{flex:1;min-width:0}
    .meta-top{display:flex;justify-content:space-between;align-items:flex-start}
    .name{font-weight:600;font-size:16px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .time{font-size:12px;color:var(--muted)}
    .meta-bottom{display:flex;justify-content:space-between;margin-top:6px;align-items:center}
    .snippet{font-size:13px;color:var(--muted);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .badge{background:var(--accent);color:white;padding:4px 8px;border-radius:999px;font-weight:600;font-size:13px}
    .messages{padding:12px;height:calc(100% - 56px - 84px);overflow:auto;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:74%;padding:10px;border-radius:12px;margin-bottom:4px}
    .msg.bot{background:#121212;color:var(--text);align-self:flex-start}
    .msg.user{background:linear-gradient(180deg,var(--accent),#0563c9);color:white;align-self:flex-end}
    .chat-input{display:flex;gap:8px;align-items:center}
    .input{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:var(--card);color:var(--text);outline:none}
    .send-btn{background:transparent;border:0;padding:8px;border-radius:10px;cursor:pointer;color:var(--accent)}
    .muted{text-align:center;color:var(--muted);padding:20px}
    .bottom-right { position: fixed; right: 16px; bottom: 16px; z-index: 1100; display:flex; gap:8px; align-items:center; }
    .ws-indicator{font-size:12px;color:var(--muted);margin-right:8px}
    @media (min-width:900px){main{max-width:700px;margin:0 auto}}
  </style>
</head>
<body>
  <header><div class="app-title">TF-Chat</div></header>

  <main>
    <section class="search">
      <div class="search-box">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
        <input id="searchInput" placeholder="Recherche (TFID ou 7 chif)" aria-label="Recherche" />
        <button id="clearSearch" type="button" style="display:none;background:transparent;border:0;color:var(--muted);cursor:pointer">✖</button>
      </div>
    </section>

    <section class="list" id="contactsList" aria-live="polite"></section>

    <div class="bottom-right">
      <div class="ws-indicator" id="wsStatus">WS: —</div>
      <button id="settingsBtn" class="send-btn">Paramètres</button>
    </div>
  </main>

  <!-- Chat modal -->
  <div id="chatModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:1200">
    <div style="height:100%;display:flex;flex-direction:column">
      <div style="height:56px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <button id="chatBack" style="background:transparent;border:0;color:var(--text);cursor:pointer">←</button>
        <div style="flex:1;text-align:center;font-weight:700" id="chatTitle">Chat</div>
        <div style="width:44px"></div>
      </div>
      <div style="overflow:auto;padding:12px;flex:1">
        <div class="messages" id="messages"></div>
      </div>
      <div style="padding:12px;border-top:1px solid rgba(255,255,255,0.03)">
        <div class="chat-input">
          <input id="chatText" class="input" placeholder="Ekri mesaj..." autocomplete="off" />
          <button id="sendBtn" class="send-btn">Envoyer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal (uses fields from the FR UI logic) -->
  <div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:1200">
    <div style="height:100%;display:flex;flex-direction:column">
      <div style="height:56px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <button id="settingsClose" style="background:transparent;border:0;color:var(--text);cursor:pointer">←</button>
        <div style="flex:1;text-align:center;font-weight:700">Paramètres</div>
        <div style="width:44px"></div>
      </div>
      <div style="padding:12px;flex:1;overflow:auto">
        <div style="display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)">
          <div id="settingsAvatar" style="width:72px;height:72px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;color:var(--text)"></div>
          <div>
            <div id="settingsName" style="font-weight:800">Utilisateur</div>
            <div id="settingsTfid" style="color:var(--muted)">TF-0000000</div>
          </div>
        </div>

        <div style="margin-top:16px">
          <label style="color:var(--muted)">Modifier non</label>
          <input id="profileNameInput" class="input" style="margin-top:6px;width:100%;background:var(--card)" />
        </div>

        <div style="margin-top:12px">
          <label style="color:var(--muted)">TFID (7 chif) — pa egzanp: 1234567</label>
          <input id="profileTfidInput" class="input" style="margin-top:6px;width:100%;background:var(--card)" />
          <div style="margin-top:8px;color:var(--muted);font-size:13px">Sere TFID tankou TF-XXXXXXX. Sistèm lan konvèti otomatikman pou 17-chif lè sa nesesè.</div>
        </div>

        <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
          <button id="profileSave" class="send-btn">Sove</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   MERGED SCRIPT
   - UI = dark HTML/CSS (HT)
   - Logic/settings = FR script (me, WS_URL, ADMIN_API_TOKEN, register/frontend ...)
   Notes: adapted to use existing dark element IDs (searchInput, contactsList, messages, chatText, sendBtn, settings modal fields)
   ========================= */

/* ====== CONFIG ====== */
const API_BASE = 'https://tf-sove.onrender.com';
const FRONTEND_NAME = 'site1';
const ADMIN_API_TOKEN = 'tfstream_45dd9c02d4e34f18a42d';
const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + "tf-sove.onrender.com/ws";

/* ====== HELPERS ====== */
function normalizeInputToDigits(inp){ if(!inp) return null; const s=String(inp).trim().toUpperCase(); const digits=s.replace(/[^0-9]/g,''); return digits||null; }
function to17(shortOrDigits){ if(!shortOrDigits) return null; const ds=String(shortOrDigits); if(ds.length>17) return ds.slice(-17); return ds.padStart(17,'0'); }
function formatTFShort(digitsString){ if(!digitsString) return ''; const s=String(digitsString); const last7 = s.slice(-7); return 'TF-'+ last7.padStart(7,'0'); }
function nowISO(){ return (new Date()).toISOString(); }
function fmtTime(iso){ try{ const d=new Date(iso); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}catch(e){return '';} }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function makeCid(){ return String(Date.now()) + '-' + Math.floor(Math.random()*100000).toString(16); }

/* ====== STORAGE & STATE ====== */
/* We'll store user (me) under tfchat.* keys (from FR UI) so the "parameters" behaviour is preserved */
let me = {
  short: localStorage.getItem('tfchat.me.short') || null,
  tf17: localStorage.getItem('tfchat.me.17') || null,
  name: localStorage.getItem('tfchat.me.name') || 'Utilisateur',
  avatarDataUrl: localStorage.getItem('tfchat.me.avatar') || null
};
let contacts = JSON.parse(localStorage.getItem('tfchat.contacts') || '[]');
let ws = null;
let reconnectTimer = null;
let currentPartner = null;
const conversationCache = {}; // 'me|other' -> messages array

/* ====== DOM refs (dark UI IDs are used) ====== */
const searchInputEl = document.getElementById('searchInput');
const clearSearchEl = document.getElementById('clearSearch');
const contactsListEl = document.getElementById('contactsList');

const chatModalEl = document.getElementById('chatModal');
const messagesEl = document.getElementById('messages');
const chatTitleEl = document.getElementById('chatTitle');
const chatTextEl = document.getElementById('chatText');
const sendBtnEl = document.getElementById('sendBtn');
const chatBack = document.getElementById('chatBack');

const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsClose = document.getElementById('settingsClose');
const settingsAvatar = document.getElementById('settingsAvatar');
const settingsName = document.getElementById('settingsName');
const settingsTfid = document.getElementById('settingsTfid');
const profileNameInput = document.getElementById('profileNameInput');
const profileTfidInput = document.getElementById('profileTfidInput');
const profileSave = document.getElementById('profileSave');

const wsStatusEl = document.getElementById('wsStatus');

/* ====== save/load helpers ====== */
function saveState(){
  localStorage.setItem('tfchat.me.short', me.short || '');
  localStorage.setItem('tfchat.me.17', me.tf17 || '');
  localStorage.setItem('tfchat.me.name', me.name || '');
  if(me.avatarDataUrl) localStorage.setItem('tfchat.me.avatar', me.avatarDataUrl);
  localStorage.setItem('tfchat.contacts', JSON.stringify(contacts || []));
}

function initials(name){ if(!name) return 'U'; return name.split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase(); }

/* ====== render helpers ====== */
function updateSettingsUI(){
  settingsAvatar.textContent = initials(me.name || me.tf17);
  settingsName.textContent = me.name || 'Utilisateur';
  settingsTfid.textContent = me.tf17 || '';
  profileNameInput.value = me.name || '';
  profileTfidInput.value = (me.tf17 || '').replace(/^TF-?/i, '').slice(-7);
}
function renderContacts(filter=''){
  contactsListEl.innerHTML = '';
  const q = (filter||'').toLowerCase().trim();
  const list = contacts.filter(c => {
    if(!q) return true;
    return (c.name||'').toLowerCase().includes(q) || (c.tf17||'').toLowerCase().includes(q);
  });
  if(list.length === 0){
    const div = document.createElement('div');
    div.className = 'muted';
    div.textContent = 'Pa gen kontak. Rechèch yon TFID oswa ajoute yon kontak.';
    contactsListEl.appendChild(div);
    return;
  }
  list.forEach(c => {
    const el = document.createElement('div'); el.className = 'contact'; el.dataset.tf17 = c.tf17 || c.tf17;
    const avatarHtml = c.logo ? `<img src="${c.logo}" style="width:100%;height:100%;border-radius:50%">` : escapeHtml((c.name||formatTFShort(c.tf17) || '').slice(0,2));
    el.innerHTML = `<div class="avatar">${avatarHtml}</div>
      <div class="meta">
        <div class="meta-top">
          <div class="name">${escapeHtml(c.name||formatTFShort(c.tf17)||'')}</div>
          <div class="time">${c.lastTs? timeAgo(c.lastTs): ''}</div>
        </div>
        <div class="meta-bottom">
          <div class="snippet">${escapeHtml(c.lastMsg||'')}</div>
          <div>${c.unread?'<span class="badge">'+c.unread+'</span>':''}</div>
        </div>
      </div>`;
    el.addEventListener('click', ()=> { openChat(c.tf17, c); });
    contactsListEl.appendChild(el);
  });
}

/* timeAgo (small util) */
function timeAgo(ts){ if(!ts) return ''; const diff=Math.floor((Date.now()-ts)/1000); if(diff<60) return diff+'s'; if(diff<3600) return Math.floor(diff/60)+'m'; if(diff<86400) return Math.floor(diff/3600)+'h'; return new Date(ts).toLocaleDateString(); }

/* ====== HTTP helpers ====== */
async function callJSON(url, opts = {}) {
  opts = Object.assign({}, opts);
  opts.headers = Object.assign({}, opts.headers || {}, { 'Accept': 'application/json' });
  try {
    const r = await fetch(url, opts);
    const text = await r.text();
    let json = null;
    try{ json = JSON.parse(text); }catch(e){}
    return { ok: r.ok, status: r.status, json, text };
  } catch (err) {
    return { ok: false, error: err.message };
  }
}

async function apiList(tf17){
  const url = `${API_BASE}/api/list?tfid=${encodeURIComponent(tf17)}&name=${encodeURIComponent(FRONTEND_NAME)}`;
  const r = await callJSON(url);
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  return r.json.rows || [];
}

async function apiAdd(recipient17, contentObj){
  const body = { tfid: recipient17, name: FRONTEND_NAME, content: JSON.stringify(contentObj), source_url: location.origin };
  const url = `${API_BASE}/api/add`;
  const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  return r.json;
}

async function registerFrontendIfNeeded(){
  try {
    const url = `${API_BASE}/admin/register-frontend`;
    const payload = { name: FRONTEND_NAME, callback_url: location.origin };
    const r = await callJSON(url, { method:"POST", headers:{"Content-Type":"application/json","x-api-token": ADMIN_API_TOKEN}, body: JSON.stringify(payload) });
    return r.ok;
  } catch(e){ return false; }
}

/* ====== conversation caching & rendering (light logic) ====== */
function convKey(a,b){ return `${a}|${b}`; }
function addOrUpdateMessageToCache(me17, other17, msg){
  const key = convKey(me17, other17);
  if(!conversationCache[key]) conversationCache[key] = [];
  const list = conversationCache[key];
  // dedupe by cid or id
  const findIndex = msg.cid ? list.findIndex(x => x.cid && x.cid === msg.cid) : (msg.id ? list.findIndex(x => x.id && String(x.id) === String(msg.id)) : -1);
  if(findIndex !== -1){
    list[findIndex] = Object.assign({}, list[findIndex], msg);
  } else {
    list.push(msg);
  }
  list.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
}

async function loadConversation(me17, other17){
  const key = convKey(me17, other17);
  conversationCache[key] = conversationCache[key] || [];
  const seen = new Set();

  function pushRow(r, expectedFrom){
    let parsed = null;
    try { parsed = JSON.parse(r.content); } catch(e){ parsed = null; }
    const parsedFrom = parsed && parsed.from ? parsed.from : null;
    const parsedTime = parsed && parsed.time ? parsed.time : null;
    const parsedCid = parsed && parsed.cid ? parsed.cid : null;
    const parsedText = parsed && (parsed.text || parsed.message) ? (parsed.text || parsed.message) : (r.content || "");
    if(!parsedFrom || parsedFrom !== expectedFrom) return;
    const m = {
      id: r.id || null,
      cid: parsedCid || null,
      from: parsedFrom,
      text: parsedText,
      created_at: parsedTime || r.created_at || nowISO()
    };
    const keyu = (m.cid ? 'cid:'+m.cid : (m.id ? 'id:'+m.id : Math.random().toString(36)));
    if(seen.has(keyu)) return;
    seen.add(keyu);
    addOrUpdateMessageToCache(me17, other17, m);
  }

  // outgoing (messages I sent stored under other17)
  try {
    const outRows = await apiList(other17);
    for(const r of outRows) pushRow(r, me17);
  } catch(e){ console.warn('LIST outgoing failed', e); }

  // incoming (messages stored under me17)
  try {
    const inRows = await apiList(me17);
    for(const r of inRows) pushRow(r, other17);
  } catch(e){ console.warn('LIST incoming failed', e); }

  renderConversation(me17, other17);
}

function renderConversation(me17, other17){
  const key = convKey(me17, other17);
  const arr = conversationCache[key] ? [...conversationCache[key]] : [];
  messagesEl.innerHTML = '';
  if(arr.length === 0){
    messagesEl.innerHTML = `<div class="muted">Pa gen mesaj ankò.</div>`;
  } else {
    arr.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
    for(const m of arr){
      const d = document.createElement('div');
      d.className = 'msg ' + (m.from === me17 ? 'user' : 'bot');
      const ts = m.created_at ? (new Date(m.created_at)).toLocaleString() : '';
      d.innerHTML = `<div>${escapeHtml(m.text)}</div><div style="font-size:11px;color:var(--muted);margin-top:6px">${formatTFShort(m.from||'')} • ${ts}</div>`;
      messagesEl.appendChild(d);
    }
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ====== Open chat (adapted for modal) ====== */
async function openChat(other17, contactObj=null){
  if(!me.tf17){
    if(!await promptForMe()) return;
  }
  currentPartner = { tf17: other17, name: (contactObj && contactObj.name) || null };
  chatTitleEl.textContent = (currentPartner.name || formatTFShort(currentPartner.tf17));
  // mark read
  const c = contacts.find(x => x.tf17 === other17);
  if(c){ c.unread = 0; saveState(); renderContacts(); }
  messagesEl.innerHTML = '<div class="muted">Chaje mesaj...</div>';
  try {
    await loadConversation(me.tf17, other17);
  } catch(e){
    messagesEl.innerHTML = `<div class="muted">Pa kapab chaje mesaj: ${escapeHtml(e.message||e)}</div>`;
  }
  showChatModal();
}

/* Chat modal show/hide */
function showChatModal(){ chatModalEl.style.display = 'block'; setTimeout(()=> chatTextEl?.focus(), 150); }
function hideChatModal(){ chatModalEl.style.display = 'none'; currentPartner = null; }

/* ====== send message from modal ====== */
async function sendMessageFromModal(){
  const txt = (chatTextEl?.value || '').trim();
  if(!txt || !currentPartner) return;
  if(!me.tf17){ alert('Pa gen TFID pou itilizatè a. Mete li nan Paramètres.'); return; }
  const recipient17 = currentPartner.tf17;
  const cid = makeCid();
  const payload = { type:'text', from: me.tf17, text: txt, time: (new Date()).toISOString(), cid };
  // optimistic
  addOrUpdateMessageToCache(me.tf17, recipient17, { id:null, cid, from: me.tf17, text: txt, created_at: payload.time });
  renderConversation(me.tf17, recipient17);
  chatTextEl.value = '';
  // update contact preview
  const c = contacts.find(x=>x.tf17===recipient17);
  if(c){ c.lastMsg = txt; c.lastTs = Date.now(); saveState(); renderContacts(); }
  try {
    await apiAdd(recipient17, payload);
    // short poll to reconcile
    startShortPollForMessage(recipient17, cid);
  } catch(e){
    alert('Envoi echwe: ' + (e.message||e));
  }
}

function startShortPollForMessage(target17, cid){
  let tries = 0;
  const maxTries = 6;
  const interval = 1200;
  const attempt = async ()=>{
    tries++;
    try {
      const rows = await apiList(target17);
      const found = rows.find(r => {
        try { const p = JSON.parse(r.content); return p && p.cid === cid; } catch(e){ return false; }
      });
      if(found){ await loadConversation(me.tf17, target17); return true; }
    } catch(e){}
    if(tries < maxTries) setTimeout(attempt, interval);
  };
  attempt();
}

/* ====== ensure contact list helpers ====== */
function ensureContactInList(tf17, name){
  let c = contacts.find(x => x.tf17 === tf17);
  if(!c){ c = { tf17, name: name||null, lastMsg:'', lastTs: Date.now(), unread:0 }; contacts.unshift(c); saveState(); renderContacts(); }
  return c;
}

/* ====== prompt for me (TFID) ====== */
async function promptForMe(){
  const v = prompt('Entrer votre TFID (ex: TF-0204143 ou 0204143).');
  if(!v) return false;
  const digits = normalizeInputToDigits(v);
  if(!digits){ alert('TFID invalide'); return false; }
  me.short = digits.slice(-7);
  me.tf17 = to17(me.short);
  saveState();
  updateSettingsUI();
  if(ws){ try{ ws.close(); }catch(e){} }
  connectWS();
  return true;
}

/* ====== WebSocket logic (from FR UI, adapted) ====== */
function connectWS(){
  if(!me.tf17){ wsStatusEl.textContent = 'WS: non connecté (pas de TFID)'; return; }
  try {
    ws = new WebSocket(WS_URL);
  } catch(e){ scheduleReconnect(); return; }
  ws.onopen = ()=>{
    wsStatusEl.textContent = 'WS: connecté';
    try{ ws.send(JSON.stringify({ type:'subscribe', tfid: me.tf17 })); } catch(e){}
  };
  ws.onmessage = (ev)=>{
    try {
      const data = JSON.parse(ev.data);
      if(data.type === 'subscribed') return;
      if(data.type === 'message'){
        const payload = data;
        let parsed = null;
        try{ parsed = JSON.parse(payload.content); } catch(e){ parsed = null; }
        if(!parsed || !parsed.from) return;
        const recipient = payload.tfid || null;
        const from = parsed.from;
        const other = (recipient === me.tf17) ? from : recipient;
        if(!other) return;
        const created = parsed.time || payload.created_at || nowISO();
        const msgObj = { id: payload.id || null, cid: parsed.cid || null, from, text: parsed.text || parsed.message || '', created_at: created };
        addOrUpdateMessageToCache(me.tf17, other, msgObj);
        // update UI
        if(currentPartner && currentPartner.tf17 === other){
          renderConversation(me.tf17, other);
        } else if(recipient === me.tf17){
          const c = ensureContactInList(other, null);
          c.unread = (c.unread||0) + 1;
          c.lastMsg = msgObj.text;
          c.lastTs = Date.now();
          saveState();
          renderContacts();
        }
      }
    } catch(err){ console.warn('WS parse err', err); }
  };
  ws.onclose = ()=>{ wsStatusEl.textContent = 'WS: déconnecté'; scheduleReconnect(); };
  ws.onerror = (e)=>{ console.warn('WS error', e); wsStatusEl.textContent = 'WS: erreur'; try{ ws.close(); }catch(e){} };
}

function scheduleReconnect(){ if(reconnectTimer) return; reconnectTimer = setTimeout(()=>{ reconnectTimer=null; connectWS(); }, 3000); }

/* ====== UI event bindings ====== */
chatBack?.addEventListener('click', ()=> hideChatModal());
sendBtnEl?.addEventListener('click', sendMessageFromModal);
chatTextEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessageFromModal(); } });

searchInputEl?.addEventListener('input', (e)=>{ renderContacts(e.target.value); clearSearchEl.style.display = e.target.value ? 'inline-block' : 'none'; });
clearSearchEl?.addEventListener('click', ()=>{ searchInputEl.value=''; renderContacts(); clearSearchEl.style.display='none'; searchInputEl.focus(); });

searchInputEl?.addEventListener('keydown', async (e)=>{
  if(e.key !== 'Enter') return;
  const raw = searchInputEl.value.trim();
  if(!raw) return;
  const digits = normalizeInputToDigits(raw);
  if(!digits){ renderContacts(raw); return; }
  if(digits.length < 7){ alert('TFID dwe gen omwen 7 chif.'); return; }
  const short7 = digits.slice(-7);
  const tf17 = to17(short7);
  // check local
  let local = contacts.find(c => c.tf17 === tf17);
  if(local){ openChat(local.tf17, local); return; }
  // call server
  try {
    const rows = await apiList(tf17);
    if(rows && rows.length > 0){
      const id = 'c_' + Date.now();
      const last = rows[rows.length-1] || rows[0];
      let lastMsg = '';
      try{ const p = JSON.parse(last.content); lastMsg = p.text || p.message || last.content; } catch(e){ lastMsg = last.content || ''; }
      const c = { tf17, name: formatTFShort(short7), lastMsg, lastTs: Date.now(), unread: 0 };
      contacts.unshift(c); saveState(); renderContacts(); openChat(c.tf17, c); return;
    } else {
      if(confirm('Pa jwenn done sou servèr. Kreye kontak lokal pou TFID sa a?')){
        const c = { tf17, name: formatTFShort(short7), lastMsg: '', lastTs: Date.now(), unread:0 };
        contacts.unshift(c); saveState(); renderContacts(); openChat(c.tf17, c);
      }
    }
  } catch(err){ alert('Erè lè w ap chèche sou servèr: ' + (err.message||err)); }
});

/* Settings modal open/close and save */
settingsBtn?.addEventListener('click', ()=> { updateSettingsUI(); settingsModal.style.display = 'block'; });
settingsClose?.addEventListener('click', ()=> settingsModal.style.display = 'none');
profileSave?.addEventListener('click', async ()=>{
  const newName = profileNameInput.value.trim();
  const short = normalizeInputToDigits(profileTfidInput.value.trim());
  if(!short || short.length < 7){ alert('TFID pa valab — antre 7 chif.'); return; }
  me.name = newName || me.name;
  me.short = short.slice(-7);
  me.tf17 = to17(me.short);
  saveState();
  updateSettingsUI();
  settingsModal.style.display = 'none';
  // register frontend if needed and (re)connect WS
  await registerFrontendIfNeeded();
  if(ws && ws.readyState === WebSocket.OPEN){
    try{ ws.send(JSON.stringify({ type:'subscribe', tfid: me.tf17 })); }catch(e){}
  } else connectWS();
});

/* small helper used above */
function formatTFShort(digitsStringLocal){ if(!digitsStringLocal) return ''; const s=String(digitsStringLocal); const last7=s.slice(-7); return 'TF-'+ last7.padStart(7,'0'); }

/* ====== BOOT ====== */
renderContacts();
updateSettingsUI();
if(me.tf17){
  connectWS();
} else {
  // ask user to set TFID (non-blocking)
  setTimeout(()=> {
    if(confirm("Ou pa idantifye. Antre TFID kounye a?")) promptForMe();
  }, 600);
}

/* expose for debugging */
window._tf_contacts = contacts;
window._tf_me = me;
</script>
</body>
  </html>
