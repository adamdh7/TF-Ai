<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TF-Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000000; --panel:#000000; --text:#e6eefb; --muted:#9aa6bf;
  --card:#0b0b0b; --accent:#0b81ff; --header-h:56px; --tab-h:60px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Roboto,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
header{position:fixed;left:0;right:0;top:0;height:var(--header-h);display:flex;align-items:center;justify-content:center;background:var(--panel);z-index:1000;border-bottom:1px solid rgba(255,255,255,0.03)}
.app-title{font-weight:700;font-size:18px;cursor:pointer}
main{position:fixed;left:0;right:0;top:var(--header-h);bottom:calc(var(--tab-h) + 12px);overflow:auto;padding:12px}
.container{max-width:980px;margin:0 auto}
.search{padding:8px 12px;display:flex;justify-content:center}
.search-box{display:flex;align-items:center;gap:8px;background:var(--card);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);width:100%}
.search-box input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:15px}
.search-btn{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.list{margin-top:12px}
.contact{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer}
.contact:hover{background:rgba(255,255,255,0.02)}
.avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:var(--text);flex-shrink:0;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.meta{flex:1;min-width:0}
.meta-top{display:flex;justify-content:space-between;align-items:flex-start}
.name{font-weight:600;font-size:16px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.time{font-size:12px;color:var(--muted)}
.meta-bottom{display:flex;justify-content:space-between;margin-top:6px;align-items:center}
.snippet{font-size:13px;color:var(--muted);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.badge{background:var(--accent);color:white;padding:4px 8px;border-radius:999px;font-weight:600;font-size:13px}
.messages-wrap{padding:12px;height:calc(100% - 56px - 84px);overflow:auto;display:flex;flex-direction:column;gap:8px}
.messages{display:flex;flex-direction:column;gap:8px}
.msg{max-width:74%;padding:10px;border-radius:12px;margin-bottom:4px}
.msg.bot{background:#121212;color:var(--text);align-self:flex-start}
.msg.user{background:linear-gradient(180deg,var(--accent),#0563c9);color:white;align-self:flex-end}
.msg .checks{font-size:11px;margin-left:8px;opacity:0.9}
.chat-input{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:transparent}
.input{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:var(--card);color:var(--text);outline:none}
.send-btn{background:transparent;border:0;padding:8px;border-radius:10px;cursor:pointer;color:var(--accent)}
.muted{text-align:center;color:var(--muted);padding:20px}
.bottom-right { position: fixed; right: 16px; bottom: 88px; z-index: 1100; display:flex; gap:8px; align-items:center; }
.ws-indicator{display:none}
@media (min-width:900px){ main{max-width:700px;margin:0 auto} .container{max-width:700px} }
.tabs{position:fixed;left:0;right:0;bottom:0;height:var(--tab-h);display:flex;border-top:1px solid rgba(255,255,255,0.03);background:var(--panel);align-items:center;justify-content:center;gap:20px;z-index:1200}
.tab-btn{background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700}
.tab-btn.active{color:var(--text);background:rgba(255,255,255,0.02)}
.tab-count{font-size:12px;color:var(--muted);margin-left:6px}
.group-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer;background:var(--card);margin-bottom:8px}
.group-avatar{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:var(--text);overflow:hidden}
.group-meta{flex:1}
.group-name{font-weight:700}
.group-bio{font-size:13px;color:var(--muted);margin-top:6px}
.modal-full { position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; z-index:1400; background:rgba(0,0,0,0.85); padding-top:56px; }
.modal-panel { width:100%; max-width:520px; background:#0b0b0b; color:var(--text); border-radius:12px; padding:16px; margin:20px; }
.settings-panel{width:100%; max-width:420px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(11,18,32,0.2);color:#0b1220}
.profile-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1400; background:rgba(0,0,0,0.6); }
.profile-card { width:320px; background:#fff; color:#0b1220; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
.profile-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.profile-avatar{width:64px;height:64px;border-radius:12px;background:#cbd5e1;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
.profile-avatar img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.small{font-size:12px;color:var(--muted)}
#chatModal .messages-wrap { height: calc(100% - 56px - 64px - 24px); }
@media (max-width:420px){ .avatar, .group-avatar{ width:48px; height:48px } .profile-avatar{ width:56px; height:56px; } }
</style>
</head>
<body>
  <header><div class="app-title">TF-Chat</div></header>

  <div class="banner" id="pwBanner">Tanpri mete yon modpas pou sekirize sesyon ou. Ou gen 2 min pou sove li.</div>

  <main>
    <div class="container" id="viewContainer">
      <section class="search" id="searchSection">
        <div class="search-box" role="search">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
          <input id="searchInput" placeholder="Recherche (TFID ou 7 chif)" aria-label="Recherche" />
          <button id="searchBtn" class="search-btn">Rechercher</button>
        </div>
      </section>

      <section class="list" id="contactsList" aria-live="polite"></section>

      <section class="list" id="groupsList" aria-live="polite" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-weight:700">Groupes</div>
          <button id="createGroupBtn" class="search-btn" style="padding:8px 10px">Créer</button>
        </div>
        <div id="groupsContainer"></div>
      </section>

    </div>

    <div class="bottom-right">
      <div class="ws-indicator" id="wsStatus">WS: —</div>
    </div>
  </main>

  <div id="chatModal" class="modal-full" style="display:none;">
    <div class="modal-panel" style="height:calc(100vh - 120px); display:flex; flex-direction:column;">
      <div style="height:56px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <button id="chatBack" style="background:transparent;border:0;color:var(--text);cursor:pointer">←</button>
        <div style="flex:1;text-align:center;font-weight:700;cursor:pointer" id="chatTitle">Chat</div>
        <div style="width:44px"></div>
      </div>
      <div class="messages-wrap" style="flex:1; overflow:auto;">
        <div class="messages" id="messages"></div>
      </div>
      <div class="chat-input" id="chatInputRow">
        <input id="chatText" class="input" placeholder="Ekri mesaj..." autocomplete="off" />
        <button id="sendBtn" class="send-btn">Envoyer</button>
      </div>
    </div>
  </div>

  <div id="groupModal" class="modal-full" style="display:none;align-items:center;">
    <div class="modal-panel" style="max-width:520px;background:#fff;color:#0b1220;">
      <h3 style="margin:0 0 12px 0;color:#0b1220">Créer un groupe</h3>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
        <div id="groupAvatarPreview" class="group-avatar" style="width:72px;height:72px;border-radius:12px;cursor:pointer">+</div>
        <div style="flex:1">
          <input id="groupNameInput" placeholder="Nom du groupe (obligatoire)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3" />
          <textarea id="groupBioInput" placeholder="Bio (optionnel)" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #e6eef3" rows="3"></textarea>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="groupCancelBtn" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:white;cursor:pointer">Retour</button>
        <button id="groupCreateBtn" style="padding:8px 12px;border-radius:8px;background:#007aff;color:white;border:none;cursor:pointer">Valider</button>
      </div>
    </div>
  </div>

  <div class="profile-modal" id="profileModal">
    <div class="profile-card" role="dialog" aria-modal="true">
      <div class="profile-row">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div>
          <div id="profileName" style="font-weight:800">Utilisateur</div>
          <div id="profileTfid" class="small">TF-0000000</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="addContactBtn" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:white;cursor:pointer">Ajouter</button>
        <button id="reportBtn" style="padding:8px 12px;border-radius:8px;background:#f59e0b;color:white;border:none;cursor:pointer">Signaler</button>
        <button id="blockBtn" style="padding:8px 12px;border-radius:8px;background:#ef4444;color:white;border:none;cursor:pointer">Bloquer</button>
        <button id="closeProfileBtn" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:white;cursor:pointer">Fermer</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="profile-modal" style="display:none">
    <div class="settings-panel" role="dialog" aria-modal="true">
      <h3 style="margin:0 0 12px 0">Paramètres — Identité</h3>

      <div style="margin-bottom:8px">
        <label class="settings-label">Pseudo affiché</label>
        <input id="profileNameInput" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3;margin-top:6px" />
      </div>

      <div style="margin-bottom:12px">
        <label class="settings-label">TFID (7 chif) — ex: 0204143</label>
        <input id="profileTfidInput" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3;margin-top:6px" />
        <div style="font-size:12px;color:#6b7280;margin-top:6px">Sere TFID tankou TF-XXXXXXX. Sistèm lan konvèti pou TF-17-chif otomatikman.</div>
      </div>

      <div style="margin-bottom:12px">
        <label class="settings-label">Mot de passe (créer / changer)</label>
        <input id="profilePwInput" type="password" placeholder="Nouveau mot de passe" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3;margin-top:6px" />
        <div style="font-size:12px;color:#6b7280;margin-top:6px">Le mot de passe est haché côté client et stocké localement. Ne partagez pas ce mot de passe.</div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="settingsCancel" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:white;cursor:pointer">Annuler</button>
        <button id="profileSave" style="padding:8px 12px;border-radius:8px;background:#007aff;color:white;border:none;cursor:pointer">Sove</button>
      </div>
    </div>
  </div>

  <input type="file" id="profileFile" accept="image/*" style="display:none" />
  <input type="file" id="groupFile" accept="image/*" style="display:none" />

  <div class="tabs" role="tablist">
    <button class="tab-btn active" id="tabAccueil">Accueil</button>
    <button class="tab-btn" id="tabGroup">Groupe <span id="groupCount" class="tab-count"></span></button>
  </div>

<script>
/* ================== CONFIG ================== */
const API_BASE = 'https://tf-sove.onrender.com';
/* Use backend /upload endpoint (sa a ap retounen {ok:true,url} sou servèr ofisyel nou an).
   Si w bezwen itilize tf-stream-url uploader, mete li la men fonksyon upload ap eseye plizyè cles repons. */
const PROFILE_UPLOAD_URL = `${API_BASE}/upload`;
const FRONTEND_NAME = 'site1';
/* NOTE: mete ADMIN_API_TOKEN si ou konprann eksposisyon li sou frontend (pa konseye pou prod).
   Nou kenbe li pou dev/test — men pi bon se fè group creation atravè backend-only route.
*/
const ADMIN_API_TOKEN = 'tfstream_45dd9c02d4e34f18a42d';
const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + "tf-sove.onrender.com/ws";

/* ================== HELPERS ================== */
function normalizeInputToDigits(inp){ if(!inp) return null; const s=String(inp).trim().toUpperCase(); const digits=s.replace(/[^0-9]/g,''); return digits||null; }
function to17(shortOrDigits){ if(!shortOrDigits) return null; const ds=String(shortOrDigits).replace(/[^0-9]/g,''); if(ds.length>17) return ds.slice(-17); return ds.padStart(17,'0'); }
function formatTFShort(digitsString){ if(!digitsString) return ''; const s=String(digitsString).replace(/[^0-9]/g,''); const last7 = s.slice(-7); return 'TF-'+ last7.padStart(7,'0'); }
function nowISO(){ return (new Date()).toISOString(); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function makeCid(){ return String(Date.now()) + '-' + Math.floor(Math.random()*100000).toString(16); }
function parseDatePrefer(isoOrDb, parsedTime){ const t1 = parsedTime ? Date.parse(parsedTime) : NaN; if(!isNaN(t1)) return t1; const t2 = Date.parse(isoOrDb || ""); return isNaN(t2) ? 0 : t2; }
async function hashPasswordHex(pw){ const enc = new TextEncoder(); const data = enc.encode(String(pw)); const hashBuffer = await crypto.subtle.digest('SHA-256', data); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2,'0')).join(''); }

/* Notification helpers */
function isNotificationSupported(){ return typeof window !== 'undefined' && 'Notification' in window; }
async function requestNotificationPermission(){ if(!isNotificationSupported()) return false; if(Notification.permission === 'granted') return true; if(Notification.permission === 'denied') return false; try { const p = await Notification.requestPermission(); return p === 'granted'; } catch(e){ return false; } }
function showDesktopNotification(fromNameOrTfid, fromTfid, text, onClickOpen){
  if(!isNotificationSupported()) return;
  if(Notification.permission !== 'granted') return;
  try {
    const title = 'Vous avez une nouveau message';
    const body = (fromNameOrTfid ? `${fromNameOrTfid}` : formatTFShort(fromTfid)) + (text ? ` — ${String(text).slice(0,120)}` : '');
    const n = new Notification(title, { body, tag: 'tfchat-msg-' + (fromTfid || Math.random()), renotify: false });
    n.onclick = function(ev){ try { window.focus(); } catch(e){} if(typeof onClickOpen === 'function') onClickOpen(); n.close(); };
    setTimeout(()=>{ try{ n.close(); }catch(e){} }, 6000);
  } catch(e){ console.warn('notif err', e); }
}

/* ================== STATE ================== */
let me = { short: localStorage.getItem('tfchat.me.short') || null, tf17: localStorage.getItem('tfchat.me.17') || null, name: localStorage.getItem('tfchat.me.name') || 'Utilisateur', avatarDataUrl: localStorage.getItem('tfchat.me.avatar') || null };
let contacts = JSON.parse(localStorage.getItem('tfchat.contacts') || '[]');
let groups = [];
let ws = null; let reconnectTimer = null; let currentPartner = null; let currentGroup = null;
const conversationCache = {}; let pwWarningTimer = null; let pwForceReloadTimer = null;

/* ================== DOM REFS ================== */
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const contactsListEl = document.getElementById('contactsList');
const groupsListEl = document.getElementById('groupsList');
const groupsContainer = document.getElementById('groupsContainer');
const chatModalEl = document.getElementById('chatModal');
const messagesEl = document.getElementById('messages');
const chatInputRow = document.getElementById('chatInputRow');
const chatTextEl = document.getElementById('chatText');
const sendBtnEl = document.getElementById('sendBtn');
const wsStatusEl = document.getElementById('wsStatus');
const settingsModal = document.getElementById('settingsModal');
const profileNameInput = document.getElementById('profileNameInput');
const profileTfidInput = document.getElementById('profileTfidInput');
const profilePwInput = document.getElementById('profilePwInput');
const profileSaveBtn = document.getElementById('profileSave');
const settingsCancelBtn = document.getElementById('settingsCancel');
const pwBanner = document.getElementById('pwBanner');

const profileModal = document.getElementById('profileModal');
const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const profileTfid = document.getElementById('profileTfid');
const addContactBtn = document.getElementById('addContactBtn');
const blockBtn = document.getElementById('blockBtn');
const closeProfileBtn = document.getElementById('closeProfileBtn');
const reportBtn = document.getElementById('reportBtn');
const fileInput = document.getElementById('profileFile');
const appTitleEl = document.querySelector('.app-title');

const tabAccueil = document.getElementById('tabAccueil');
const tabGroup = document.getElementById('tabGroup');
const groupsCountEl = document.getElementById('groupCount');

const groupModal = document.getElementById('groupModal');
const groupAvatarPreview = document.getElementById('groupAvatarPreview');
const groupFile = document.getElementById('groupFile');
const groupNameInput = document.getElementById('groupNameInput');
const groupBioInput = document.getElementById('groupBioInput');
const groupCancelBtn = document.getElementById('groupCancelBtn');
const groupCreateBtn = document.getElementById('groupCreateBtn');
const createGroupBtn = document.getElementById('createGroupBtn');

/* ================== STORAGE HELPERS ================== */
function saveState(){ localStorage.setItem('tfchat.me.short', me.short || ''); localStorage.setItem('tfchat.me.17', me.tf17 || ''); localStorage.setItem('tfchat.me.name', me.name || ''); if(me.avatarDataUrl) localStorage.setItem('tfchat.me.avatar', me.avatarDataUrl); localStorage.setItem('tfchat.contacts', JSON.stringify(contacts || [])); }
function initials(name){ if(!name) return 'U'; return name.split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase(); }
function pwKeyForTf(tf17){ return `tfchat.pw.${tf17}`; }
function hasPasswordFor(tf17){ return !!localStorage.getItem(pwKeyForTf(tf17)); }
function storePasswordHash(tf17, hexHash){ localStorage.setItem(pwKeyForTf(tf17), hexHash); }
function getPasswordHash(tf17){ return localStorage.getItem(pwKeyForTf(tf17)); }

/* ================== RENDER ================== */
function updateSettingsUI(){ profileNameInput.value = me.name || ''; profileTfidInput.value = (me.tf17 || '').replace(/^TF-?/i, '').slice(-7); profilePwInput.value = ''; }
function renderContacts(filter=''){
  contactsListEl.innerHTML = '';
  const q = (filter||'').toLowerCase().trim();
  const list = contacts.filter(c => { if(!q) return true; return (c.name||'').toLowerCase().includes(q) || (c.tf17||'').toLowerCase().includes(q); });
  if(list.length === 0){
    const div = document.createElement('div'); div.className = 'muted'; div.textContent = 'Pa gen kontak. Rechèch yon TFID oswa ajoute yon kontak.'; contactsListEl.appendChild(div); return;
  }
  list.forEach(c => {
    const el = document.createElement('div'); el.className = 'contact'; el.dataset.tf17 = c.tf17 || c.tf17;
    const avatarHtml = c.logo ? `<img src="${c.logo}" style="width:100%;height:100%;border-radius:50%">` : (c.avatar ? `<img src="${c.avatar}" />` : escapeHtml((c.name||formatTFShort(c.tf17) || '').slice(0,2)));
    const blockedBadge = c.blocked ? ' <span style="color:#ffdcdc;font-weight:700"> (Bloqué)</span>' : '';
    el.innerHTML = `<div class="avatar">${avatarHtml}</div>
      <div class="meta">
        <div class="meta-top">
          <div class="name">${escapeHtml(c.name||formatTFShort(c.tf17)||'')}${blockedBadge}</div>
          <div class="time">${c.lastTs? timeAgo(c.lastTs): ''}</div>
        </div>
        <div class="meta-bottom">
          <div class="snippet">${escapeHtml(c.lastMsg||'')}</div>
          <div>${c.unread?'<span class="badge">'+c.unread+'</span>':''}</div>
        </div>
      </div>`;
    el.addEventListener('click', ()=> { openChat(c.tf17, c, true); });
    contactsListEl.appendChild(el);
  });
}
function timeAgo(ts){ if(!ts) return ''; const diff=Math.floor((Date.now()-ts)/1000); if(diff<60) return diff+'s'; if(diff<3600) return Math.floor(diff/60)+'m'; if(diff<86400) return Math.floor(diff/3600)+'h'; return new Date(ts).toLocaleDateString(); }

function renderGroups(){
  groupsContainer.innerHTML = '';
  if(!groups || groups.length === 0){
    const div = document.createElement('div'); div.className = 'muted'; div.textContent = "Vous avez aucun groupe pour l'instant";
    groupsContainer.appendChild(div);
    groupsCountEl.textContent = '';
    return;
  }
  groups.forEach(g => {
    const el = document.createElement('div'); el.className = 'group-card'; el.dataset.name = g.name;
    const avatarHtml = g.avatar_url ? `<img src="${g.avatar_url}" style="width:100%;height:100%;border-radius:12px"/>` : escapeHtml((g.name||'').slice(0,2));
    el.innerHTML = `<div class="group-avatar">${avatarHtml}</div>
      <div class="group-meta">
        <div class="group-name">${escapeHtml(g.name)}</div>
        <div class="group-bio">${escapeHtml(g.bio || '')}</div>
      </div>`;
    el.addEventListener('click', ()=> { openGroup(g.name, g); });
    groupsContainer.appendChild(el);
  });
  groupsCountEl.textContent = groups.length || '';
}

/* ================== NETWORK HELPERS ================== */
async function callJSON(url, opts = {}) { opts = Object.assign({}, opts); opts.headers = Object.assign({}, opts.headers || {}, { 'Accept': 'application/json' }); try { const r = await fetch(url, opts); const text = await r.text(); let json = null; try{ json = JSON.parse(text); }catch(e){} return { ok: r.ok, status: r.status, json, text }; } catch (err) { return { ok: false, error: err.message }; } }

async function apiList(tf17){ const url = `${API_BASE}/api/list?tfid=${encodeURIComponent(tf17)}&name=${encodeURIComponent(FRONTEND_NAME)}`; const r = await callJSON(url); if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`); return r.json.rows || []; }

/* apiAddToTfids wrapper */
async function apiAddToTfids(tfids, contentObj, options = {}) {
  const body = Object.assign({}, options);
  if(Array.isArray(tfids)) body.tfid = tfids;
  else body.tfid = tfids;
  body.name = FRONTEND_NAME;
  body.content = JSON.stringify(contentObj);
  body.source_url = location.origin;
  const url = `${API_BASE}/api/add`;
  const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  return r.json;
}

async function apiAddToGroup(groupName, contentObj){
  const body = { group_name: groupName, name: FRONTEND_NAME, content: JSON.stringify(contentObj), source_url: location.origin };
  const url = `${API_BASE}/api/add`;
  const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  return r.json;
}

async function registerFrontendIfNeeded(){ try { const url = `${API_BASE}/admin/register-frontend`; const payload = { name: FRONTEND_NAME, callback_url: location.origin }; const r = await callJSON(url, { method:"POST", headers:{"Content-Type":"application/json","x-api-token": ADMIN_API_TOKEN}, body: JSON.stringify(payload) }); return r.ok; } catch(e){ return false; } }

/* Upload helper - robustly parses multiple upload response formats */
async function uploadFileToProfile(file){
  const fd = new FormData();
  fd.append('file', file);
  const resp = await fetch(PROFILE_UPLOAD_URL, { method:'POST', body: fd });
  const text = await resp.text().catch(()=>null);
  let json = null;
  try{ json = JSON.parse(text); }catch(e){}
  // Accept many possible keys returned by different uploaders
  const possibleUrls = [
    json?.url,
    json?.path,
    json?.sharePath,
    json?.data?.url,
    (json?.info && json.info.url) || null
  ].filter(Boolean);
  if(resp.ok && possibleUrls.length > 0){
    return possibleUrls[0];
  }
  // Some uploaders return ok:true + url
  if(resp.ok && json && typeof json === 'object'){
    // Try to detect nested url keys
    const keys = Object.keys(json);
    for(const k of keys){
      const v = json[k];
      if(typeof v === 'string' && v.startsWith('http')) return v;
    }
  }
  // If not ok, throw a descriptive error (include parsed JSON if available)
  const errBody = json ? JSON.stringify(json) : text || `status ${resp.status}`;
  throw new Error('Upload failed: ' + errBody);
}

/* ================== CONVERSATION CACHE ================== */
function convKey(a,b){ return `${a}|${b}`; }
function messageUniqueKey(m){ if(m.cid) return "cid:"+m.cid; if(m.id) return "id:"+m.id; return "temp:"+ (m._tempKey || (m._tempKey = Math.random().toString(36).slice(2))); }
function compareMessagesAsc(a,b){ const ta = parseDatePrefer(a._db_created_at, a.parsed_time); const tb = parseDatePrefer(b._db_created_at, b.parsed_time); if(ta !== tb) return ta - tb; if(a.id && b.id && a.id !== b.id) return Number(a.id) - Number(b.id); if(a.cid && b.cid && a.cid !== b.cid) return a.cid < b.cid ? -1 : 1; return 0; }
function addOrUpdateMessageToCache(me17, other17, msg){ const key = convKey(me17, other17); if(!conversationCache[key]) conversationCache[key] = []; const list = conversationCache[key]; const findIndex = msg.cid ? list.findIndex(x => x.cid && x.cid === msg.cid) : (msg.id ? list.findIndex(x => x.id && String(x.id) === String(msg.id)) : -1); if(findIndex !== -1){ list[findIndex] = Object.assign({}, list[findIndex], msg); } else { list.push(msg); } list.sort(compareMessagesAsc); }
async function loadConversation(me17, other17){ const key = convKey(me17, other17); conversationCache[key] = conversationCache[key] || []; const seen = new Set(); function pushRow(r, expectedFrom){ let parsed = null; try { parsed = JSON.parse(r.content); } catch(e){ parsed = null; } const parsedFrom = parsed && parsed.from ? parsed.from : null; const parsedTime = parsed && parsed.time ? parsed.time : null; const parsedCid = parsed && parsed.cid ? parsed.cid : null; const parsedText = parsed && (parsed.text || parsed.message) ? (parsed.text || parsed.message) : (r.content || ""); if(!parsedFrom || parsedFrom !== expectedFrom) return; const m = { id: r.id || null, cid: parsedCid || null, from: parsedFrom, text: parsedText, parsed_time: parsedTime || null, _db_created_at: r.created_at || null, created_at: parsedTime || r.created_at || nowISO() }; const keyu = messageUniqueKey(m); if(seen.has(keyu)) return; seen.add(keyu); addOrUpdateMessageToCache(me17, other17, m); } try { const outRows = await apiList(other17); for(const r of outRows) pushRow(r, me17); } catch(e){ console.warn("LIST outgoing failed for", other17, e.message || e); } try { const inRows = await apiList(me17); for(const r of inRows) pushRow(r, other17); } catch(e){ console.warn("LIST incoming failed for", me17, e.message || e); } renderConversation(me17, other17); }
function ensureMessagesPadding(){ const wrap = document.querySelector('#chatModal .messages-wrap'); if(!wrap) return; const inputRow = document.getElementById('chatInputRow'); const h = inputRow ? inputRow.getBoundingClientRect().height : 80; wrap.style.paddingBottom = (h + 16) + 'px'; }
window.addEventListener('resize', ensureMessagesPadding);

function renderConversation(me17, other17, isGroup=false){
  ensureMessagesPadding();
  const key = convKey(me17, other17);
  const arr = conversationCache[key] ? [...conversationCache[key]] : [];
  messagesEl.innerHTML = '';
  if(arr.length === 0){ messagesEl.innerHTML = `<div class="muted">Pa gen mesaj ankò.</div>`; }
  else {
    arr.sort(compareMessagesAsc);
    for(const m of arr){
      const d = document.createElement('div'); d.className = 'msg ' + (m.from === me17 ? 'user' : 'bot');
      const ts = m.created_at ? (new Date(m.created_at)).toLocaleString() : '';
      let checksHtml = '';
      if(m.from === me17){ if(m.id) checksHtml = '<span class="checks">✓✓</span>'; else checksHtml = '<span class="checks">✓</span>'; }
      const senderLabel = (isGroup && m.from && m.from !== me17) ? `<div style="font-size:12px;color:var(--muted);margin-bottom:6px">${formatTFShort(m.from)}</div>` : '';
      d.innerHTML = `${senderLabel}<div>${escapeHtml(m.text)}</div><div style="font-size:11px;color:var(--muted);margin-top:6px">${formatTFShort(m.from||'')} • ${ts} ${checksHtml}</div>`;
      messagesEl.appendChild(d);
    }
  }
  setTimeout(()=> { messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight; }, 50);
}

/* ================== CHAT OPEN/SEND ================== */
async function openChat(other17, contactObj=null, pushHistory=true){
  if(!me.tf17){ alert('Pa gen TFID pou itilizatè a. Louver Paramèt pou mete TFID la.'); return; }
  currentGroup = null;
  currentPartner = { tf17: other17, name: (contactObj && contactObj.name) || null };
  document.getElementById('chatTitle').textContent = (currentPartner.name || formatTFShort(currentPartner.tf17));
  const c = contacts.find(x => x.tf17 === other17);
  if(c){ c.unread = 0; saveState(); renderContacts(); }
  messagesEl.innerHTML = '<div class="muted">Chaje mesaj...</div>';
  try { await loadConversation(me.tf17, other17); } catch(e){ messagesEl.innerHTML = `<div class="muted">Pa kapab chaje mesaj: ${escapeHtml(e.message||e)}</div>`; }
  showChatModal();
  try {
    const slug = encodeURIComponent(other17);
    if(pushHistory){
      if(!history.state || !history.state._tfchat_init){ history.replaceState(Object.assign({}, history.state || {}, {_tfchat_init:true}), '', location.pathname); }
      history.pushState({tfchat: other17}, '', '/' + slug);
    }
  } catch(e){ console.warn('history push failed', e); }
}

async function openGroup(groupName, groupObj){
  if(!me.tf17){ alert('Pa gen TFID pou itilizatè a. Louver Paramèt pou mete TFID la.'); return; }
  currentPartner = null;
  currentGroup = groupName;
  document.getElementById('chatTitle').textContent = groupName;
  messagesEl.innerHTML = '<div class="muted">Chaje messages du groupe...</div>';
  try {
    const url = `${API_BASE}/api/group/messages?group_name=${encodeURIComponent(groupName)}&tfid=${encodeURIComponent(me.tf17)}&name=${encodeURIComponent(FRONTEND_NAME)}`;
    const r = await callJSON(url);
    if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
    const rows = r.json.rows || [];
    const key = convKey(me.tf17, groupName);
    conversationCache[key] = [];
    for(const row of rows.reverse()){
      let parsed = null;
      try{ parsed = JSON.parse(row.content); }catch(e){ parsed = null; }
      const from = parsed && parsed.from ? parsed.from : null;
      const text = parsed && (parsed.text||parsed.message) ? (parsed.text||parsed.message) : (row.content||'');
      const m = { id: row.id, cid: parsed && parsed.cid || null, from: from || row.tfid, text, parsed_time: parsed && parsed.time || row.created_at, _db_created_at: row.created_at, created_at: parsed && parsed.time || row.created_at };
      addOrUpdateMessageToCache(me.tf17, groupName, m);
    }
    renderConversation(me.tf17, groupName, true);
  } catch (e){
    messagesEl.innerHTML = `<div class="muted">Pa kapab chaje messages groupe: ${escapeHtml(e.message||e)}</div>`;
  }
  showChatModal();
  try{
    if(!history.state || !history.state._tfchat_init){ history.replaceState(Object.assign({}, history.state || {}, {_tfchat_init:true}), '', location.pathname); }
    history.pushState({tfchat_group: groupName}, '', '/groupe/' + encodeURIComponent(groupName));
  } catch(e){ console.warn('history push failed', e); }
}

function showChatModal(){ chatModalEl.style.display = 'flex'; ensureMessagesPadding(); setTimeout(()=> chatTextEl?.focus(), 150); }
function hideChatModal(){ chatModalEl.style.display = 'none'; currentPartner = null; currentGroup = null; chatTextEl.value = ''; }

async function sendMessageFromModal(){ const txt = (chatTextEl?.value || '').trim(); if(!txt) return;
  if(!me.tf17){ alert('Pa gen TFID pou itilizatè a. Mete li nan Paramètres.'); return; }
  const cid = makeCid();
  const payload = { type:'text', from: me.tf17, text: txt, time: (new Date()).toISOString(), cid, name: me.name || null };
  if(currentGroup){
    addOrUpdateMessageToCache(me.tf17, currentGroup, { id:null, cid, from: me.tf17, text: txt, parsed_time: payload.time, _db_created_at:null, created_at: payload.time });
    renderConversation(me.tf17, currentGroup, true);
    chatTextEl.value = '';
    try{
      await apiAddToGroup(currentGroup, Object.assign({}, payload, { group: currentGroup }));
    } catch(e){
      alert('Création du message groupe échoué: ' + (e.message||e));
    }
  } else if(currentPartner){
    const recipient17 = currentPartner.tf17;
    addOrUpdateMessageToCache(me.tf17, recipient17, { id:null, cid, from: me.tf17, text: txt, parsed_time: payload.time, _db_created_at:null, created_at: payload.time });
    renderConversation(me.tf17, recipient17, false);
    chatTextEl.value = '';
    const cobj = contacts.find(x=>x.tf17===recipient17); if(cobj){ cobj.lastMsg = txt; cobj.lastTs = Date.now(); saveState(); renderContacts(); }
    try { await apiAddToTfids(recipient17, payload); } catch(e){ alert('Envoi échwe: ' + (e.message||e)); }
  } else {
    alert('Pa gen destinataire seleksyone.');
  }
}

/* ================== GROUP API (admin create/add) ================== */
/* Use token as query param AND header for better compatibility with CORS/server checks */
async function createGroupOnServer(name, owner_name, bio, avatar_url){
  const url = `${API_BASE}/admin/groups/create?token=${encodeURIComponent(ADMIN_API_TOKEN)}`;
  const body = { name, owner_name, bio, avatar_url };
  const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json', 'x-api-token': ADMIN_API_TOKEN}, body: JSON.stringify(body) });
  if(!r.ok) {
    // throw a detailed error
    const errText = r.json ? (JSON.stringify(r.json)) : (r.text || `HTTP ${r.status}`);
    throw new Error(errText);
  }
  return r.json;
}
async function addMemberToGroupOnServer(group_name, tfid){
  const url = `${API_BASE}/admin/groups/add?token=${encodeURIComponent(ADMIN_API_TOKEN)}`;
  const body = { group_name, tfid };
  const r = await callJSON(url, { method: 'POST', headers: {'Content-Type':'application/json', 'x-api-token': ADMIN_API_TOKEN}, body: JSON.stringify(body) });
  if(!r.ok) { const err = r.json ? JSON.stringify(r.json) : r.text; throw new Error(err); }
  return r.json;
}

/* ================== GROUP UI ACTIONS ================== */
groupAvatarPreview.addEventListener('click', ()=> groupFile.click());
groupFile.addEventListener('change', (ev)=> {
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){ groupAvatarPreview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:12px"/>`; };
  reader.readAsDataURL(f);
});

createGroupBtn?.addEventListener('click', ()=> { switchView('groups'); openGroupModal(); });
groupCancelBtn.addEventListener('click', ()=> { closeGroupModal(); });
groupCreateBtn.addEventListener('click', async ()=> {
  const name = (groupNameInput.value || '').trim();
  if(!name){ alert('Nom du groupe est obligatoire'); return; }
  const bio = (groupBioInput.value || '').trim();
  let avatar_url = null;
  const f = groupFile.files && groupFile.files[0];
  try {
    if(f){ avatar_url = await uploadFileToProfile(f); }
  } catch(err){
    alert('Upload échoué: ' + (err.message || err)); return;
  }
  try {
    await createGroupOnServer(name, me.name || null, bio || null, avatar_url || null);
    if(me.tf17){ try{ await addMemberToGroupOnServer(name, me.tf17); }catch(e){ console.warn('add member failed', e); } }
    alert('Groupe créé: ' + name);
    closeGroupModal();
    await loadGroups();
    openGroup(name, { name, bio, avatar_url });
  } catch(err){
    alert('Création groupe échoué: ' + (err.message||err));
  }
});

function openGroupModal(){ groupNameInput.value=''; groupBioInput.value=''; groupFile.value=''; groupAvatarPreview.textContent = '+'; groupModal.style.display = 'flex'; }
function closeGroupModal(){ groupModal.style.display = 'none'; }

/* ================== CONTACTS HELPERS ================== */
function ensureContactInList(tf17, name){ let c = contacts.find(x=>x.tf17===tf17); if(!c){ c = { tf17, short: formatTFShort(tf17), name: name||null, unread:0, blocked:false, avatar:null }; contacts.unshift(c); saveState(); renderContacts(); } return c; }

/* ================== PROMPT FOR ME (settings modal) ================== */
function promptForMeModal(){
  updateSettingsUI();
  settingsModal.style.display = 'flex';
  profileNameInput.focus();
  return new Promise(resolve=>{
    async function onSave(){
      const nameVal = profileNameInput.value.trim();
      const short = normalizeInputToDigits(profileTfidInput.value.trim());
      if(!short || short.length < 7){ alert('TFID invalide — antre 7 chif.'); return; }
      const tfShort = short.slice(-7);
      const tf17c = to17(tfShort);
      const existingHash = getPasswordHash(tf17c);
      if(existingHash){
        const pw = prompt('TFID sa egziste deja lokalman. Antre modpas pou kont sa:');
        if(!pw){ alert('Modpas obligatwa pou kont sa.'); return; }
        const has = await hashPasswordHex(pw);
        if(has !== existingHash){ alert('Modpas pa kòrèk.'); return; }
      }
      me.name = nameVal || me.name || 'Utilisateur';
      me.short = tfShort;
      me.tf17 = to17(me.short);
      saveState();
      settingsModal.style.display = 'none';
      cleanup();
      registerFrontendIfNeeded().then(()=>{ if(ws && ws.readyState === WebSocket.OPEN){ try{ ws.send(JSON.stringify({ type:'subscribe', tfid: me.tf17 })); }catch(e){} } else connectWS(); });
      resolve(true);
    }
    function onCancel(){ settingsModal.style.display = 'none'; cleanup(); resolve(false); }
    function cleanup(){ profileSaveBtn.removeEventListener('click', onSave); settingsCancelBtn.removeEventListener('click', onCancel); }
    profileSaveBtn.addEventListener('click', onSave);
    settingsCancelBtn.addEventListener('click', onCancel);
  });
}

/* ================== PW BANNER/TIMERS ================== */
function triggerPwBannerIfNeeded(){ if(!me.tf17) return; if(hasPasswordFor(me.tf17)) { hidePwBanner(); return; } pwBanner.style.display = 'block'; if(pwWarningTimer) clearTimeout(pwWarningTimer); if(pwForceReloadTimer) clearTimeout(pwForceReloadTimer); pwWarningTimer = setTimeout(()=> { settingsModal.style.display = 'flex'; updateSettingsUI(); }, 60 * 1000); pwForceReloadTimer = setTimeout(()=> { location.reload(); }, 2 * 60 * 1000); }
function hidePwBanner(){ pwBanner.style.display = 'none'; if(pwWarningTimer) { clearTimeout(pwWarningTimer); pwWarningTimer=null; } if(pwForceReloadTimer){ clearTimeout(pwForceReloadTimer); pwForceReloadTimer=null; } }

/* ================== WEBSOCKET ================== */
function connectWS(){ if(!me.tf17){ wsStatusEl.textContent = ''; return; } try { ws = new WebSocket(WS_URL); } catch(e){ scheduleReconnect(); return; } ws.onopen = ()=>{ wsStatusEl.textContent = ''; try{ ws.send(JSON.stringify({ type:'subscribe', tfid: me.tf17 })); } catch(e){} }; ws.onmessage = (ev)=>{ try { const data = JSON.parse(ev.data); if(data.type === 'subscribed') return; if(data.type === 'message'){ const payload = data; let parsed = null; try{ parsed = JSON.parse(payload.content); } catch(e){ parsed = null; } if(!parsed || !parsed.from) return; const recipient = payload.tfid || null; const from = parsed.from; const other = (recipient === me.tf17) ? from : recipient; if(!other) return; const created = parsed.time || payload.created_at || nowISO(); const msgObj = { id: payload.id || null, cid: parsed.cid || null, from, text: parsed.text || parsed.message || '', parsed_time: parsed.time || null, _db_created_at: payload.created_at || null, created_at: created };

            if(parsed.group){
              addOrUpdateMessageToCache(me.tf17, parsed.group, { id: payload.id || null, cid: parsed.cid || null, from, text: parsed.text || parsed.message || '', parsed_time: parsed.time || null, _db_created_at: payload.created_at || null, created_at: created });
              if(currentGroup && currentGroup === parsed.group){ renderConversation(me.tf17, parsed.group, true); }
              else {
                showDesktopNotification(parsed.name || parsed.group, from, parsed.text || parsed.message || '', ()=> { openGroup(parsed.group); });
                const g = groups.find(x=>x.name===parsed.group); if(g){ g._unread = (g._unread||0)+1; renderGroups(); }
              }
              return;
            }

            addOrUpdateMessageToCache(me.tf17, other, msgObj);
            if(parsed.name){ const c = ensureContactInList(other, parsed.name); c.name = parsed.name; c.lastMsg = msgObj.text; c.lastTs = Date.now(); saveState(); renderContacts(); }
            if(parsed.type === 'profile' && parsed.photo){ const c = ensureContactInList(other, parsed.name || null); c.avatar = parsed.photo; c.name = parsed.name || c.name; c.lastTs = Date.now(); saveState(); renderContacts(); }
            if(currentPartner && currentPartner.tf17 === other){ renderConversation(me.tf17, other); }
            else if(recipient === me.tf17){
              const c = ensureContactInList(other, parsed && parsed.name ? parsed.name : null);
              c.unread = (c.unread||0) + 1;
              c.lastMsg = msgObj.text;
              c.lastTs = Date.now();
              saveState();
              renderContacts();

              const fromLabel = parsed && parsed.name ? parsed.name : formatTFShort(parsed && parsed.from ? parsed.from : other);
              showDesktopNotification(fromLabel, parsed && parsed.from ? parsed.from : other, parsed && (parsed.text||parsed.message) ? (parsed.text||parsed.message) : '', () => {
                try{ openChat(parsed.from || other, contacts.find(c=>c.tf17 === (parsed.from || other)) || null, true); }catch(e){}
              });
            }
        }
    } catch(err){ console.warn('WS parse err', err); } };
  ws.onclose = ()=>{ wsStatusEl.textContent = ''; scheduleReconnect(); };
  ws.onerror = (e)=>{ console.warn('WS error', e); wsStatusEl.textContent = ''; try{ ws.close(); }catch(e){} };
}
function scheduleReconnect(){ if(reconnectTimer) return; reconnectTimer = setTimeout(()=>{ reconnectTimer=null; connectWS(); }, 3000); }

/* ================== SEARCH ================== */
async function performSearchQuery(raw){ if(!raw) return; const digits = normalizeInputToDigits(raw); if(!digits){ renderContacts(raw); return; } if(digits.length < 7){ alert('TFID dwe gen omwen 7 chif.'); return; } const short7 = digits.slice(-7); const tf17 = to17(short7); let local = contacts.find(c => c.tf17 === tf17); if(local){ openChat(local.tf17, local, true); return; } try { const rows = await apiList(tf17); if(rows && rows.length > 0){ const last = rows[rows.length-1] || rows[0]; let lastMsg = ''; try{ const p = JSON.parse(last.content); lastMsg = p.text || p.message || last.content; } catch(e){ lastMsg = last.content || ''; } const nameFromServer = (() => { try { const p = JSON.parse(last.content); return p.name || null } catch(_) { return null } })(); const c = { tf17, name: nameFromServer || formatTFShort(short7), lastMsg, lastTs: Date.now(), unread: 0, blocked:false, avatar:null }; contacts.unshift(c); saveState(); renderContacts(); openChat(c.tf17, c, true); return; } else { if(confirm('Pa jwenn done sou servèr. Kreye kontak lokal pou TFID sa a?')){ const c = { tf17, name: formatTFShort(short7), lastMsg: '', lastTs: Date.now(), unread:0, blocked:false, avatar:null }; contacts.unshift(c); saveState(); renderContacts(); openChat(c.tf17, c, true); } } } catch(err){ alert('Erè lè w ap chèche sou servèr: ' + (err.message||err)); } }

/* ================== PROFILE MODAL ================== */
let profileCurrent = null;
const chatTitleEl = document.getElementById('chatTitle');
chatTitleEl?.addEventListener('click', ()=>{ if(!currentPartner && !currentGroup) return; if(currentGroup){ return; } if(!currentPartner) return; openProfileModal(currentPartner.tf17); });
function openProfileModal(tf17){ profileCurrent = tf17; const c = contacts.find(x=>x.tf17===tf17) || { tf17, name: formatTFShort(tf17), blocked:false, avatar:null }; if(c.avatar) { profileAvatar.innerHTML = `<img src="${c.avatar}" />`; } else { profileAvatar.textContent = initials(c.name || c.tf17); } profileName.textContent = c.name || formatTFShort(tf17); profileTfid.textContent = c.tf17; blockBtn.textContent = c.blocked ? 'Débloquer' : 'Bloquer'; profileModal.style.display = 'flex'; }
addContactBtn?.addEventListener('click', ()=>{ if(!profileCurrent) return; const c = ensureContactInList(profileCurrent, null); alert('Contact ajouté : ' + (c.name || c.tf17)); profileModal.style.display = 'none'; });
blockBtn?.addEventListener('click', async ()=>{ if(!profileCurrent) return; const c = ensureContactInList(profileCurrent, null); c.blocked = !c.blocked; saveState(); renderContacts(); try{ const payload = { type: c.blocked ? 'block' : 'unblock', from: me.tf17, time: nowISO(), name: me.name || null }; await apiAddToTfids(profileCurrent, payload); }catch(e){ console.warn('notify block failed', e); } openProfileModal(profileCurrent); });
closeProfileBtn?.addEventListener('click', ()=>{ profileModal.style.display = 'none'; });
reportBtn?.addEventListener('click', async ()=>{ if(!profileCurrent) return; const reason = prompt('Raison du signalement (optionnel)'); try{ const url = `${API_BASE}/admin/report?token=${encodeURIComponent(ADMIN_API_TOKEN)}`; const body = { reported_tfid: profileCurrent, reporter_tfid: me.tf17 || null, reason: reason || null }; const r = await callJSON(url, { method:'POST', headers:{'Content-Type':'application/json','x-api-token': ADMIN_API_TOKEN}, body: JSON.stringify(body) }); if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`); alert('Signaler envoyé'); profileModal.style.display = 'none'; } catch(e){ alert('Signaler échoué: ' + (e.message||e)); } });

profileAvatar?.addEventListener('click', ()=> { if(fileInput) fileInput.click(); });

window.addEventListener('paste', (ev)=>{ const items = ev.clipboardData && ev.clipboardData.items; if(!items) return; for(const it of items){ if(it.kind === 'file' && it.type && it.type.startsWith('image/')){ const f = it.getAsFile(); if(f) { autoUploadProfileFile(f); ev.preventDefault(); break; } } } }, false);

async function autoUploadProfileFile(file){ if(!file) return; if(!file.type || !file.type.startsWith('image/')) { alert('Se sèlman imaj ki aksepte (jpg/png...).'); return; }
  const input = fileInput; if(input) input.disabled = true;
  try {
    const url = await uploadFileToProfile(file);
    me.avatarDataUrl = url; saveState(); contacts.forEach(c => { if(c.tf17 === me.tf17) c.avatar = url; });
    document.querySelectorAll('.avatar').forEach(el=>{ if(el.dataset && el.dataset.tf17 && el.dataset.tf17 === me.tf17){ el.innerHTML = `<img src="${url}" />`; } });
    profileAvatar.innerHTML = `<img src="${url}" />`;
    if(!me.tf17) return;
    const now = (new Date()).toISOString();
    const contactsToNotify = Array.isArray(contacts) ? contacts.slice() : [];
    for(const c of contactsToNotify){ if(!c || !c.tf17 || c.tf17 === me.tf17) continue; const cid = makeCid(); const payload = { type: 'profile', from: me.tf17, name: me.name || null, photo: url, time: now, cid }; apiAddToTfids(c.tf17, payload).catch(err => { console.warn('Push profile update failed for', c.tf17, err); }); }
  } catch(err){ alert('Erè pandan upload: ' + (err.message || err)); } finally { if(input) { input.disabled = false; input.value = ''; } }
}

/* ================== UI EVENTS ================== */
document.getElementById('chatBack')?.addEventListener('click', ()=>{
  const path = location.pathname || '/';
  if(path && path.replace(/^\//, '') !== '' ){
    history.back();
  } else {
    hideChatModal();
  }
});
sendBtnEl?.addEventListener('click', sendMessageFromModal);
chatTextEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessageFromModal(); } });
searchInput?.addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ e.preventDefault(); await performSearchQuery(searchInput.value.trim()); } });
searchBtn?.addEventListener('click', async ()=>{ await performSearchQuery(searchInput.value.trim()); });

appTitleEl?.addEventListener('click', ()=> { updateSettingsUI(); settingsModal.style.display = 'flex'; });

profileSaveBtn?.addEventListener('click', async ()=>{ const newName = profileNameInput.value.trim(); const short = normalizeInputToDigits(profileTfidInput.value.trim()); if(!short || short.length < 7){ alert('TFID pa valab — antre 7 chif.'); return; } const tfShort = short.slice(-7); const tf17 = to17(tfShort); const existingHash = getPasswordHash(tf17); if(existingHash && (!me.tf17 || me.tf17 !== tf17)) { const pw = prompt('Kont sa deja egziste lokalman. Antre modpas li pou itilize li:'); if(!pw) { alert('Modpas obligatwa.'); return; } const has = await hashPasswordHex(pw); if(has !== existingHash){ alert('Modpas pa kòrèk.'); return; } } const newPw = profilePwInput.value || ''; if(newPw){ const hex = await hashPasswordHex(newPw); storePasswordHash(tf17, hex); } me.name = newName || me.name; me.short = tfShort; me.tf17 = tf17; saveState(); settingsModal.style.display = 'none'; await registerFrontendIfNeeded(); if(ws && ws.readyState === WebSocket.OPEN){ try{ ws.send(JSON.stringify({ type:'subscribe', tfid: me.tf17 })); }catch(e){} } else connectWS(); triggerPwBannerIfNeeded(); });
settingsCancelBtn?.addEventListener('click', ()=> settingsModal.style.display = 'none');

/* popstate for groups as well */
window.addEventListener('popstate', (ev)=>{
  const s = ev.state;
  if(s && s.tfchat){ openChat(s.tfchat, contacts.find(c=>c.tf17===s.tfchat)||null, false); }
  else if(s && s.tfchat_group){ openGroup(s.tfchat_group); }
  else { hideChatModal(); }
});

/* initial path handling */
(function handleInitialPath(){ const raw = location.pathname.replace(/^\/+/, ''); if(!raw) return; let candidate = raw; try {
      if(candidate.startsWith('groupe/')){ const g = decodeURIComponent(candidate.replace(/^groupe\//,'')); setTimeout(()=> { switchView('groups'); loadGroups().then(()=> openGroup(g)).catch(()=>openGroup(g)); }, 300); return; }
      if(/^TF-?\d{7,}$/.test(candidate) || /^\d{7,}$/.test(candidate) || /^\d{17,}$/.test(candidate)){
        const tf17 = candidate.startsWith('TF-') ? candidate : to17(candidate);
        let c = contacts.find(x=>x.tf17===tf17);
        if(!c){ c = { tf17, name: formatTFShort(tf17), lastMsg:'', lastTs: Date.now(), unread:0, blocked:false, avatar:null }; contacts.unshift(c); saveState(); renderContacts(); }
        if(me.tf17){ openChat(tf17, c, false); } else { /* don't auto-open settings here */ }
      }
    } catch(e){ console.warn('initial path parse failed', e); }
})();

/* ================== VIEWS ================== */
function switchView(v){
  if(v === 'accueil'){
    tabAccueil.classList.add('active'); tabGroup.classList.remove('active');
    document.getElementById('searchSection').style.display = 'flex';
    contactsListEl.style.display = 'block';
    groupsListEl.style.display = 'none';
  } else {
    tabAccueil.classList.remove('active'); tabGroup.classList.add('active');
    document.getElementById('searchSection').style.display = 'flex';
    contactsListEl.style.display = 'none';
    groupsListEl.style.display = 'block';
    loadGroups();
  }
}
tabAccueil.addEventListener('click', ()=> switchView('accueil'));
tabGroup.addEventListener('click', ()=> switchView('groups'));

/* ================== LOAD GROUPS ================== */
async function loadGroups(){
  if(!me.tf17){ renderGroups(); return; }
  try {
    const url = `${API_BASE}/api/groups?tfid=${encodeURIComponent(me.tf17)}`;
    const r = await callJSON(url);
    if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
    groups = r.json.groups || [];
    renderGroups();
  } catch (e){
    console.warn('loadGroups failed', e);
    groups = [];
    renderGroups();
  }
}

/* ================== BOOT ================== */
renderContacts();
if(me.avatarDataUrl){ document.querySelectorAll('.avatar').forEach(el => { if(!el.querySelector('img')) el.innerHTML = `<img src="${me.avatarDataUrl}" />`; }); }

(async ()=> {
  try { if(isNotificationSupported() && Notification.permission === 'default') await requestNotificationPermission(); } catch(e) {}
})();

if(me.tf17){
  connectWS();
  loadGroups().catch(()=>{});
} else {
  const shownOnce = localStorage.getItem('tfchat.settings_shown_once');
  if(!shownOnce){
    promptForMeModal().then(()=>{ /* no-op */ });
    localStorage.setItem('tfchat.settings_shown_once', '1');
  }
}

window._tf_contacts = contacts;
window._tf_me = me;
</script>
</body>
          </html>
