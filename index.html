<!doctype html>
<html lang="ht">
<head>
<meta charset="utf-8" />
<!-- prevent zoom (you requested "Imposib pou user zoome") -->
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>TF-Chat</title>

<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/jpeg" href="https://files.catbox.moe/ixgmht.jpg" />
<link rel="apple-touch-icon" href="https://files.catbox.moe/ixgmht.jpg" />
<meta name="theme-color" content="#000000">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#000000; --panel:#000000; --text:#e6eefb; --muted:#9aa6bf; --card:#0b0b0b; --accent:#0b81ff; --header-h:56px; --tab-h:62px; --msg-line-height:1.35rem; --msg-max-lines:8; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Roboto,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
header{position:fixed;left:0;right:0;top:0;height:var(--header-h);display:flex;align-items:center;justify-content:center;background:var(--panel);z-index:1000;border-bottom:1px solid rgba(255,255,255,0.03)}
.app-title{font-weight:700;font-size:18px;cursor:pointer}
main{position:fixed;left:0;right:0;top:var(--header-h);bottom:var(--tab-h);overflow:auto;padding:12px;margin:0 auto;max-width:980px}

/* WHEN CHAT OPEN: hide lists / main content (ensures on large devices contact list doesn't stay visible) */
body.chat-open main > section { display:none !important; }

/* tabbar bottom */
.tabbar { position:fixed; left:0; right:0; bottom:0; height:var(--tab-h); display:flex; gap:0; border-top:1px solid rgba(255,255,255,0.03); background:var(--panel); align-items:center; justify-content:center; z-index:1000; }
.tab { flex:1; text-align:center; padding:10px 6px; cursor:pointer; font-weight:700; color:var(--muted); }
.tab.active{ color:var(--text); border-top:3px solid var(--accent); background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }

/* rest kept / adjusted */
.search{padding:8px 12px;display:flex;justify-content:center}
.search-box{display:flex;align-items:center;gap:8px;background:var(--card);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);width:100%;max-width:980px}
.search-box input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:15px}
.search-btn{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.list{margin-top:12px}
.contact{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer;width:100%}
.contact:hover{background:rgba(255,255,255,0.02)}
.avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:var(--text);flex-shrink:0;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.meta{flex:1;min-width:0}
.meta-top{display:flex;justify-content:space-between;align-items:flex-start}
.name{font-weight:600;font-size:16px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.time{font-size:12px;color:var(--muted)}
.meta-bottom{display:flex;justify-content:space-between;margin-top:6px;align-items:center}
.snippet{font-size:13px;color:var(--muted);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.badge{background:var(--accent);color:white;padding:4px 8px;border-radius:999px;font-weight:600;font-size:13px}
.group-manage-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:600;margin-left:8px}

.messages-wrap{padding:12px;height:calc(100% - 56px - 84px);overflow:auto;display:flex;flex-direction:column;gap:8px}
.messages{display:flex;flex-direction:column;gap:8px}
.msg{max-width:74%;padding:10px;border-radius:12px;margin-bottom:4px;word-break:break-word;overflow:hidden;display:inline-block}
.msg.bot{background:#121212;color:var(--text);align-self:flex-start}
.msg.user{background:linear-gradient(180deg,var(--accent),#0563c9);color:white;align-self:flex-end}
.msg .checks{font-size:11px;margin-left:8px;opacity:0.9}

/* safe message text block (no UI break) */
.msg-text{
  white-space:pre-wrap;
  word-break:break-word;
  overflow-wrap:anywhere;
  display:block;
  -webkit-box-orient:vertical;
  line-height: var(--msg-line-height);
  max-height: calc(var(--msg-line-height) * var(--msg-max-lines));
}

/* clamp visually using mask if overflow */
.msg-text.clamped {
  mask-image: linear-gradient(180deg, black 60%, transparent);
}

/* small meta row under message */
.msg-meta{font-size:11px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center}

/* input */
.chat-input{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:transparent}
.input{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:var(--card);color:var(--text);outline:none;min-width:0}
.send-btn{background:transparent;border:0;padding:8px;border-radius:10px;cursor:pointer;color:var(--accent)}
.muted{text-align:center;color:var(--muted);padding:20px}
.bottom-right { position: fixed; right: 16px; bottom: 16px; z-index: 1100; display:flex; gap:8px; align-items:center; }
/* hide websocket text indicator per request; keep space available for other UI */
.ws-indicator{display:none}
@media (min-width:900px){main{max-width:700px;margin:0 auto}}

/* white settings panel on dark backdrop */
.settings-panel{width:420px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(11,18,32,0.2);color:#0b1220}
.settings-label{font-size:13px;color:#374151}
/* small banner for password warning (disabled by JS) */
.banner { position: fixed; left: 50%; transform: translateX(-50%); top: var(--header-h); z-index:1300; background: #fffbeb; color:#92400e; border:1px solid #f59e0b; padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.2);font-weight:600; display:none; }
/* contact fullscreen profile modal */
.profile-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1400; background:rgba(0,0,0,0.6); }
.profile-card { width:320px; background:#fff; color:#0b1220; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
.profile-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.profile-avatar{width:64px;height:64px;border-radius:12px;background:#cbd5e1;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
.profile-avatar img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.small{font-size:12px;color:var(--muted)}
/* ensure chat modal covers full height and messages area reserves space for input */
#chatModal .messages-wrap { height: calc(100% - 56px - 64px - 24px); }

/* create group modal */
.create-group { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500; background:rgba(0,0,0,0.6); }
.create-panel { width:360px; background:#fff; color:#0b1220; padding:16px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.4); }
.create-avatar { width:84px; height:84px; border-radius:999px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; margin-bottom:8px }
.create-avatar img{width:100%;height:100%;object-fit:cover}

/* manage group modal */
.group-manage { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1550; background:rgba(0,0,0,0.6); }
.group-panel { width:420px; background:#fff; color:#0b1220; padding:16px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.4); }
.group-members { max-height:240px; overflow:auto; border:1px solid #eef2ff; padding:8px; border-radius:8px; margin-bottom:12px; }
.member-row { display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-radius:8px; margin-bottom:6px; background:#f8fafc; }

/* responsive tweaks */
@media (max-width:640px){
  .avatar{width:48px;height:48px}
  .profile-avatar{width:56px;height:56px}
  .create-panel{ width:92%; }
  .group-panel{ width:92%; }
  main{ padding:10px; }
}
</style>
</head>
<body>
  <header><div class="app-title">TF-Chat</div></header>

  <div class="banner" id="pwBanner">Tanpri mete yon modpas pou sekirize sesyon ou. Ou gen 2 min pou sove li.</div>

  <main>
    <!-- Accueil (default) -->
    <section id="section-accueil">
      <section class="search">
        <div class="search-box" role="search">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
          <input id="searchInput" placeholder="Recherche (TFID ou 7 chif)" aria-label="Recherche" />
          <button id="searchBtn" class="search-btn">Rechercher</button>
        </div>
      </section>

      <section class="list" id="contactsList" aria-live="polite"></section>
    </section>

    <!-- Groupes -->
    <section id="section-groupes" style="display:none">
      <section class="search">
        <div class="search-box" role="search">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
          <input id="groupSearchInput" placeholder="Chercher un groupe…" aria-label="Recherche groupe" />
          <button id="groupSearchBtn" class="search-btn">Recherche</button>
        </div>
      </section>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div style="font-weight:700">Mes groupes</div>
        <button id="openCreateGroup" class="search-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 12px;border-radius:10px">Créer</button>
      </div>

      <section class="list" id="groupsList" aria-live="polite" style="margin-top:12px"></section>
    </section>

  </main>

  <div class="tabbar">
    <div id="tabAccueil" class="tab active">Accueil</div>
    <div id="tabGroupes" class="tab">Groupes</div>
  </div>

  <!-- Chat modal (overlay) -->
  <div id="chatModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:1200">
    <div style="height:100%;display:flex;flex-direction:column">
      <div style="height:56px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <button id="chatBack" style="background:transparent;border:0;color:var(--text);cursor:pointer">←</button>
        <div style="flex:1;text-align:center;font-weight:700;cursor:pointer" id="chatTitle">Chat</div>
        <div style="width:44px"></div>
      </div>
      <div class="messages-wrap">
        <div class="messages" id="messages"></div>
      </div>
      <div class="chat-input" id="chatInputRow">
        <input id="chatText" class="input" placeholder="Ekri mesaj..." autocomplete="off" />
        <button id="sendBtn" class="send-btn">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- (other modals unchanged) -->
  <!-- omitted here for brevity: createGroupModal, groupManageModal, profileModal, settingsModal -->
  <!-- ... (use your existing markup for those modals) ... -->

<script>
/* Minimal excerpt: only the JS parts changed are included here.
   Keep the rest of your original JS (api, upload, ws, group handling).
   Below are the exact functions I updated/added:
*/

/* ================= HELPERS (kept from your version) ================= */
function nowISO(){ return (new Date()).toISOString(); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatTFShort(digitsString){ if(!digitsString) return ''; const s=String(digitsString).replace(/[^0-9]/g,''); const last7 = s.slice(-7); return 'TF-'+ last7.padStart(7,'0'); }

/* ================= DOME REFS ================= */
const messagesEl = document.getElementById('messages');
const chatModalEl = document.getElementById('chatModal');
const chatTextEl = document.getElementById('chatText');
const sendBtnEl = document.getElementById('sendBtn');
const sectionAccueil = document.getElementById('section-accueil');
const sectionGroupes = document.getElementById('section-groupes');
const chatTitleEl = document.getElementById('chatTitle');

/* ================ conversation cache (reuse from you) ================ */
const conversationCache = {}; // keep your existing logic; here simplified for clarity

function convKey(a,b){ return `${a}|${b}`; }
function parseDatePrefer(isoOrDb, parsedTime){ const t1 = parsedTime ? Date.parse(parsedTime) : NaN; if(!isNaN(t1)) return t1; const t2 = Date.parse(isoOrDb || ""); return isNaN(t2) ? 0 : t2; }
function compareMessagesAsc(a,b){
  const ta = parseDatePrefer(a._db_created_at, a.parsed_time);
  const tb = parseDatePrefer(b._db_created_at, b.parsed_time);
  if(ta !== tb) return ta - tb;
  // fallback stable ordering
  if(a.id && b.id && a.id !== b.id) return Number(a.id) - Number(b.id);
  if(a.cid && b.cid && a.cid !== b.cid) return a.cid < b.cid ? -1 : 1;
  return 0;
}
function addOrUpdateMessageToCache(me17, other17, msg){
  const key = convKey(me17, other17);
  if(!conversationCache[key]) conversationCache[key] = [];
  const list = conversationCache[key];
  const findIndex = msg.cid ? list.findIndex(x => x.cid && x.cid === msg.cid) : (msg.id ? list.findIndex(x => x.id && String(x.id) === String(msg.id)) : -1);
  if(findIndex !== -1){
    list[findIndex] = Object.assign({}, list[findIndex], msg);
  } else {
    list.push(msg);
  }
  list.sort(compareMessagesAsc);
}

/* ==================== LINKIFY helper (safe) ==================== */
const URL_RE = /((https?:\/\/|www\.)[^\s<>]+)/gi;
function createMessageNodes(text){
  const frag = document.createDocumentFragment();
  if(!text){ frag.appendChild(document.createTextNode('')); return frag; }
  let last = 0;
  let m;
  while((m = URL_RE.exec(text)) !== null){
    const idx = m.index;
    if(idx > last) frag.appendChild(document.createTextNode(text.slice(last, idx)));
    let url = m[0];
    if(!/^https?:\/\//i.test(url)) url = 'http://' + url;
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = m[0];
    a.style.color = 'inherit';
    a.style.textDecoration = 'underline';
    frag.appendChild(a);
    last = idx + m[0].length;
  }
  if(last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
  return frag;
}

/* ================== RENDER CONVERSATION (fixed ordering + smart scroll) ================== */
function renderConversation(me17, other17){
  // ensure padding for input
  const wrap = document.querySelector('#chatModal .messages-wrap');
  if(!wrap) return;
  const inputRow = document.getElementById('chatInputRow');
  const h = inputRow ? inputRow.getBoundingClientRect().height : 80;
  wrap.style.paddingBottom = (h + 16) + 'px';

  const key = convKey(me17, other17);
  const arr = conversationCache[key] ? [...conversationCache[key]] : [];

  // sort ascending (oldest first)
  arr.sort(compareMessagesAsc);

  // determine if user is already at bottom (so we auto-scroll only if they were)
  const parent = messagesEl.parentElement;
  const wasAtBottom = parent ? (parent.scrollHeight - parent.scrollTop - parent.clientHeight < 50) : true;

  messagesEl.innerHTML = '';
  if(arr.length === 0){
    const d = document.createElement('div');
    d.className = 'muted';
    d.textContent = 'Pa gen mesaj ankò.';
    messagesEl.appendChild(d);
  } else {
    for(const m of arr){
      const d = document.createElement('div');
      d.className = 'msg ' + (m.from === me17 ? 'user' : 'bot');

      const textBlock = document.createElement('div');
      textBlock.className = 'msg-text';
      textBlock.appendChild(createMessageNodes(m.text || ''));

      const meta = document.createElement('div');
      meta.className = 'msg-meta';
      const ts = m.created_at ? (new Date(m.created_at)).toLocaleString() : '';
      let checks = '';
      if(m.from === me17){
        checks = m.id ? '✓✓' : '✓';
      }
      meta.textContent = `${formatTFShort(m.from||'')} • ${ts} ${checks}`;

      d.appendChild(textBlock);
      d.appendChild(meta);
      messagesEl.appendChild(d);
    }
  }

  // scroll behavior: if user was at bottom, keep at bottom; otherwise preserve their scroll position
  setTimeout(()=>{
    if(!parent) return;
    if(wasAtBottom){
      parent.scrollTop = parent.scrollHeight;
    } else {
      // keep current scroll (do nothing)
    }
  }, 50);
}

/* ================== SHOW / HIDE CHAT (force-hide contact list when open) ================== */
function showChatModal(){
  document.body.classList.add('chat-open'); // hides main sections (contacts/groups) on all sizes
  chatModalEl.style.display = 'block';
  ensureMessagesPadding();
  setTimeout(()=> {
    try{ chatTextEl?.focus(); }catch(e){}
  }, 150);
}
function hideChatModal(){
  chatModalEl.style.display = 'none';
  document.body.classList.remove('chat-open');
  // clear current selection
  // currentPartner = null; currentGroup = null; // keep if you use global state elsewhere
}

/* ================== SEND MESSAGE (ensure caching with created_at so ordering works) ================== */
async function sendMessageFromModal(){
  let txt = (chatTextEl?.value || '').trim();
  if(!txt) return;
  // you may have your own checks (TFID set, blocked user etc.) — keep them as in your original code
  // create optimistic payload and push to cache:
  const cid = String(Date.now()) + '-' + Math.floor(Math.random()*100000).toString(16);
  const payload = { type:'text', from: (window._tf_me && window._tf_me.tf17) || null, text: txt, time: nowISO(), cid };
  // assuming currentPartner set globally; fallback recipient variable required by your app
  const recipient17 = (window.currentPartner && window.currentPartner.tf17) || null;
  if(!recipient17){
    alert('Pa gen konvèsasyon chwazi.');
    return;
  }
  // add optimistic message to cache (created_at uses payload.time)
  addOrUpdateMessageToCache((window._tf_me && window._tf_me.tf17) || null, recipient17, { id:null, cid:payload.cid, from: payload.from, text: payload.text, created_at: payload.time, _optimistic:true });
  renderConversation((window._tf_me && window._tf_me.tf17) || null, recipient17);
  chatTextEl.value = '';

  // then send using your existing apiAdd logic (not duplicated here)
  try{
    // example: await apiAdd(recipient17, payload);
    // after server ack, you should update cache entry with server id/created_at (your reconcile code already handles it)
  }catch(e){
    alert('Envoi echwe: ' + (e.message||e));
  }
}

/* ================== WIRING (some event handlers) ================== */
/* keep your full app's JS wiring; below are the small changes to use updated functions */
document.getElementById('chatBack')?.addEventListener('click', ()=>{
  hideChatModal();
});
sendBtnEl?.addEventListener('click', sendMessageFromModal);
chatTextEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessageFromModal(); } });

/* expose these utils to the rest of your script (so existing code can call them) */
window.addOrUpdateMessageToCache = addOrUpdateMessageToCache;
window.renderConversation = renderConversation;
window.showChatModal = showChatModal;
window.hideChatModal = hideChatModal;

/* Note:
   - integrate these functions with the rest of your app's api/list/ws/reconcile logic.
   - after server confirms messages you already have reconcileSentMessage in your code — that works fine with this render logic.
*/
</script>
</body>
  </html>
