<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TF-Chat</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--accent:#007aff;--incoming:#f3f6f9;--outgoing:#34c759;--text:#0b1220}
  html,body{height:100%;margin:0;font-family:-apple-system,'Helvetica Neue',Arial;background:var(--bg);color:var(--text)}
  .app{max-width:1100px;margin:0 auto;height:100vh;display:grid;grid-template-columns:360px 1fr;gap:18px;padding:18px;box-sizing:border-box}
  @media(max-width:920px){.app{grid-template-columns:1fr;padding:12px}}
  .sidebar{background:var(--card);border-radius:18px;padding:14px;display:flex;flex-direction:column;gap:12px;height:calc(100vh-36px);overflow:hidden;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  .top{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#007aff,#0ea5e9);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
  .title{font-weight:700;font-size:18px}.sub{color:var(--muted);font-size:13px;margin-top:2px}
  .searchBox{display:flex;gap:8px;margin-top:8px}.searchBox input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:14px}.searchBox button{padding:10px 12px;background:var(--accent);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:600}
  .contacts{margin-top:10px;overflow:auto;padding-right:6px}.contact{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;cursor:pointer}.contact:hover{background:#f8fafc}
  .avatar{width:46px;height:46px;border-radius:50%;background:#cbd5e1;display:flex;align-items:center;justify-content:center;font-weight:700;color:#0b1220}
  .contact .meta{flex:1}.contact .name{font-weight:700}.contact .tf{color:var(--muted);font-size:12px;margin-top:4px}
  .badge{background:#ef4444;color:white;padding:4px 8px;border-radius:999px;font-size:12px}
  .actions{display:flex;gap:8px;margin-top:auto;align-items:center;justify-content:space-between}
  .main{background:var(--card);border-radius:18px;height:calc(100vh-36px);display:flex;flex-direction:column;overflow:hidden;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  .header{padding:10px 16px;border-bottom:1px solid #eef2f7;display:flex;gap:12px;align-items:center}
  .header .avatar-lg{width:52px;height:52px;border-radius:12px;background:#cbd5e1;display:flex;align-items:center;justify-content:center;font-weight:700}
  .header .info{flex:1}
  .header .info .name{font-weight:800;font-size:16px}.header .info .sub{color:var(--muted);font-size:12px;margin-top:4px}
  .messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,rgba(0,0,0,0.01),transparent)}
  .bubble{max-width:72%;padding:10px 12px;border-radius:14px;line-height:1.3;word-wrap:break-word}
  .bubble.me{margin-left:auto;background:var(--outgoing);color:white;border-bottom-right-radius:6px}
  .bubble.them{margin-right:auto;background:var(--incoming);color:var(--text);border-bottom-left-radius:6px;border:1px solid #e6edf3}
  .meta-time{font-size:11px;color:var(--muted);margin-top:6px}
  .composer{padding:12px;border-top:1px solid #eef2f7;display:flex;gap:10px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.5),rgba(255,255,255,0.9))}
  .composer input{flex:1;padding:12px;border-radius:12px;border:1px solid #e6eef3;font-size:15px;outline:none}
  .composer button{padding:10px 14px;border-radius:10px;background:var(--accent);color:white;border:none;font-weight:700;cursor:pointer}
  .muted-note{color:var(--muted);font-size:13px;padding:8px 12px}.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="sidebar">
      <div class="top">
        <div class="logo">TF</div>
        <div>
          <div class="title">TF-Chat</div>
          <div class="sub">site1 ‚Ä¢ Frontend</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <div class="small">TF-ID connect√©</div>
        <div id="meDisplay" style="font-weight:800;margin-top:4px">‚Äî</div>
      </div>

      <div class="searchBox">
        <input id="searchInput" placeholder="Entrer TFID (ex: TF-0204143 ou 0204143)" />
        <button id="searchBtn">Rechercher</button>
      </div>

      <div style="margin-top:6px" class="small">Contacts r√©cents</div>
      <div class="contacts" id="contactsList" aria-live="polite"></div>

      <div class="actions">
        <div style="display:flex;gap:8px">
          <button id="newContactBtn" style="padding:8px 10px;border-radius:10px;border:1px solid #e6edf3;background:white;cursor:pointer">‚ûï Contact</button>
          <button id="newGroupBtn" style="padding:8px 10px;border-radius:10px;border:1px solid #e6edf3;background:white;cursor:pointer">üë• Groupe</button>
        </div>
        <div>
          <button id="settingsBtn" style="padding:8px 10px;border-radius:10px;border:1px solid #e6edf3;background:white;cursor:pointer">‚öôÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="header">
        <div class="avatar-lg" id="chatAvatar">‚Äî</div>
        <div class="info">
          <div class="name" id="chatName">Aucun contact s√©lectionn√©</div>
          <div class="sub" id="chatSub">S√©lectionne un contact √† gauche</div>
        </div>
        <div style="min-width:90px;text-align:right">
          <div class="small">TF-Chat</div>
          <div class="small" id="wsStatus">WS: ‚Äî</div>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer" id="composer" style="display:none">
        <input id="messageInput" placeholder="√âcrire un message..." />
        <button id="sendBtn">Envoyer</button>
      </div>

      <div id="emptyNote" class="muted-note" style="display:block">Aucun contact s√©lectionn√© ‚Äî recherchez un TFID ou cr√©ez un contact.</div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const API_BASE = "https://tf-sove.onrender.com";
const FRONTEND_NAME = "site1";
const ADMIN_API_TOKEN = "tfstream_45dd9c02d4e34f18a42d";
const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + "tf-sove.onrender.com/ws";

/* ========== UTIL ========== */
function normalizeInputToDigits(inp){ if(!inp) return null; const s=String(inp).trim().toUpperCase(); const digits=s.replace(/[^0-9]/g,""); return digits||null; }
function to17(shortOrDigits){ if(!shortOrDigits) return null; const ds=String(shortOrDigits); if(ds.length>17) return ds.slice(-17); return ds.padStart(17,"0"); }
function formatTFShort(digitsString){ if(!digitsString) return ""; const s=String(digitsString); const last7=s.slice(-7); return "TF-"+last7.padStart(7,"0"); }
function nowISO(){ return (new Date()).toISOString(); }
function fmtTime(iso){ try{ const d=new Date(iso); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}catch(e){return "";} }
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function makeCid(){ return String(Date.now()) + "-" + Math.floor(Math.random()*100000).toString(16); }

/* ========== STATE ========== */
let me = {
  short: localStorage.getItem("tfchat.me.short") || null,
  tf17: localStorage.getItem("tfchat.me.17") || null,
  name: localStorage.getItem("tfchat.me.name") || "Moi",
  avatarDataUrl: localStorage.getItem("tfchat.me.avatar") || null
};
let contacts = JSON.parse(localStorage.getItem("tfchat.contacts") || "[]");
let ws = null;
let currentPartner = null;
let conversationCache = {}; // key => [{id,cid,from,text,created_at}]
let reconnectTimer = null;

/* ========== DOM ========== */
const meDisplay = document.getElementById("meDisplay");
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const contactsList = document.getElementById("contactsList");
const chatAvatar = document.getElementById("chatAvatar");
const chatName = document.getElementById("chatName");
const chatSub = document.getElementById("chatSub");
const messagesEl = document.getElementById("messages");
const composer = document.getElementById("composer");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const wsStatus = document.getElementById("wsStatus");
const emptyNote = document.getElementById("emptyNote");

/* ========== STATE HELPERS ========== */
function saveState(){ localStorage.setItem("tfchat.me.short", me.short||""); localStorage.setItem("tfchat.me.17", me.tf17||""); localStorage.setItem("tfchat.me.name", me.name||""); if(me.avatarDataUrl) localStorage.setItem("tfchat.me.avatar", me.avatarDataUrl); localStorage.setItem("tfchat.contacts", JSON.stringify(contacts)); }
function renderMe(){ meDisplay.textContent = me.tf17 ? `${formatTFShort(me.tf17)} ‚Ä¢ ${me.name||"Moi"}` : "‚Äî"; if(me.avatarDataUrl) chatAvatar.style.backgroundImage = `url(${me.avatarDataUrl})`; }
function renderContacts(){ contactsList.innerHTML=""; if(contacts.length===0){ contactsList.innerHTML = `<div class="small" style="padding:8px;color:var(--muted)">Aucun contact. Recherchez un TFID ou cr√©ez-en un.</div>`; return; } for(const c of contacts){ const el=document.createElement("div"); el.className="contact"; el.dataset.tf17=c.tf17; el.innerHTML = `<div class="avatar">${escapeHtml((c.name||formatTFShort(c.tf17))[0]||"U")}</div><div class="meta"><div class="name">${escapeHtml(c.name||formatTFShort(c.tf17))}</div><div class="tf">${formatTFShort(c.tf17)}</div></div>${c.unread?`<div class="badge">${c.unread}</div>`:""}`; el.onclick = ()=> openChat(c.tf17, c); contactsList.appendChild(el); } }

/* ========== HTTP HELPERS ========== */
async function callJSON(url, opts={}) {
  try {
    const r = await fetch(url, opts);
    const text = await r.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e){ /* non-json */ }
    return { ok: r.ok, status: r.status, json, text };
  } catch(e){ return { ok:false, error: e.message }; }
}

async function apiList(tf17){
  const url = `${API_BASE}/api/list?tfid=${encodeURIComponent(tf17)}&name=${encodeURIComponent(FRONTEND_NAME)}`;
  const r = await callJSON(url);
  if(!r.ok) throw new Error(r.json?.error || r.text || `HTTP ${r.status}`);
  return r.json.rows || [];
}

async function apiAdd(recipient17, contentObj){
  const body = { tfid: recipient17, name: FRONTEND_NAME, content: JSON.stringify(contentObj), source_url: location.origin };
  const url = `${API_BASE}/api/add`;
  const r = await callJSON(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body) });
  if(!r.ok) {
    const errMsg = r.json?.error || r.text || `HTTP ${r.status}`;
    if(String(errMsg).toLowerCase().includes("frontend name not registered")) {
      const regOk = await registerFrontendIfNeeded();
      if(regOk) {
        const r2 = await callJSON(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body) });
        if(!r2.ok) throw new Error(r2.json?.error || r2.text || `HTTP ${r2.status}`);
        return r2.json;
      }
    }
    throw new Error(errMsg);
  }
  return r.json;
}

async function registerFrontendIfNeeded(){
  try {
    const url = `${API_BASE}/admin/register-frontend`;
    const payload = { name: FRONTEND_NAME, callback_url: location.origin };
    const r = await callJSON(url, { method:"POST", headers:{"Content-Type":"application/json","x-api-token": ADMIN_API_TOKEN}, body: JSON.stringify(payload) });
    if(r.ok) return true;
    return false;
  } catch(e){ return false; }
}

/* ========== CONVERSATION CACHE ========== */
function convKey(a,b){ return `${a}|${b}`; }

function addOrUpdateMessageToCache(me17, other17, msg){
  const key = convKey(me17, other17);
  if(!conversationCache[key]) conversationCache[key] = [];
  const list = conversationCache[key];

  // dedupe by cid (preferred) then id
  if(msg.cid){
    const idx = list.findIndex(x => x.cid && x.cid === msg.cid);
    if(idx !== -1){ list[idx] = Object.assign({}, list[idx], msg); return; }
  }
  if(msg.id){
    const idx2 = list.findIndex(x => String(x.id) === String(msg.id));
    if(idx2 !== -1){ list[idx2] = Object.assign({}, list[idx2], msg); return; }
  }
  // otherwise append
  list.push(msg);
  // sort ascending (old ‚Üí new)
  list.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
}

async function loadConversation(me17, other17){
  const key = convKey(me17, other17);
  conversationCache[key] = conversationCache[key] || [];

  // --- OUTGOING: messages saved under recipient that have parsed.from === me17 ---
  try{
    const outRows = await apiList(other17);
    for(const r of outRows){
      let parsed = null;
      try{ parsed = JSON.parse(r.content); } catch(e){ parsed = null; }
      if(!parsed || !parsed.from) continue;
      if(parsed.from !== me17) continue;
      const msg = { id: r.id, cid: parsed.cid || null, from: parsed.from, text: parsed.text || "", created_at: r.created_at };
      addOrUpdateMessageToCache(me17, other17, msg);
    }
  }catch(e){ /* ignore */ }

  // --- INCOMING: messages saved under my tf17 that have parsed.from === other17 ---
  try{
    const inRows = await apiList(me17);
    for(const r of inRows){
      let parsed = null;
      try{ parsed = JSON.parse(r.content); } catch(e){ parsed = null; }
      if(!parsed || !parsed.from) continue;
      if(parsed.from !== other17) continue;
      const msg = { id: r.id, cid: parsed.cid || null, from: parsed.from, text: parsed.text || "", created_at: r.created_at };
      addOrUpdateMessageToCache(me17, other17, msg);
    }
  }catch(e){ /* ignore */ }

  renderConversation(me17, other17);
}

function renderConversation(me17, other17){
  const key = convKey(me17, other17);
  const arr = conversationCache[key] || [];
  messagesEl.innerHTML = "";
  if(arr.length === 0){
    messagesEl.innerHTML = `<div class="small" style="text-align:center;color:var(--muted);padding:20px">Pas encore de messages entre vous.</div>`;
  } else {
    for(const m of arr){
      const b = document.createElement("div");
      b.className = "bubble " + (m.from === me17 ? "me" : "them");
      b.innerHTML = `<div>${escapeHtml(m.text)}</div><div class="meta-time">${formatTFShort(m.from)} ‚Ä¢ ${fmtTime(m.created_at)}</div>`;
      messagesEl.appendChild(b);
    }
  }
  // scroll to bottom (newest)
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ========== CHAT / SEND ========== */
async function openChat(other17, contactObj=null){
  if(!me.tf17){ if(!await promptForMe()) return; }
  currentPartner = { tf17: other17, short: formatTFShort(other17), name: (contactObj && contactObj.name) || null };
  chatName.textContent = currentPartner.name || currentPartner.short;
  chatSub.textContent = currentPartner.tf17;
  chatAvatar.textContent = (currentPartner.name ? currentPartner.name[0] : currentPartner.short.slice(-2));
  composer.style.display = "flex";
  emptyNote.style.display = "none";
  const c = contacts.find(x => x.tf17 === other17);
  if(c){ c.unread = 0; saveState(); renderContacts(); }
  await loadConversation(me.tf17, other17);
  // ensure WS subscription for me.tf17 (server handles)
  if(ws && ws.readyState === WebSocket.OPEN) {
    try { ws.send(JSON.stringify({ type:"subscribe", tfid: me.tf17 })); } catch(e){}
  }
}

async function sendToCurrent(text){
  if(!currentPartner){ alert("S√©lectionne un contact d'abord."); return; }
  if(!me.tf17){ if(!await promptForMe()) return; }

  const cid = makeCid();
  const payload = { type: "text", from: me.tf17, text, time: nowISO(), cid };
  // local optimistic message
  const localMsg = { id: "local-" + cid, cid, from: me.tf17, text, created_at: payload.time };
  addOrUpdateMessageToCache(me.tf17, currentPartner.tf17, localMsg);
  renderConversation(me.tf17, currentPartner.tf17);

  try {
    const resp = await apiAdd(currentPartner.tf17, payload);
    // start short poll fallback to ensure recipient gets message even if WS missed (max 5 tries)
    startShortPollForMessage(currentPartner.tf17, payload.cid);
  } catch(e){
    alert("Envoi √©chou√© : " + (e.message || e));
  }
}

/* short poll: after sending, try N times to fetch server list and sync once server has stored message (match by cid) */
function startShortPollForMessage(target17, cid){
  let tries = 0;
  const maxTries = 6;
  const attempt = async ()=>{
    tries++;
    try {
      // check recipient storage (server stored under target17)
      const rows = await apiList(target17);
      const found = rows.find(r => {
        try { const p = JSON.parse(r.content); return p && p.cid === cid; } catch(e){ return false; }
      });
      if(found){
        // also fetch my storage to ensure incoming saved message is available for me (often server stores under recipient only)
        // We will merge for both sides:
        await loadConversation(me.tf17, target17);
        return true;
      }
    } catch(e){
      // ignore error
    }
    if(tries < maxTries) {
      setTimeout(attempt, 1200);
    }
  };
  attempt();
}

/* ========== CONTACTS & UI helpers ========== */
function ensureContactInList(tf17, name){
  let c = contacts.find(x=>x.tf17===tf17);
  if(!c){ c = { tf17, short: formatTFShort(tf17), name: name||null, unread:0 }; contacts.unshift(c); saveState(); renderContacts(); }
  return c;
}

async function promptForMe(){
  const v = prompt("Entrer votre TFID (ex: TF-0204143 ou 0204143).");
  if(!v) return false;
  const digits = normalizeInputToDigits(v);
  if(!digits){ alert("TFID invalide"); return false; }
  me.short = digits.slice(-7);
  me.tf17 = to17(me.short);
  saveState();
  renderMe();
  if(ws){ try{ ws.close(); }catch(e){} }
  connectWS();
  return true;
}

/* ========== WEBSOCKET ========== */
function connectWS(){
  if(!me.tf17){ wsStatus.textContent = "WS: non connect√© (pas de TFID)"; return; }
  try {
    ws = new WebSocket(WS_URL);
  } catch(e){ scheduleReconnect(); return; }

  ws.onopen = ()=>{
    wsStatus.textContent = "WS: connect√©";
    try{ ws.send(JSON.stringify({ type:"subscribe", tfid: me.tf17 })); } catch(e){ console.warn("WS send err", e); }
  };
  ws.onmessage = (ev)=>{
    try {
      const data = JSON.parse(ev.data);
      if(data.type === "subscribed") return;
      if(data.type === "message"){
        const payload = data;
        let parsed = null;
        try{ parsed = JSON.parse(payload.content); } catch(e){ parsed = null; }
        if(!parsed || !parsed.from) return;

        const recipient = payload.tfid || null;
        const serverId = payload.id || null;
        const from = parsed.from;
        const text = parsed.text || "";
        const created = payload.created_at || nowISO();

        const isForMe = (recipient === me.tf17);
        const other = isForMe ? from : recipient;
        if(!other) return;

        const msgObj = { id: serverId, cid: parsed.cid || null, from, text, created_at: created };

        addOrUpdateMessageToCache(me.tf17, other, msgObj);

        // if currently viewing that chat ‚Äî render and mark read
        if(currentPartner && currentPartner.tf17 === other){
          renderConversation(me.tf17, other);
        } else if(isForMe){
          const c = ensureContactInList(other, null);
          c.unread = (c.unread||0) + 1;
          saveState();
          renderContacts();
        }
      }
    } catch(err){ console.warn("WS parse err", err); }
  };
  ws.onclose = ()=>{ wsStatus.textContent = "WS: d√©connect√©"; scheduleReconnect(); };
  ws.onerror = (e)=>{ console.warn("WS error", e); wsStatus.textContent = "WS: erreur"; try{ ws.close(); }catch(e){} };
}
function scheduleReconnect(){ if(reconnectTimer) return; reconnectTimer = setTimeout(()=>{ reconnectTimer=null; connectWS(); }, 3000); }

/* ========== UI INIT ========== */
async function initUI(){
  await registerFrontendIfNeeded();
  if(!me.tf17 && me.short){ me.tf17 = to17(me.short); saveState(); }
  renderMe(); renderContacts();

  if(!me.tf17){
    if(confirm("Vous n'√™tes pas identifi√©. Voulez-vous entrer votre TFID maintenant ?")) await promptForMe();
  } else {
    connectWS();
  }

  searchBtn.onclick = async ()=>{
    const raw = searchInput.value.trim();
    const digits = normalizeInputToDigits(raw);
    if(!digits){ alert("TFID invalide"); return; }
    const short = digits.slice(-7); const target17 = to17(short);
    ensureContactInList(target17, null);
    openChat(target17, contacts.find(x=>x.tf17===target17));
  };

  sendBtn.onclick = ()=>{ const t = messageInput.value.trim(); if(!t) return; messageInput.value=""; sendToCurrent(t); };
  messageInput.onkeydown = (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); } };
  document.getElementById("newContactBtn").onclick = ()=>{ const v = prompt("Entrer TFID du nouveau contact (ex: TF-0204143 ou 0204143):"); if(!v) return; const d = normalizeInputToDigits(v); if(!d){ alert("TFID invalide"); return; } const tf17 = to17(d.slice(-7)); const name = prompt("Nom (optionnel) :"); const c = ensureContactInList(tf17, name||null); if(name) c.name = name; saveState(); renderContacts(); };
  document.getElementById("settingsBtn").onclick = async ()=>{ const newShort = prompt("Modifier votre TFID (ex: TF-0204143 ou 0204143) :", me.short||""); if(newShort){ const d = normalizeInputToDigits(newShort); if(!d){ alert("TFID invalide"); } else { me.short = d.slice(-7); me.tf17 = to17(me.short); } } const newName = prompt("Pseudo / nom affich√© :", me.name||""); if(newName) me.name = newName; saveState(); renderMe(); renderContacts(); if(ws){ try{ ws.close(); }catch(e){} } connectWS(); };

  if(contacts.length>0) openChat(contacts[0].tf17, contacts[0]);
}

initUI();
</script>
</body>
            </html>
