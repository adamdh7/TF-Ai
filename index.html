<!doctype html>

<html lang="ht">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TF-Chat — UI</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#000; --panel:#070707; --text:#e6eefb; --muted:#9aa6bf; --card:#0b0b0b; --accent:#0b81ff; --header-h:56px; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Roboto,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
header{position:fixed;left:0;right:0;top:0;height:var(--header-h);display:flex;align-items:center;justify-content:space-between;background:var(--panel);z-index:1000;border-bottom:1px solid rgba(255,255,255,0.03);padding:0 12px}
.app-title{font-weight:700;font-size:18px;cursor:pointer}
.tabs{display:flex;gap:8px;align-items:center}
.tab{padding:8px 12px;border-radius:12px;cursor:pointer}
.tab.active{background:rgba(255,255,255,0.03)}
main{position:fixed;left:0;right:0;top:var(--header-h);bottom:0;overflow:auto;padding:12px}
.container{max-width:980px;margin:0 auto}
.row{display:flex;gap:12px}
.col{flex:1}
.search{padding:8px 0}
.search-box{display:flex;align-items:center;gap:8px;background:var(--card);padding:10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);width:100%}
.search-box input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:15px}
.search-btn{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.list{margin-top:12px}
.contact{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer}
.contact:hover{background:rgba(255,255,255,0.02)}
.avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:var(--text);flex-shrink:0;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.meta{flex:1;min-width:0}
.meta-top{display:flex;justify-content:space-between;align-items:flex-start}
.name{font-weight:600;font-size:16px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.time{font-size:12px;color:var(--muted)}
.meta-bottom{display:flex;justify-content:space-between;margin-top:6px;align-items:center}
.snippet{font-size:13px;color:var(--muted);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.badge{background:var(--accent);color:white;padding:4px 8px;border-radius:999px;font-weight:600;font-size:13px}
.muted{text-align:center;color:var(--muted);padding:20px}
/* messages */
.messages-wrap{padding:12px;height:calc(100% - 56px - 84px);overflow:auto;display:flex;flex-direction:column;gap:8px}
.messages{display:flex;flex-direction:column;gap:8px}
.msg{max-width:74%;padding:10px;border-radius:12px;margin-bottom:4px}
.msg.bot{background:#121212;color:var(--text);align-self:flex-start}
.msg.user{background:linear-gradient(180deg,var(--accent),#0563c9);color:white;align-self:flex-end}
.chat-input{display:flex;gap:8px;align-items:center;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:transparent}
.input{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:var(--card);color:var(--text);outline:none}
.send-btn{background:transparent;border:0;padding:8px;border-radius:10px;cursor:pointer;color:var(--accent)}
.bottom-right { position: fixed; right: 16px; bottom: 16px; z-index: 1100; display:flex; gap:8px; align-items:center; }
/* modals */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1300}
.modal{background:#fff;color:#0b1220;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.3);width:calc(100% - 40px);max-width:520px}
.modal.fullscreen{width:100%;height:100%;max-width:none;border-radius:0;padding:0;display:flex;flex-direction:column}
.modal .row{margin-bottom:12px}
.form-field{margin-bottom:10px}
.form-field label{display:block;font-size:13px;color:#374151;margin-bottom:6px}
.form-field input[type=text], .form-field textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3}
.circle-chooser{width:84px;height:84px;border-radius:50%;background:#f3f4f6;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
.circle-chooser img{width:100%;height:100%;object-fit:cover}
.grid-2{display:flex;gap:8px}
/* profile modal dark */
.profile-full{background:rgba(0,0,0,0.96);color:var(--text);height:100%;display:flex;flex-direction:column}
.profile-full .top{height:56px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px}
.profile-full .content{padding:18px;overflow:auto}
.small{font-size:12px;color:var(--muted)}
@media (min-width:900px){main{max-width:700px;margin:0 auto}}
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="app-title" id="appTitle">TF-Chat</div>
      <div class="tabs">
        <div class="tab active" id="tabAccueil">Accueil</div>
        <div class="tab" id="tabGroupes">Groupe</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="openProfileBtn" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer">Mon profil</button>
    </div>
  </header>  <main>
    <div class="container">
      <!-- ACCUEIL -->
      <section id="viewAccueil">
        <div class="search">
          <div class="search-box" role="search">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
            <input id="searchInput" placeholder="Recherche (TFID ou 7 chif)" aria-label="Recherche" />
            <button id="searchBtn" class="search-btn">Rechercher</button>
          </div>
        </div>
        <div id="contactsSection" class="list"></div>
      </section><!-- GROUPES -->
  <section id="viewGroupes" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h3 style="margin:0">Mes groupes</h3>
      <div>
        <button id="btnCreateGroup" style="padding:8px 12px;border-radius:8px;background:var(--accent);border:none;color:#fff;cursor:pointer">Créer un groupe</button>
      </div>
    </div>
    <div id="groupsList" class="list" style="margin-top:12px"></div>
  </section>
</div>

  </main>  <!-- Chat modal (private or group) -->  <div class="modal-backdrop" id="chatModalBackdrop">
    <div class="modal fullscreen" id="chatModal">
      <div style="height:56px;display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.08);background:var(--panel);color:var(--text)">
        <button id="chatBack" style="background:transparent;border:0;color:var(--text);cursor:pointer">←</button>
        <div style="flex:1;text-align:center;font-weight:700;cursor:pointer" id="chatTitle">Chat</div>
        <div style="width:44px"></div>
      </div>
      <div class="messages-wrap">
        <div class="messages" id="messages"></div>
      </div>
      <div class="chat-input" id="chatInputRow">
        <input id="chatText" class="input" placeholder="Ekri mesaj..." autocomplete="off" />
        <button id="sendBtn" class="send-btn">Envoyer</button>
      </div>
    </div>
  </div>  <!-- Create group modal -->  <div class="modal-backdrop" id="createGroupBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 style="margin:0 0 12px 0">Créer un groupe</h3>
      <div class="grid-2" style="align-items:flex-start;margin-bottom:12px">
        <div class="circle-chooser" id="groupAvatarChooser" title="Choisir une image"></div>
        <div style="flex:1">
          <div class="form-field">
            <label>Nom (obligatoire)</label>
            <input type="text" id="groupNameInput" placeholder="Ex: haiti-chat" />
          </div>
          <div class="form-field">
            <label>Bio (optionnel)</label>
            <textarea id="groupBioInput" rows="3" placeholder="Une courte description..."></textarea>
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="groupCancel" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:white;cursor:pointer">Retour</button>
        <button id="groupCreate" style="padding:8px 12px;border-radius:8px;background:#007aff;color:white;border:none;cursor:pointer">Valider</button>
      </div>
    </div>
  </div>  <!-- Profile fullscreen modal (Accueil behaviour) -->  <div class="modal-backdrop" id="homeProfileBackdrop">
    <div class="modal fullscreen profile-full" role="dialog" aria-modal="true">
      <div class="top"><button id="homeProfileBack" style="background:transparent;border:0;color:var(--text);cursor:pointer">←</button><div style="font-weight:800">Mon profil</div><div style="width:44px"></div></div>
      <div class="content">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <div class="circle-chooser" id="homeAvatarChooser"></div>
          <div>
            <div id="homeName" style="font-weight:800;font-size:18px">Utilisateur</div>
            <div id="homeTfid" class="small">TF-0000000</div>
          </div>
        </div>
        <div style="margin-bottom:12px">
          <div class="small">Liste des fichiers:</div>
          <div id="homeFilesList" style="margin-top:8px" class="muted">(7 previously image/video)</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="homeValidate" style="padding:8px 12px;border-radius:8px;background:var(--accent);border:none;color:white;cursor:pointer">Valider</button>
          <button id="homeRetour" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:white;cursor:pointer">Retour</button>
        </div>
      </div>
    </div>
  </div>  <!-- hidden file inputs -->  <input type="file" id="groupFileInput" accept="image/*" style="display:none" />
  <input type="file" id="homeFileInput" accept="image/*" style="display:none" /><script>
/* ================= CONFIG ================= */
const API_BASE = (location.hostname==='localhost' || location.hostname.endsWith('.local')) ? 'http://localhost:10000' : (location.origin.replace(/:\d+$/,'')+':10000');
// If your server is at different host, set API_BASE manually.
const FRONTEND_NAME = 'site1';
const ADMIN_API_TOKEN = localStorage.getItem('tfchat.admin_token') || ''; // set once in settings if needed
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + (location.hostname || 'localhost') + ':10000/ws';

/* ================= STATE ================= */
let me = { short: localStorage.getItem('tfchat.me.short') || '', tf17: localStorage.getItem('tfchat.me.17') || '', name: localStorage.getItem('tfchat.me.name') || 'Utilisateur', avatar: localStorage.getItem('tfchat.me.avatar') || null };
let contacts = JSON.parse(localStorage.getItem('tfchat.contacts') || '[]');
let groups = [];
let currentPartner = null; // {type:'user'|'group', id: tf17 or group_name}
let ws = null;

/* ================= HELPERS ================= */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function normalizeDigits(s){ if(!s) return null; const d=String(s).replace(/[^0-9]/g,''); return d||null; }
function to17(s){ if(!s) return null; const d=String(s).replace(/[^0-9]/g,''); return d.length>17?d.slice(-17):d.padStart(17,'0'); }
function formatShort(tf17){ if(!tf17) return ''; const s=String(tf17).replace(/[^0-9]/g,''); return 'TF-'+s.slice(-7).padStart(7,'0'); }
function saveLocal(){ localStorage.setItem('tfchat.me.short', me.short||''); localStorage.setItem('tfchat.me.17', me.tf17||''); localStorage.setItem('tfchat.me.name', me.name||''); if(me.avatar) localStorage.setItem('tfchat.me.avatar', me.avatar); localStorage.setItem('tfchat.contacts', JSON.stringify(contacts||[])); }

/* ================= DOM REFS ================= */
const tabAccueil = document.getElementById('tabAccueil');
const tabGroupes = document.getElementById('tabGroupes');
const viewAccueil = document.getElementById('viewAccueil');
const viewGroupes = document.getElementById('viewGroupes');
const contactsSection = document.getElementById('contactsSection');
const groupsListEl = document.getElementById('groupsList');
const btnCreateGroup = document.getElementById('btnCreateGroup');
const createGroupBackdrop = document.getElementById('createGroupBackdrop');
const groupAvatarChooser = document.getElementById('groupAvatarChooser');
const groupFileInput = document.getElementById('groupFileInput');
const groupNameInput = document.getElementById('groupNameInput');
const groupBioInput = document.getElementById('groupBioInput');
const groupCancel = document.getElementById('groupCancel');
const groupCreate = document.getElementById('groupCreate');

const chatModalBackdrop = document.getElementById('chatModalBackdrop');
const chatTitle = document.getElementById('chatTitle');
const messagesEl = document.getElementById('messages');
const chatText = document.getElementById('chatText');
const sendBtn = document.getElementById('sendBtn');
const chatBack = document.getElementById('chatBack');

const appTitle = document.getElementById('appTitle');
const openProfileBtn = document.getElementById('openProfileBtn');
const homeProfileBackdrop = document.getElementById('homeProfileBackdrop');
const homeAvatarChooser = document.getElementById('homeAvatarChooser');
const homeFileInput = document.getElementById('homeFileInput');
const homeNameEl = document.getElementById('homeName');
const homeTfidEl = document.getElementById('homeTfid');
const homeValidate = document.getElementById('homeValidate');
const homeRetour = document.getElementById('homeRetour');

/* ================= INIT ================= */
function initUI(){ renderContacts(); bindEvents(); loadGroupsIfPossible(); updateHomeProfile(); }

/* ================= RENDER CONTACTS ================= */
function renderContacts(){ contactsSection.innerHTML=''; if(contacts.length===0){ contactsSection.innerHTML='<div class="muted">Pa gen kontak. Rechèch yon TFID oswa ajoute yon kontak.</div>'; return; } for(const c of contacts){ const el=document.createElement('div'); el.className='contact'; el.dataset.tf17=c.tf17; const avatarHtml = c.avatar?`<img src="${escapeHtml(c.avatar)}"/>`:escapeHtml((c.name||formatShort(c.tf17)).slice(0,2)); el.innerHTML=`<div class="avatar">${avatarHtml}</div><div class="meta"><div class="meta-top"><div class="name">${escapeHtml(c.name||formatShort(c.tf17))}</div><div class="time">${c.lastTs?timeAgo(c.lastTs):''}</div></div><div class="meta-bottom"><div class="snippet">${escapeHtml(c.lastMsg||'')}</div><div>${c.unread?'<span class="badge">'+c.unread+'</span>':''}</div></div></div>`; el.addEventListener('click', ()=> openChatWithUser(c.tf17,c)); contactsSection.appendChild(el); } }
function timeAgo(ts){ if(!ts) return ''; const diff=Math.floor((Date.now()-ts)/1000); if(diff<60) return diff+'s'; if(diff<3600) return Math.floor(diff/60)+'m'; if(diff<86400) return Math.floor(diff/3600)+'h'; return new Date(ts).toLocaleDateString(); }

/* ================= GROUPS ================= */
async function loadGroupsIfPossible(){ if(!me.tf17) return; try{ const resp = await fetch(`${API_BASE}/api/groups?tfid=${encodeURIComponent(me.tf17)}`); const json = await resp.json(); if(resp.ok && json.ok){ groups = json.groups || []; renderGroups(); } else { console.warn('groups load failed', json); } }catch(e){ console.warn('groups load error', e); } }
function renderGroups(){ groupsListEl.innerHTML=''; if(!groups || groups.length===0){ groupsListEl.innerHTML='<div class="muted">Vous avez aucun groupe pour l\'instant</div>'; return; } for(const g of groups){ const el=document.createElement('div'); el.className='contact'; el.dataset.group = g.name; const avatarHtml = g.avatar_url?`<img src="${escapeHtml(g.avatar_url)}"/>` : escapeHtml((g.name||'').slice(0,2)); el.innerHTML = `<div class="avatar">${avatarHtml}</div><div class="meta"><div class="meta-top"><div class="name">${escapeHtml(g.name)}</div><div class="time">${g.created_at?new Date(g.created_at).toLocaleDateString():''}</div></div><div class="meta-bottom"><div class="snippet">${escapeHtml(g.bio||'')}</div><div></div></div></div>`; el.addEventListener('click', ()=> openGroupChat(g.name)); groupsListEl.appendChild(el); } }

/* ================= CREATE GROUP ================= */
let stagedGroupAvatar = null; // url from upload
groupAvatarChooser.addEventListener('click', ()=> groupFileInput.click());
groupFileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0]; if(!f) return; await uploadAndSetGroupAvatar(f); groupFileInput.value='';
});
async function uploadAndSetGroupAvatar(file){ if(!file) return; const fd=new FormData(); fd.append('file', file); try{ const r=await fetch(API_BASE+'/upload',{method:'POST',body:fd}); const j=await r.json(); if(r.ok && j.ok && j.url){ stagedGroupAvatar=j.url; groupAvatarChooser.innerHTML=`<img src="${j.url}"/>`; } else { alert('Upload échwe'); console.warn('upload',j); } }catch(e){ console.warn('upload err',e); alert('Upload échwe: '+e.message); } }

btnCreateGroup.addEventListener('click', ()=>{ groupNameInput.value=''; groupBioInput.value=''; stagedGroupAvatar=null; groupAvatarChooser.innerHTML='+'; createGroupBackdrop.style.display='flex'; });
groupCancel.addEventListener('click', ()=>{ createGroupBackdrop.style.display='none'; });
groupCreate.addEventListener('click', async ()=>{
  const name = (groupNameInput.value||'').trim(); const bio = (groupBioInput.value||'').trim(); if(!name){ alert('Nom obligatoire'); return; }
  try{
    const payload = { name, owner_name: me.name || null, bio: bio||null, avatar_url: stagedGroupAvatar||null };
    const r = await fetch(API_BASE+'/admin/groups/create',{method:'POST',headers:{'Content-Type':'application/json','x-api-token':ADMIN_API_TOKEN},body:JSON.stringify(payload)});
    const j = await r.json(); if(!r.ok || !j.ok){ alert('Création du groupe échoué: '+(j.error||j?.message||r.status)); console.warn('create group',j); return; }
    // add current user to group members (so they appear in group)
    if(me.tf17){ await fetch(API_BASE+'/admin/groups/add',{method:'POST',headers:{'Content-Type':'application/json','x-api-token':ADMIN_API_TOKEN},body:JSON.stringify({group_name:name, tfid:me.tf17})}); }
    createGroupBackdrop.style.display='none'; await loadGroupsIfPossible(); alert('Groupe créé: '+name);
  }catch(e){ console.error('create group error',e); alert('Erreur: '+e.message); }
});

/* ================= CHAT (user/group) ================= */
chatBack.addEventListener('click', ()=>{ chatModalBackdrop.style.display='none'; currentPartner=null; history.replaceState({},'', '/'); });
sendBtn.addEventListener('click', sendMessage);
chatText.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } });

async function openChatWithUser(tf17, contact){ currentPartner={type:'user', id:tf17}; chatTitle.textContent = contact?.name || formatShort(tf17); await loadConversation(me.tf17, tf17); chatModalBackdrop.style.display='flex'; history.pushState({tfchat:tf17},'', '/'+encodeURIComponent(tf17)); }

async function openGroupChat(groupName){ currentPartner={type:'group', id:groupName}; chatTitle.textContent = '#'+groupName; await loadGroupConversation(groupName); chatModalBackdrop.style.display='flex'; history.pushState({tfgroup:groupName},'', '/groupe/'+encodeURIComponent(groupName)); }

async function loadConversation(me17, other17){ messagesEl.innerHTML='<div class="muted">Chaje mesaj...</div>'; try{ const out = await apiList(other17); const inb = await apiList(me17); const msgs = [];
    function pushRow(r, expectedFrom){ try{ const p = JSON.parse(r.content); if(p && p.from===expectedFrom){ msgs.push({from:p.from,text:p.text||p.message, time:p.time||r.created_at}); } }catch(e){} }
    out.forEach(r=>pushRow(r, me17)); inb.forEach(r=>pushRow(r, other17)); msgs.sort((a,b)=>new Date(a.time)-new Date(b.time)); renderMessages(msgs, me17);
  }catch(e){ messagesEl.innerHTML='<div class="muted">Erè lè ap chaje: '+escapeHtml(e.message||e)+'</div>'; }
}

async function loadGroupConversation(groupName){ messagesEl.innerHTML='<div class="muted">Chaje mesaj...</div>'; try{ const url = `${API_BASE}/api/group/messages?name=${encodeURIComponent(FRONTEND_NAME)}&group_name=${encodeURIComponent(groupName)}&tfid=${encodeURIComponent(me.tf17)}`; const r = await fetch(url); const j = await r.json(); if(r.ok && j.ok){ const rows = j.rows||[]; const msgs = rows.map(rw=>{ let parsed=null; try{ parsed=JSON.parse(rw.content);}catch(e){} const text = parsed?.text||parsed?.message||rw.content; const from = parsed?.from||rw.tfid; const time = parsed?.time||rw.created_at; return {from,text,time}; }); msgs.sort((a,b)=>new Date(a.time)-new Date(b.time)); renderMessages(msgs, me.tf17); } else { messagesEl.innerHTML='<div class="muted">Pa gen mesaj pou group sa.</div>'; } }catch(e){ messagesEl.innerHTML='<div class="muted">Erè: '+escapeHtml(e.message||e)+'</div>'; } }

function renderMessages(msgs, me17){ messagesEl.innerHTML=''; if(!msgs || msgs.length===0){ messagesEl.innerHTML='<div class="muted">Pa gen mesaj ankò.</div>'; return; } for(const m of msgs){ const d=document.createElement('div'); d.className='msg '+((m.from===me17)?'user':'bot'); const ts = m.time?new Date(m.time).toLocaleString():''; d.innerHTML=`<div>${escapeHtml(m.text)}</div><div style="font-size:11px;color:var(--muted);margin-top:6px">${formatShort(m.from||'')} • ${ts}</div>`; messagesEl.appendChild(d); } setTimeout(()=>{ const wrap=document.querySelector('.messages-wrap'); if(wrap) wrap.scrollTop = wrap.scrollHeight; },50); }

async function sendMessage(){ const txt=chatText.value.trim(); if(!txt || !currentPartner) return; if(!me.tf17){ alert('Mete TFID nan Paramètres.'); return; }
  const now = new Date().toISOString(); const cid = 'c-'+Date.now();
  if(currentPartner.type==='user'){
    const payload = { type:'text', from:me.tf17, text:txt, time:now, cid, name:me.name||null };
    try{ await apiAdd(currentPartner.id, payload); chatText.value=''; await loadConversation(me.tf17, currentPartner.id); }catch(e){ alert('Send failed: '+e.message); }
  } else if(currentPartner.type==='group'){
    const payload = { type:'group', from:me.tf17, text:txt, time:now, cid, name:me.name||null, group: currentPartner.id };
    try{ const resp = await fetch(API_BASE+'/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ group_name: currentPartner.id, name: FRONTEND_NAME, content: JSON.stringify(payload) })}); const j=await resp.json(); if(!resp.ok || !j.ok){ alert('Send group failed'); console.warn('group send',j); } else { chatText.value=''; await loadGroupConversation(currentPartner.id); } }catch(e){ alert('Erreur: '+e.message); }
  }
}

/* ================= API helpers ================= */
async function apiList(tf17){ const url = `${API_BASE}/api/list?tfid=${encodeURIComponent(tf17)}&name=${encodeURIComponent(FRONTEND_NAME)}`; const r = await fetch(url); const j = await r.json().catch(()=>null); if(!r.ok) throw new Error(j?.error||'HTTP '+r.status); return j.rows||[]; }
async function apiAdd(recipient17, contentObj){ const body = { tfid: recipient17, name: FRONTEND_NAME, content: JSON.stringify(contentObj), source_url: location.origin }; const r = await fetch(API_BASE+'/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); const j = await r.json().catch(()=>null); if(!r.ok) throw new Error(j?.error||'HTTP '+r.status); return j; }

/* ================= HOME PROFILE (Accueil) ================= */
homeAvatarChooser.addEventListener('click', ()=> homeFileInput.click());
homeFileInput.addEventListener('change', async (ev)=>{ const f = ev.target.files && ev.target.files[0]; if(!f) return; await uploadAndSetHomeAvatar(f); homeFileInput.value=''; });
async function uploadAndSetHomeAvatar(file){ const fd = new FormData(); fd.append('file', file); try{ const r = await fetch(API_BASE+'/upload',{method:'POST',body:fd}); const j = await r.json(); if(r.ok && j.ok && j.url){ me.avatar = j.url; saveLocal(); updateHomeProfile(); // push profile update to contacts and groups
      if(me.tf17){ const now=new Date().toISOString(); for(const c of contacts){ if(!c || !c.tf17 || c.tf17===me.tf17) continue; const payload={ type:'profile', from:me.tf17, name:me.name||null, photo:j.url, time:now }; fetch(API_BASE+'/api/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ tfid: c.tf17, name: FRONTEND_NAME, content: JSON.stringify(payload) })}).catch(()=>{}); }
      }
    } else { alert('Upload échoué'); }
  }catch(e){ alert('Upload échoué: '+e.message); } }

function updateHomeProfile(){ homeNameEl.textContent = me.name || 'Utilisateur'; homeTfidEl.textContent = me.tf17 || formatShort(me.tf17||''); if(me.avatar) homeAvatarChooser.innerHTML = `<img src="${me.avatar}"/>`; else homeAvatarChooser.innerHTML = '+'; }

openProfileBtn.addEventListener('click', ()=>{ homeProfileBackdrop.style.display='flex'; });
homeRetour.addEventListener('click', ()=>{ homeProfileBackdrop.style.display='none'; });
homeProfileBack.addEventListener('click', ()=>{ homeProfileBackdrop.style.display='none'; });
homeValidate.addEventListener('click', ()=>{ // already uploaded when chosen; we can also re-notify contacts here
  homeProfileBackdrop.style.display='none'; alert('Photo profil mise à jour'); });

/* ================= WEBSOCKET (receive messages) ================= */
function connectWS(){ if(!me.tf17) return; try{ ws = new WebSocket(WS_URL); }catch(e){ console.warn('ws open err',e); return; } ws.onopen = ()=>{ try{ ws.send(JSON.stringify({ type:'subscribe', tfid: me.tf17 })); }catch(e){} }; ws.onmessage = (ev)=>{ try{ const d = JSON.parse(ev.data); if(d.type==='message'){ // stored messages coming in
        let parsed=null; try{ parsed = JSON.parse(d.content); }catch(e){} const payload = d; if(!parsed || !parsed.from) return; const recipient = payload.tfid; const from = parsed.from; const other = (recipient===me.tf17)?from:recipient; // determine chat partner
        // notify and refresh lists
        if(parsed.type==='profile' && parsed.photo){ const c = ensureContactInList(other, parsed.name||null); c.avatar = parsed.photo; c.name = parsed.name||c.name; c.lastTs = Date.now(); saveLocal(); renderContacts(); }
        if(parsed.type==='group'){ // group message -> refresh group view if open
          if(currentPartner && currentPartner.type==='group' && currentPartner.id === parsed.group){ loadGroupConversation(parsed.group); }
        } else {
          // private
          if(currentPartner && currentPartner.type==='user' && currentPartner.id===other){ loadConversation(me.tf17, other); }
          else { const c = ensureContactInList(other, parsed.name||null); c.unread = (c.unread||0)+1; c.lastMsg = parsed.text || ''; c.lastTs = Date.now(); saveLocal(); renderContacts(); }
        }
      }
    }catch(e){ console.warn('ws parse err', e); } };
  ws.onclose = ()=>{ setTimeout(()=>connectWS(),3000); };
  ws.onerror = (e)=>{ console.warn('ws err', e); try{ ws.close(); }catch(_){} };
}

/* ================= CONTACTS util ================= */
function ensureContactInList(tf17,name){ let c = contacts.find(x=>x.tf17===tf17); if(!c){ c={tf17,name:name||formatShort(tf17),lastMsg:'',lastTs:Date.now(),unread:0,avatar:null}; contacts.unshift(c); saveLocal(); renderContacts(); } return c; }

/* ================= BIND EVENTS for tabs and search ================= */
function bindEvents(){ tabAccueil.addEventListener('click', ()=>{ tabAccueil.classList.add('active'); tabGroupes.classList.remove('active'); viewAccueil.style.display='block'; viewGroupes.style.display='none'; }); tabGroupes.addEventListener('click', ()=>{ tabGroupes.classList.add('active'); tabAccueil.classList.remove('active'); viewGroupes.style.display='block'; viewAccueil.style.display='none'; loadGroupsIfPossible(); }); document.getElementById('searchBtn').addEventListener('click', ()=>{ const q=document.getElementById('searchInput').value.trim(); performSearchQuery(q); }); document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ performSearchQuery(e.target.value.trim()); } }); appTitle.addEventListener('click', ()=>{ // open profile fullscreen (Accueil behaviour) homeProfileBackdrop.style.display='flex'; }); window.addEventListener('popstate', (ev)=>{ const s = ev.state; if(s && s.tfgroup) openGroupChat(s.tfgroup); else if(s && s.tfchat) openChatWithUser(s.tfchat); else { chatModalBackdrop.style.display='none'; } }); }

async function performSearchQuery(raw){ if(!raw) return; const digits = normalizeDigits(raw); if(!digits){ // fallback to local render
    return; } if(digits.length<7){ alert('TFID dwe gen omwen 7 chif.'); return; } const short7 = digits.slice(-7); const tf17 = to17(short7); let local = contacts.find(c=>c.tf17===tf17); if(local){ openChatWithUser(local.tf17, local); return; } try{ const rows = await apiList(tf17); if(rows && rows.length>0){ const last = rows[rows.length-1]; let nameFrom=null; try{ const p = JSON.parse(last.content); nameFrom = p.name || null; }catch(e){} const c={tf17, name: nameFrom || formatShort(tf17), lastMsg: last.content||'', lastTs: Date.now(), unread:0, avatar:null}; contacts.unshift(c); saveLocal(); renderContacts(); openChatWithUser(c.tf17,c); return; } else { if(confirm('Pa jwenn done sou servèr. Kreye kontak lokal pou TFID sa a?')){ const c={tf17, name: formatShort(tf17), lastMsg:'', lastTs:Date.now(), unread:0, avatar:null}; contacts.unshift(c); saveLocal(); renderContacts(); openChatWithUser(c.tf17,c); } } }catch(e){ alert('Erè lè w ap chèche: '+e.message); } }

/* ================= BOOT ================= */
initUI(); if(me.tf17) { connectWS(); } else { // try recall short -> auto open profile modal
  const shown = localStorage.getItem('tfchat.settings_shown_once'); if(!shown){ homeProfileBackdrop.style.display='flex'; localStorage.setItem('tfchat.settings_shown_once','1'); }
}

// expose some for debug
window._tf_me = me; window._tf_contacts = contacts; window._tf_groups = groups;

</script></body>
                                                                                                                                                                                                                    </html>
