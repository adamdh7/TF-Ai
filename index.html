<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>TF-Chat — iOS style</title>
<style>
:root{
  --bg:#f2f2f5; --card:#fff; --muted:#8e8e93; --accent:#128C7E; --green:#25D366;
  --bubble-me:#DCF8C6; --bubble-other:#fff; --maxw:980px; --narrow:460px; --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial;background:var(--bg);-webkit-font-smoothing:antialiased;color:#111}
.app{max-width:var(--maxw);margin:0 auto;height:100vh;display:flex;flex-direction:column;border-left:1px solid rgba(0,0,0,0.04);border-right:1px solid rgba(0,0,0,0.04)}
.header{height:88px;display:flex;align-items:flex-end;padding:14px 16px;background:linear-gradient(180deg, rgba(255,255,255,0.95), transparent)}
.h-left{display:flex;gap:12px;align-items:center}
.h-title{font-weight:800;font-size:22px}
.h-sub{font-size:12px;color:var(--muted)}
.container{flex:1;overflow:auto;padding:12px 12px 100px}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
.search{width:100%;padding:10px;border-radius:12px;border:1px solid #eee;background:#fff;margin-bottom:10px;font-size:15px}
.row{display:flex;align-items:center;gap:12px}
.avatar{width:56px;height:56px;border-radius:50%;background:#ddd;overflow:hidden;flex-shrink:0}
.avatar.large{width:92px;height:92px;border-radius:50%}
.avatar img{width:100%;height:100%;object-fit:cover}
.list{display:flex;flex-direction:column;gap:8px}
.contact{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:#fff;cursor:pointer;border:1px solid #f0f0f0}
.contact .info{flex:1}
.contact .name{font-weight:700}
.contact .meta{font-size:13px;color:var(--muted)}
.fab{position:fixed;right:18px;bottom:120px;width:62px;height:62px;border-radius:31px;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-size:30px;cursor:pointer;z-index:120;box-shadow:0 8px 20px rgba(0,0,0,0.12)}
.tabbar{height:64px;border-top:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:space-around;background:transparent;position:fixed;left:0;right:0;bottom:0;max-width:var(--maxw);margin:0 auto}
.tab{font-size:13px;color:var(--muted);cursor:pointer;width:33%;text-align:center;padding:10px 0}
.page{width:100%;max-width:var(--narrow);height:94vh;background:var(--card);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;margin:12px auto}
.chat-page{position:relative;display:flex;flex-direction:column;height:100%}
.chat-head{height:78px;display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee;background:var(--card)}
.chat-body{flex:1;overflow:auto;padding:14px;background:linear-gradient(#f2f2f5,#f2f2f5)}
.messages{display:flex;flex-direction:column;gap:10px}
.bubble{max-width:78%;padding:10px 12px;border-radius:16px;background:var(--bubble-other);align-self:flex-start;white-space:pre-wrap;word-break:break-word}
.bubble.me{background:var(--bubble-me);align-self:flex-end}
.time{display:block;font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
.composer{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;align-items:center;background:var(--card);position:sticky;bottom:0}
.composer input{flex:1;padding:10px;border-radius:20px;border:1px solid #eee;font-size:15px}
.btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(18,140,126,0.12)}
.small{font-size:12px;color:var(--muted)}
.link-tfid{color:var(--accent);cursor:pointer;text-decoration:underline}
.center{display:flex;align-items:center;justify-content:center}
@media(min-width:900px){
  .page{max-width:720px}
  .fab{right:calc((100% - var(--maxw))/2 + 18px)}
  .tabbar{left:calc((100% - var(--maxw))/2);right:calc((100% - var(--maxw))/2)}
}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="h-left">
      <div class="avatar" id="hdrAvatar"></div>
      <div>
        <div class="h-title">TF-Chat</div>
        <div class="h-sub" id="hdrSub">Conversations</div>
      </div>
    </div>
    <div style="margin-left:auto">
      <button class="btn ghost" id="btnParams">Paramètres</button>
    </div>
  </div>

  <div class="container" id="container"></div>

  <div class="fab" id="fab" title="Ajouter">＋</div>

  <div class="tabbar" role="tablist">
    <div class="tab" id="tabAccueil">Accueil</div>
    <div class="tab" id="tabContacts">Contacts</div>
    <div class="tab" id="tabParamsFooter">Paramètres</div>
  </div>
</div>

<script>
/* TF-Chat simplified & adaptive
   - Auto-generate TFID for visitor and save in localStorage
   - No forced login; user can change name/avatar in Paramètres
   - Clickable TFID in messages opens contact page
   - Backend: https://tf-sove.onrender.com (x-api-token below)
*/
const CONFIG = {
  saveHost: "https://tf-sove.onrender.com",
  apiAdd: "/api/add",
  apiList: "/api/list",
  apiToken: "tfstream_45dd9c02d4e34f18a42d",
  frontendName: "Adam_DH7",
  uiDigits: 7,
  serverDigits: 17,
  pollMs: 2500,
  sessionKey: "tfchat_session"
};

let state = {
  me: null,        // { uiTfid, serverTfid, name, avatarDataUrl }
  contacts: [],    // list of {name, uiTfid, serverTfid}
  messages: {},    // serverTfid => [{...}]
  pollId: null
};

/* DOM refs */
const container = document.getElementById('container');
const fab = document.getElementById('fab');
const hdrAvatar = document.getElementById('hdrAvatar');
document.getElementById('tabAccueil').onclick = () => navigateTo('/Accueil');
document.getElementById('tabContacts').onclick = () => navigateTo('/contacts');
document.getElementById('tabParamsFooter').onclick = () => navigateTo('/parametres');
document.getElementById('btnParams').onclick = () => navigateTo('/parametres');
fab.onclick = () => openAddMenu();

/* Helpers */
function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function nowISO(){ return new Date().toISOString(); }
function extractDigits(s){ const m=String(s||'').match(/\d+/g); return m?m.join(''):null; }
function uiNormalize(v){ v=String(v||'').trim(); if(!v) return ''; if(v.startsWith('TF-')) return v; const d=extractDigits(v)||''; return 'TF-'+d.padStart(CONFIG.uiDigits,'0'); }
function uiRandom(){ return 'TF-'+Math.floor(Math.random()*1e7).toString().padStart(CONFIG.uiDigits,'0'); }
function uiToServer(ui){ const digits = extractDigits(ui); if(!digits) throw new Error('TFID invalide'); return digits.padStart(CONFIG.serverDigits,'0'); }
function saveSession(){ if(state.me) localStorage.setItem(CONFIG.sessionKey, JSON.stringify(state.me)); else localStorage.removeItem(CONFIG.sessionKey); }
function loadSession(){ const s=localStorage.getItem(CONFIG.sessionKey); if(!s) return null; try{return JSON.parse(s);}catch(e){return null;} }
function prettyTime(iso){ try{ const d=new Date(iso); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){return '';} }

/* Network */
async function postSave(targetServerTfid, contentObj){
  const body = { tfid: targetServerTfid, name: CONFIG.frontendName, content: JSON.stringify(contentObj) };
  const resp = await fetch(CONFIG.saveHost + CONFIG.apiAdd, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'x-api-token': CONFIG.apiToken },
    body: JSON.stringify(body)
  });
  if(!resp.ok) throw new Error('save failed '+resp.status);
  return resp.json().catch(()=>null);
}
async function listSave(serverTfid){
  const url = new URL(CONFIG.saveHost + CONFIG.apiList);
  url.searchParams.set('tfid', serverTfid);
  url.searchParams.set('name', CONFIG.frontendName);
  const resp = await fetch(url.toString(), { headers: { 'x-api-token': CONFIG.apiToken }});
  if(!resp.ok) throw new Error('list failed '+resp.status);
  const j = await resp.json().catch(()=>null);
  return (j && j.ok && Array.isArray(j.rows)) ? j.rows : [];
}

/* Polling */
function startPolling(){ stopPolling(); if(!state.me) return; pollOnce(); state.pollId = setInterval(pollOnce, CONFIG.pollMs); }
function stopPolling(){ if(state.pollId) clearInterval(state.pollId); state.pollId=null; }
async function pollOnce(){
  if(!state.me) return;
  try{
    const rows = await listSave(state.me.serverTfid);
    for(let i = rows.length -1; i >=0; i--){
      const r = rows[i];
      const tf = r.tfid;
      state.messages[tf] = state.messages[tf] || [];
      if(state.messages[tf].some(m=>m._remoteId===r.id)) continue;
      let payload;
      try{ payload = JSON.parse(r.content); }catch(e){ payload = { type:'text', text:r.content }; }
      if(payload.type === 'text' || payload.type === 'file'){
        const msg = { _remoteId: r.id, from: payload.from || 'unknown', type: payload.type, text: payload.text || payload.message || null, time: r.created_at || nowISO() };
        state.messages[tf].push(msg);
        if(window.__renderChatFor) window.__renderChatFor(tf);
      } else if(payload.type === 'contact_add' && payload.contact){
        if(!state.contacts.some(c=>c.serverTfid===payload.contact.serverTfid)) state.contacts.unshift(payload.contact);
      }
    }
  }catch(e){ console.warn('poll', e); }
}

/* Routing */
function navigateTo(path, opts={replace:false}){ if(opts.replace) history.replaceState({path}, '', path); else history.pushState({path}, '', path); route(); }
window.addEventListener('popstate', route);
function route(){
  const p = location.pathname;
  if(p === '/konekte' || p === '/login') return renderKonekte();
  if(p === '/' || p === '/Accueil' || p === '/accueil') return renderAccueil();
  if(p === '/contacts') return renderContacts();
  if(p === '/parametres' || p === '/parametre') return renderParametres();
  if(p.startsWith('/chat/')) return openChatByUi(decodeURIComponent(p.slice(6)));
  if(p.startsWith('/name/')) return renderUserPage(decodeURIComponent(p.slice(6)));
  return renderAccueil();
}

/* Pages */

/* Konekte page - now visitor auto assigned TFID so this page offers change name/avatar */
function renderKonekte(){
  container.innerHTML = '';
  fab.style.display = 'none';
  const p = el('div'); p.className='page';
  const head = el('div'); head.className='head'; head.innerHTML = `<div style="flex:1;text-align:center"><strong>Se connecter / Profil</strong></div>`;
  p.appendChild(head);
  const content = el('div'); content.className='content';
  const sess = loadSession();
  if(sess){
    content.appendChild(el('h3')).textContent = 'Session existante';
    content.appendChild(el('div','small')).textContent = `${sess.name} • ${sess.uiTfid}`;
    const cont = el('div'); cont.style.marginTop='12px';
    const go = el('button','btn'); go.textContent='Continuer'; go.onclick = ()=> { state.me = sess; saveSession(); syncAfterLogin().then(()=>navigateTo('/Accueil')); };
    cont.appendChild(go);
    content.appendChild(cont);
  } else {
    content.appendChild(el('h3')).textContent = 'Bienvenue — un TFID a été créé pour vous';
    const ui = uiRandom();
    const item = el('div','card'); item.style.textAlign='center'; item.innerHTML = `<strong id="generatedUI">${ui}</strong><div class="small">Cliquez pour copier</div>`;
    item.onclick = ()=> { navigator.clipboard?.writeText(ui).catch(()=>{}); item.style.border='2px solid var(--accent)'; };
    content.appendChild(item);
    content.appendChild(el('div','small')).textContent = 'Complétez votre profil dans Paramètres';
    const go = el('button','btn'); go.textContent='Aller aux paramètres'; go.onclick = ()=> { state.me = { uiTfid: ui, serverTfid: uiToServer(ui), name: ui, avatarDataUrl: null }; saveSession(); navigateTo('/parametres'); };
    content.appendChild(go);
  }
  p.appendChild(content); container.appendChild(p);
  navigateTo('/konekte', {replace:true});
}

/* Accueil */
function renderAccueil(){
  container.innerHTML = '';
  fab.style.display = 'flex';
  const top = el('div','card'); top.appendChild(el('h3')).textContent = 'Accueil';
  top.appendChild(el('div','small')).textContent = state.me ? `${state.me.name} • ${state.me.uiTfid}` : 'Non configuré';
  container.appendChild(top);

  const search = el('input','search'); search.placeholder = 'Rechercher (nom ou TF-xxxxxxx)'; search.oninput = ()=> renderContactsList(search.value.trim());
  container.appendChild(search);

  const listWrap = el('div','list'); listWrap.id = 'contactsList'; container.appendChild(listWrap);
  renderContactsList();

  navigateTo('/Accueil', {replace:true});
}

/* Contacts page */
function renderContacts(){
  container.innerHTML = '';
  fab.style.display = 'none';
  const top = el('div','card'); top.appendChild(el('h3')).textContent = 'Contacts';
  container.appendChild(top);
  const listWrap = el('div','list'); listWrap.id = 'contactsList'; container.appendChild(listWrap);
  renderContactsList();
  navigateTo('/contacts', {replace:true});
}

/* Paramètres */
function renderParametres(){
  container.innerHTML = ''; fab.style.display='none';
  const p = el('div'); p.className='page';
  const head = el('div'); head.className='head'; head.innerHTML = `<button class="btn ghost" id="backP">Retour</button><div style="flex:1;text-align:center"><strong>Paramètres</strong></div>`; head.querySelector('#backP').onclick = ()=> history.back();
  p.appendChild(head);
  const content = el('div'); content.className='content';
  // Profile editor
  content.appendChild(el('h3')).textContent = 'Profil';
  const avatar = el('div','avatar'); avatar.style.margin='10px'; avatar.style.width='92px'; avatar.style.height='92px'; if(state.me && state.me.avatarDataUrl) avatar.innerHTML = `<img src="${state.me.avatarDataUrl}">`;
  const file = el('input'); file.type='file'; file.accept='image/*'; file.onchange = e=> { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ avatar.innerHTML=`<img src="${r.result}">`; if(!state.me) state.me={uiTfid:uiRandom(),serverTfid:null,name:'',avatarDataUrl:null}; state.me.avatarDataUrl=r.result; state.me.serverTfid = state.me.serverTfid || uiToServer(state.me.uiTfid); saveSession(); }; r.readAsDataURL(f); };
  content.appendChild(avatar); content.appendChild(file);
  const nameIn = el('input'); nameIn.placeholder='Nom / pseudo'; nameIn.style.width='100%'; nameIn.style.padding='10px'; nameIn.value = state.me ? state.me.name : '';
  content.appendChild(nameIn);
  const saveBtn = el('button','btn'); saveBtn.textContent = 'Enregistrer profil'; saveBtn.onclick = async ()=> {
    if(!nameIn.value.trim()) return alert('Entrez un nom');
    if(!state.me){ state.me = { uiTfid: uiRandom(), serverTfid: null, name: nameIn.value.trim(), avatarDataUrl: null }; }
    state.me.name = nameIn.value.trim();
    state.me.serverTfid = state.me.serverTfid || uiToServer(state.me.uiTfid);
    saveSession();
    // push profile to server so others can search/discover
    try{ await postSave(state.me.serverTfid, { type:'profile', name: state.me.name, avatar: state.me.avatarDataUrl, created_at: nowISO() }); }catch(e){ console.warn('profile save err', e); }
    alert('Profil mis à jour');
    renderAccueil();
  };
  content.appendChild(saveBtn);
  // show TFID and option to copy
  content.appendChild(el('div','small')).textContent = 'Votre TFID: ' + (state.me ? state.me.uiTfid : '(aucun)');
  const copyBtn = el('button','btn ghost'); copyBtn.textContent = 'Copier TFID'; copyBtn.onclick = ()=> { navigator.clipboard?.writeText(state.me ? state.me.uiTfid : ''); copyBtn.textContent='Copié'; setTimeout(()=>copyBtn.textContent='Copier TFID',1000); };
  content.appendChild(copyBtn);

  p.appendChild(content); container.appendChild(p);
  navigateTo('/parametres', {replace:true});
}

/* Contacts list renderer */
function renderContactsList(filter=''){
  const wrap = document.getElementById('contactsList');
  if(!wrap) return;
  wrap.innerHTML = '';
  // default preset contact Adam_D'H7
  if(!state.contacts.some(c=>c.uiTfid==='TF-7777777')) state.contacts.unshift({ name:"Adam_D'H7", uiTfid:'TF-7777777', serverTfid: uiToServer('TF-7777777') });
  const arr = state.contacts.filter(c => ((c.name||'') + ' ' + (c.uiTfid||'')).toLowerCase().includes((filter||'').toLowerCase()));
  if(arr.length===0){ wrap.appendChild(el('div','small')).textContent='Aucun contact'; return; }
  arr.forEach(c=>{
    const row = el('div','contact'); const av = el('div','avatar'); av.innerHTML = ''; const info = el('div','info'); info.innerHTML = `<div class="name">${c.name}</div><div class="meta">${c.uiTfid}</div>`; row.appendChild(av); row.appendChild(info); row.onclick = ()=> openChatByUi(c.uiTfid); wrap.appendChild(row);
  });
}

/* Add menu (Accueil FAB) */
function openAddMenu(){
  const modal = createPageModal('Ajouter');
  const content = modal.querySelector('.content'); content.innerHTML = '';
  const btnContact = el('button','btn'); btnContact.textContent='Créer un contact'; btnContact.onclick = ()=> { closeModal(modal); renderCreateContact(); };
  const btnClose = el('button','btn ghost'); btnClose.textContent='Annuler'; btnClose.onclick = ()=> closeModal(modal);
  content.appendChild(btnContact); content.appendChild(btnClose);
}

/* Create contact page */
function renderCreateContact(prefill){
  container.innerHTML=''; fab.style.display='none';
  const p = el('div'); p.className='page'; const head=el('div'); head.className='head'; head.innerHTML=`<button class="btn ghost" id="backC">Retour</button><div style="flex:1;text-align:center"><strong>Créer un contact</strong></div>`; head.querySelector('#backC').onclick = ()=> history.back(); p.appendChild(head);
  const content = el('div'); content.className='content';
  const nameIn = el('input'); nameIn.placeholder='Nom (optionnel)'; nameIn.style.width='100%'; nameIn.style.padding='10px';
  const tfIn = el('input'); tfIn.placeholder='TF-7777777 (obligatoire)'; tfIn.style.width='100%'; tfIn.style.padding='10px'; if(prefill) tfIn.value = prefill;
  const addBtn = el('button','btn'); addBtn.textContent='Ajouter'; addBtn.onclick = ()=> {
    const tf = uiNormalize(tfIn.value||''); if(!tf) return alert('TFID obligatoire');
    try{
      const srv = uiToServer(tf);
      const contact = { name: nameIn.value.trim() || tf, uiTfid: tf, serverTfid: srv };
      state.contacts.unshift(contact);
      if(state.me) postSave(state.me.serverTfid, { type:'contact_add', contact, created_at: nowISO() }).catch(()=>{});
      navigateTo('/Accueil'); renderAccueil();
    }catch(e){ alert('TFID invalide'); }
  };
  content.appendChild(nameIn); content.appendChild(tfIn); content.appendChild(addBtn);
  p.appendChild(content); container.appendChild(p); navigateTo('/kreyekontak', {replace:true});
}

/* Chat */
async function openChatByUi(ui){
  const norm = uiNormalize(ui); const srv = uiToServer(norm);
  if(!state.contacts.some(c=>c.serverTfid===srv)) state.contacts.unshift({ name:norm, uiTfid:norm, serverTfid:srv });
  await renderChat(srv, norm);
}

async function renderChat(serverTfid, uiTfid){
  container.innerHTML=''; fab.style.display='none';
  const chatWrap = el('div'); chatWrap.className='chat-page';
  const head = el('div'); head.className='chat-head';
  const contact = state.contacts.find(c=>c.serverTfid===serverTfid) || { name:uiTfid, uiTfid };
  head.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div class="avatar large">${contact.avatarDataUrl?'<img src="'+contact.avatarDataUrl+'">':''}</div><div><strong>${contact.name}</strong><div class="small">${contact.uiTfid}</div></div></div><div style="margin-left:auto"><button class="btn ghost" id="backChat">Retour</button></div>`;
  head.querySelector('#backChat').onclick = ()=> history.back();
  chatWrap.appendChild(head);

  const body = el('div'); body.className='chat-body';
  const msgsWrap = el('div'); msgsWrap.className='messages';
  body.appendChild(msgsWrap); chatWrap.appendChild(body);

  const composer = el('div'); composer.className='composer';
  const attach = el('button','btn ghost'); attach.textContent='📎'; attach.onclick = ()=> alert('Upload fichier via tf-stream (optionnel)');
  const input = el('input'); input.placeholder='Message'; input.autofocus = true;
  const send = el('button','btn'); send.textContent = 'Envoyer'; send.style.background = 'var(--green)';
  composer.appendChild(attach); composer.appendChild(input); composer.appendChild(send);
  chatWrap.appendChild(composer);
  container.appendChild(chatWrap);

  // load messages for this serverTfid
  state.messages[serverTfid] = state.messages[serverTfid] || [];
  try{
    const rows = await listSave(serverTfid);
    for(const r of rows.reverse()){
      let payload;
      try{ payload = JSON.parse(r.content); }catch(e){ payload = { type:'text', text:r.content }; }
      if(payload.type === 'text' || payload.type === 'file'){
        const msg = { _remoteId: r.id, from: payload.from || 'unknown', type: payload.type, text: payload.text || payload.message || null, time: r.created_at || nowISO() };
        if(!state.messages[serverTfid].some(m=>m._remoteId===msg._remoteId)) state.messages[serverTfid].push(msg);
      }
    }
  }catch(e){ console.warn('fetch chat fail', e); }

  function renderMessages(){
    msgsWrap.innerHTML = '';
    const arr = state.messages[serverTfid] || [];
    arr.forEach(m=>{
      const meClass = (state.me && m.from === state.me.serverTfid);
      const b = el('div','bubble ' + (meClass? 'me' : ''));
      if(m.type === 'text'){
        // replace TFIDs inside text with clickable links
        const txt = String(m.text || '');
        const replaced = txt.replace(/TF-(\d{1,7}|\d+)/g, (match) => `<span class="link-tfid" data-ui="${match}">${match}</span>`);
        b.innerHTML = replaced;
        // add click listeners after injection
        setTimeout(()=>{ b.querySelectorAll('.link-tfid').forEach(el=> el.onclick = (e)=> { const ui = el.dataset.ui; if(!ui) return; // open contact
            // if contact exists, open; otherwise open create contact page with prefill
            try{ const srv2 = uiToServer(ui); if(state.contacts.some(c=>c.serverTfid===srv2)) openChatByUi(ui); else renderCreateContact(ui); }catch(err){ console.warn(err); } }); }, 0);
      } else if(m.type === 'file'){
        b.textContent = m.fileMeta && m.fileMeta.filename ? m.fileMeta.filename : 'Fichier';
      }
      const t = el('div','time'); t.textContent = prettyTime(m.time || nowISO()); b.appendChild(t);
      msgsWrap.appendChild(b);
    });
    msgsWrap.scrollTop = msgsWrap.scrollHeight;
  }

  window.__renderChatFor = function(tfid){ if(tfid === serverTfid) renderMessages(); };

  send.onclick = async ()=>{
    const txt = input.value.trim(); if(!txt) return;
    if(!state.me){ alert('Veuillez configurer votre profil dans Paramètres.'); return; }
    const payload = { type:'text', from: state.me.serverTfid, text: txt, time: nowISO() };
    // local optimistic push
    state.messages[serverTfid].push({ _remoteId: null, from: state.me.serverTfid, type:'text', text: txt, time: nowISO() });
    renderMessages(); input.value = '';
    try{
      const resp = await postSave(serverTfid, payload);
      // copy to sender's own TFID timeline
      await postSave(state.me.serverTfid, payload).catch(()=>{});
      if(resp && resp.id){
        const last = state.messages[serverTfid].slice(-1)[0]; if(last) last._remoteId = resp.id;
      }
    }catch(e){ console.warn('send fail', e); alert('Envoi échoué'); }
  };
  input.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); send.click(); } });

  renderMessages();
  navigateTo('/chat/' + encodeURIComponent(uiTfid), {replace:true});
}

/* Simple user page (when clicking TFID) */
function renderUserPage(ui){
  const normalized = uiNormalize(ui);
  const srv = uiToServer(normalized);
  container.innerHTML=''; fab.style.display='none';
  const p = el('div'); p.className='page';
  const head = el('div'); head.className='head'; head.innerHTML = `<button class="btn ghost" id="backU">Retour</button><div style="flex:1;text-align:center"><strong>${normalized}</strong></div>`; head.querySelector('#backU').onclick = ()=> history.back();
  p.appendChild(head);
  const content = el('div'); content.className='content';
  content.appendChild(el('h3')).textContent = normalized;
  const openChat = el('button','btn'); openChat.textContent = 'Ouvrir chat'; openChat.onclick = ()=> openChatByUi(normalized);
  content.appendChild(openChat);
  p.appendChild(content); container.appendChild(p);
  navigateTo('/name/' + encodeURIComponent(normalized), {replace:true});
}

/* Modal helper */
function createPageModal(title){
  const modal = el('div'); modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.36)'; modal.style.display='flex'; modal.style.alignItems='flex-start'; modal.style.justifyContent='center'; modal.style.padding='20px'; modal.style.zIndex='999';
  const page = el('div'); page.className='page'; const head = el('div'); head.className='head'; head.innerHTML = `<button class="btn ghost" id="closeM">Retour</button><div style="flex:1;text-align:center"><strong>${title}</strong></div>`; head.querySelector('#closeM').onclick = ()=> closeModal(modal);
  page.appendChild(head); const content = el('div'); content.className='content'; page.appendChild(content); modal.appendChild(page); document.body.appendChild(modal);
  modal.onclick = (e)=> { if(e.target === modal) closeModal(modal); };
  return modal;
}
function closeModal(m){ if(m && m.parentNode) m.parentNode.removeChild(m); }

/* Small flows */
function renderCreateContact(prefill){
  renderCreateContactInline(prefill);
}
function renderCreateContactInline(prefill){
  container.innerHTML=''; fab.style.display='none';
  const p = el('div'); p.className='page';
  const head = el('div'); head.className='head'; head.innerHTML = `<button class="btn ghost" id="backCC">Retour</button><div style="flex:1;text-align:center"><strong>Créer contact</strong></div>`; head.querySelector('#backCC').onclick = ()=> history.back();
  p.appendChild(head);
  const content = el('div'); content.className='content';
  const nameIn = el('input'); nameIn.placeholder='Nom (optionnel)'; nameIn.style.width='100%'; nameIn.style.padding='10px';
  const tfIn = el('input'); tfIn.placeholder='TF-7777777 (obligatoire)'; tfIn.style.width='100%'; tfIn.style.padding='10px'; if(prefill) tfIn.value = prefill;
  const addBtn = el('button','btn'); addBtn.textContent='Ajouter'; addBtn.onclick = ()=> {
    const tf = uiNormalize(tfIn.value||''); if(!tf) return alert('TFID obligatoire');
    try{
      const srv = uiToServer(tf);
      const contact = { name: nameIn.value.trim() || tf, uiTfid: tf, serverTfid: srv };
      state.contacts.unshift(contact);
      if(state.me) postSave(state.me.serverTfid, { type:'contact_add', contact, created_at: nowISO() }).catch(()=>{});
      navigateTo('/Accueil'); renderAccueil();
    }catch(e){ alert('TFID invalide'); }
  };
  content.appendChild(nameIn); content.appendChild(tfIn); content.appendChild(addBtn);
  p.appendChild(content); container.appendChild(p); navigateTo('/kreyekontak', {replace:true});
}

/* Init: restore session or create visitor */
(function init(){
  // restore
  const s = loadSession();
  if(s){ state.me = s; } else {
    // create visitor TFID and save minimal session (so page reload keeps TFID)
    const ui = uiRandom();
    const srv = uiToServer(ui);
    state.me = { uiTfid: ui, serverTfid: srv, name: ui, avatarDataUrl: null };
    saveSession();
  }
  // ensure Adam preset
  if(!state.contacts.some(c=>c.uiTfid==='TF-7777777')) state.contacts.unshift({ name:"Adam_D'H7", uiTfid:'TF-7777777', serverTfid: uiToServer('TF-7777777') });
  // show avatar in header if present
  if(state.me && state.me.avatarDataUrl) hdrAvatar.innerHTML = `<img src="${state.me.avatarDataUrl}">`; else hdrAvatar.innerHTML = '';
  // start polling after small delay so service wakes
  setTimeout(()=>{ syncAfterLogin(); startPolling(); }, 700);
  route();
})();

async function syncAfterLogin(){
  if(!state.me) return;
  try{
    const rows = await listSave(state.me.serverTfid);
    state.contacts = state.contacts || [];
    state.messages = state.messages || {};
    for(let i = rows.length -1; i >=0; i--){
      const r = rows[i];
      let payload;
      try{ payload = JSON.parse(r.content); }catch(e){ payload = { type:'text', text: r.content }; }
      if(payload.type === 'contact_add' && payload.contact){
        if(!state.contacts.some(c=>c.serverTfid===payload.contact.serverTfid)) state.contacts.unshift(payload.contact);
      } else if(payload.type === 'text' || payload.type === 'file'){
        const tgt = r.tfid;
        state.messages[tgt] = state.messages[tgt] || [];
        state.messages[tgt].push({ _remoteId:r.id, from: payload.from || 'unknown', type: payload.type, text: payload.text || payload.message || null, time: r.created_at || nowISO() });
      }
    }
  }catch(e){ console.warn('sync fail', e); }
}

/* expose for debug */
window.TFCHAT = { state, CONFIG, postSave, listSave, saveSession };
</script>
</body>
  </html>
